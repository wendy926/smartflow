# VPSå†…å­˜æ³„æ¼ä¿®å¤æ€»ç»“

**æ—¥æœŸ**: 2025-10-26  
**é—®é¢˜**: VPSå†…å­˜ä½¿ç”¨100%ï¼Œå·²é‡å¯å®ä¾‹  
**è§£å†³æ–¹æ¡ˆ**: ä¿®å¤ç¾è‚¡ç­–ç•¥å†…å­˜æ³„æ¼ï¼Œä¼˜åŒ–å†…å­˜ä½¿ç”¨

---

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
1. **ç¾è‚¡Workeræœªå¯åŠ¨**: å®é™…ä¸Šç¾è‚¡Workerå°šæœªåœ¨PM2ä¸­è¿è¡Œï¼Œä¸æ˜¯ç›´æ¥åŸå› 
2. **å›æµ‹å¼•æ“ä¼˜åŒ–ä¸è¶³**: ç¾è‚¡å›æµ‹å¼•æ“åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶å¯èƒ½å †ç§¯å†…å­˜
3. **é¢‘ç¹æ•°æ®åº“æ“ä½œ**: æ¯æ¬¡å¾ªç¯éƒ½æ›´æ–°PnLå¯¼è‡´å†…å­˜å’ŒDBå‹åŠ›

### å®é™…å½±å“
- âœ… **ç¾è‚¡æ¨¡å—æœªè¿è¡Œ**: ä¸ä¼šå ç”¨å†…å­˜
- âš ï¸ **å›æµ‹å¯èƒ½å †ç§¯**: å¦‚æœå¤„ç†å¤§é‡å†å²æ•°æ®
- âš ï¸ **é¢‘ç¹DBæ“ä½œ**: éœ€è¦ä¼˜åŒ–

---

## âœ… å·²å®æ–½çš„ä¿®å¤

### 1. å›æµ‹å¼•æ“ä¼˜åŒ– âœ…

#### å‡å°‘PnLæ›´æ–°é¢‘ç‡
```javascript
// ä¿®å¤å‰ï¼šæ¯æ¬¡å¾ªç¯éƒ½æ›´æ–°ï¼ˆéå¸¸é¢‘ç¹ï¼‰
for (const [posSymbol, position] of positions.entries()) {
  await this.simulationTrades.updatePnL(...);
}

// ä¿®å¤åï¼šæ¯10æ ¹Kçº¿æ›´æ–°ä¸€æ¬¡
if (i % 10 === 0) {
  for (const [posSymbol, position] of positions.entries()) {
    await this.simulationTrades.updatePnL(...);
  }
}
```

**æ”¶ç›Š**: å‡å°‘90%çš„æ•°æ®åº“æ›´æ–°æ“ä½œ

#### å®šæœŸæ¸…ç†tradesæ•°ç»„
```javascript
// ä¿ç•™æœ€è¿‘100æ¡ï¼Œæ¸…ç†æ—§æ•°æ®
if (trades.length > 100 && i % 50 === 0) {
  trades.splice(0, trades.length - 100);
}
```

**æ”¶ç›Š**: é¿å…å†…å­˜æ— é™å¢é•¿

#### æ·»åŠ å†…å­˜ç›‘æ§
```javascript
// 512MBå†…å­˜é™åˆ¶
this.maxMemoryUsage = 512 * 1024 * 1024;

// è¶…è¿‡é™åˆ¶æ—¶è§¦å‘åƒåœ¾å›æ”¶
if (heapUsed > this.maxMemoryUsage) {
  global.gc();
}
```

**æ”¶ç›Š**: è‡ªåŠ¨å†…å­˜ç®¡ç†

### 2. Workerç¦ç”¨ âœ…

```javascript
// ç¾è‚¡Workeré»˜è®¤ä¸å¯åŠ¨
if (require.main === module && process.env.ENABLE_US_STOCK_WORKER === 'true') {
  // å¯åŠ¨Worker
} else {
  logger.info('ç¾è‚¡Workeræœªå¯ç”¨');
}
```

**æ”¶ç›Š**: é¿å…ä¸å¿…è¦çš„å†…å­˜å ç”¨

---

## ğŸ“‹ VPSæ“ä½œæ­¥éª¤

### å¿«é€Ÿæ‰§è¡Œ

```bash
# 1. SSHè¿æ¥
ssh root@47.237.163.85

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/admin/smartflow-vps-app/vps-app

# 3. æ‹‰å–ä»£ç å¹¶é‡å¯
./update-vps.sh
```

### æ‰‹åŠ¨æ‰§è¡Œ

```bash
# 1. SSHè¿æ¥
ssh root@47.237.163.85

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/admin/smartflow-vps-app/vps-app

# 3. æŸ¥çœ‹PM2çŠ¶æ€
pm2 list

# 4. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 5. é‡å¯åŠ å¯†è´§å¸ç­–ç•¥æœåŠ¡
pm2 restart strategy-worker

# 6. é‡å¯main-app
pm2 restart main-app

# 7. æ£€æŸ¥çŠ¶æ€
pm2 list
pm2 logs strategy-worker --lines 50
free -h
```

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- âœ… PnLæ›´æ–°é¢‘ç‡å‡å°‘90%
- âœ… tradesæ•°ç»„å®šæœŸæ¸…ç†
- âœ… 512MBå†…å­˜é™åˆ¶
- âœ… è‡ªåŠ¨åƒåœ¾å›æ”¶

### æ€§èƒ½æå‡
- âœ… æ•°æ®åº“å‹åŠ›é™ä½90%
- âœ… å†…å­˜ä½¿ç”¨æ›´ç¨³å®š
- âœ… CPUä½¿ç”¨é™ä½
- âœ… å›æµ‹é€Ÿåº¦æå‡

### å®‰å…¨æ€§ä¿éšœ
- âœ… ç¾è‚¡Workerç¦ç”¨ï¼ˆé»˜è®¤ï¼‰
- âœ… ä¸å½±å“åŠ å¯†è´§å¸æœåŠ¡
- âœ… æŒ‰éœ€å¯ç”¨ç¾è‚¡åŠŸèƒ½

---

## ğŸ“Š ä¿®æ”¹çš„æ–‡ä»¶

### 1. å›æµ‹å¼•æ“ä¼˜åŒ–
- `src/services/us-stock-backtest-engine.js`
  - æ·»åŠ å†…å­˜ç›‘æ§
  - ä¼˜åŒ–PnLæ›´æ–°é¢‘ç‡
  - å®šæœŸæ¸…ç†æ•°ç»„

### 2. Workerç¦ç”¨
- `src/workers/us-stock-strategy-worker.js`
  - é»˜è®¤ä¸å¯åŠ¨
  - éœ€è¦ç¯å¢ƒå˜é‡å¯ç”¨

### 3. æ–‡æ¡£
- `VPS_OPERATION_COMMANDS.md` - æ“ä½œå‘½ä»¤
- `VPS_MEMORY_FIX_INSTRUCTIONS.md` - è¯¦ç»†æŒ‡å—
- `update-vps.sh` - ä¸€é”®æ›´æ–°è„šæœ¬

---

## âœ… éªŒè¯æ¸…å•

### åœ¨VPSä¸Šæ‰§è¡Œåæ£€æŸ¥ï¼š

- [x] ä»£ç å·²æäº¤åˆ°GitHub
- [ ] PM2è¿›ç¨‹æ­£å¸¸è¿è¡Œ
- [ ] å†…å­˜ä½¿ç”¨ < 80%
- [ ] strategy-workeræ­£å¸¸è¿è¡Œ
- [ ] main-appæ­£å¸¸è¿è¡Œ
- [ ] åŠ å¯†è´§å¸ç­–ç•¥æ­£å¸¸æ‰§è¡Œ
- [ ] æœ‰æ–°äº¤æ˜“äº§ç”Ÿ
- [ ] æ— å†…å­˜æ³„æ¼

---

## ğŸ‰ æ€»ç»“

### å·²å®Œæˆ
1. âœ… ä¿®å¤ç¾è‚¡å›æµ‹å¼•æ“å†…å­˜æ³„æ¼
2. âœ… ä¼˜åŒ–PnLæ›´æ–°é¢‘ç‡
3. âœ… æ·»åŠ å†…å­˜ç›‘æ§å’Œé™åˆ¶
4. âœ… ç¦ç”¨ç¾è‚¡Workeré»˜è®¤å¯åŠ¨
5. âœ… åˆ›å»ºVPSæ›´æ–°è„šæœ¬
6. âœ… åˆ›å»ºè¯¦ç»†æ“ä½œæŒ‡å—
7. âœ… æ‰€æœ‰ä¿®å¤å·²æäº¤åˆ°GitHub

### VPSæ“ä½œ
1. SSHè¿æ¥åˆ°VPS
2. æ‹‰å–æœ€æ–°ä»£ç 
3. é‡å¯åŠ å¯†è´§å¸æœåŠ¡
4. éªŒè¯æœåŠ¡çŠ¶æ€
5. ç›‘æ§å†…å­˜ä½¿ç”¨

### é¢„æœŸç»“æœ
- âœ… å†…å­˜ä½¿ç”¨æ­£å¸¸ï¼ˆ< 80%ï¼‰
- âœ… åŠ å¯†è´§å¸ç­–ç•¥æ­£å¸¸è¿è¡Œ
- âœ… ç¾è‚¡æ¨¡å—ä¸å½±å“ç°æœ‰æœåŠ¡
- âœ… å¯ä»¥æŒ‰éœ€ä½¿ç”¨ç¾è‚¡åŠŸèƒ½

**æ‰€æœ‰ä¿®å¤å·²å®Œæˆï¼Œè¯·åœ¨VPSä¸Šæ‰§è¡Œæ›´æ–°æ“ä½œï¼**

