# V3.1-Plus ä¼˜åŒ–æ–¹æ¡ˆ - æ— æ–°è¡¨è®¾è®¡

**è®¾è®¡åŸåˆ™**: å¤ç”¨ç°æœ‰è¡¨ç»“æ„ï¼Œé¿å…å†—ä½™  
**åˆ†ææ—¶é—´**: 2025-10-12  

---

## ğŸ“Š ç°æœ‰è¡¨ç»“æ„åˆ†æ

### 1. simulation_tradesï¼ˆæ ¸å¿ƒäº¤æ˜“è¡¨ï¼‰
**å·²æœ‰å­—æ®µ**ï¼ˆV3.1ç›¸å…³ï¼‰:
- `early_trend_detected` âœ…
- `fake_breakout_filter_passed` âœ…
- `confidence_level` âœ…
- `initial_atr_multiplier` âœ…
- `current_atr_multiplier` âœ…
- `stop_loss_type` âœ…
- `trailing_activated` âœ…
- `entry_time`, `exit_time`, `pnl`, `status` âœ…

**ç»“è®º**: è¿™ä¸ªè¡¨å·²ç»æœ‰V3.1çš„æ‰€æœ‰æ ¸å¿ƒå­—æ®µï¼Œåªéœ€è¦æ·»åŠ å°‘é‡V3.1-Pluså­—æ®µå³å¯ï¼

### 2. strategy_execution_logsï¼ˆä¿¡å·æ—¥å¿—è¡¨ï¼‰
**ç”¨é€”**: è®°å½•æ¯æ¬¡ç­–ç•¥æ‰§è¡Œçš„è¯¦ç»†æ—¥å¿—  
**å¯ç”¨äº**: å­˜å‚¨å…¥åœºç¡®è®¤è¯¦æƒ…ã€Pullbackæ£€æµ‹ç»“æœ  
**ç»“è®º**: å¯å¤ç”¨ï¼Œä¸éœ€è¦æ–°å»ºv3_1_signal_logs

### 3. strategy_paramsï¼ˆå‚æ•°è¡¨ï¼‰
**ç”¨é€”**: å­˜å‚¨ç­–ç•¥å‚æ•°é…ç½®  
**å¯ç”¨äº**: å­˜å‚¨V3.1-Plusæ‰€æœ‰å‚æ•°  
**ç»“è®º**: å¯å¤ç”¨

### 4. strategy_performance_summaryï¼ˆæ€§èƒ½ç»Ÿè®¡è¡¨ï¼‰
**ç”¨é€”**: å­˜å‚¨ç­–ç•¥æ€§èƒ½æ±‡æ€»  
**å¯ç”¨äº**: èƒœç‡è·Ÿè¸ªã€æ€§èƒ½ç›‘æ§  
**ç»“è®º**: å¯å¤ç”¨

---

## ğŸ¯ V3.1-Plus éœ€æ±‚æ˜ å°„

### éœ€æ±‚1: äº¤æ˜“å†·å´ç®¡ç†
**åŸè®¾è®¡**: æ–°å»ºv3_trade_cooldownè¡¨  
**ä¼˜åŒ–æ–¹æ¡ˆ**: 
- âœ… ä½¿ç”¨**å†…å­˜ç¼“å­˜**ï¼ˆMapå¯¹è±¡ï¼‰å­˜å‚¨å†·å´çŠ¶æ€
- âœ… æŸ¥è¯¢simulation_tradesçš„æœ€åentry_time
- âœ… é‡å¯åä»æ•°æ®åº“æ¢å¤çŠ¶æ€

**ä¼˜åŠ¿**:
- æ— éœ€æ–°è¡¨
- æŸ¥è¯¢æ›´å¿«ï¼ˆå†…å­˜ï¼‰
- å‡å°‘æ•°æ®åº“å†™å…¥

### éœ€æ±‚2: äº¤æ˜“å†å²ï¼ˆèƒœç‡è·Ÿè¸ªï¼‰
**åŸè®¾è®¡**: æ–°å»ºv3_trade_historyè¡¨  
**ä¼˜åŒ–æ–¹æ¡ˆ**:
- âœ… ç›´æ¥æŸ¥è¯¢simulation_tradesè¡¨
- âœ… æŒ‰symbol + strategy_name + status='CLOSED'ç­›é€‰
- âœ… è®¡ç®—æœ€è¿‘Nç¬”çš„èƒœç‡

**SQLç¤ºä¾‹**:
```sql
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN pnl > 0 THEN 1 ELSE 0 END) as wins
FROM (
    SELECT pnl
    FROM simulation_trades
    WHERE symbol_id = ? 
      AND strategy_name = 'V3'
      AND status = 'CLOSED'
    ORDER BY exit_time DESC
    LIMIT 12
) recent;
```

**ä¼˜åŠ¿**:
- æ— éœ€æ–°è¡¨
- æ— éœ€æ•°æ®åŒæ­¥
- æ•°æ®ä¸€è‡´æ€§100%

### éœ€æ±‚3: åˆ†æ‰¹å»ºä»“è®¢å•
**åŸè®¾è®¡**: æ–°å»ºv3_staged_ordersè¡¨  
**ä¼˜åŒ–æ–¹æ¡ˆ**:
- âœ… åœ¨simulation_tradesæ·»åŠ JSONå­—æ®µ `staged_orders`
- âœ… å­˜å‚¨åˆ†æ‰¹è¯¦æƒ…ï¼š`{stage1: {size, price, time}, stage2: {...}}`
- âœ… æ·»åŠ å­—æ®µ `staged_entry`, `stage_count`

**JSONç¤ºä¾‹**:
```json
{
  "stages": [
    {"stage": 1, "size": 0.5, "price": 62000, "time": "2025-10-12T10:00:00Z", "status": "FILLED"},
    {"stage": 2, "size": 0.5, "price": 62100, "time": "2025-10-12T10:15:00Z", "status": "FILLED"}
  ],
  "breakeven_moved": true,
  "breakeven_price": 62050
}
```

**ä¼˜åŠ¿**:
- æ— éœ€æ–°è¡¨
- é¿å…ä¸€å¯¹å¤šå…³ç³»å¤æ‚æ€§
- æŸ¥è¯¢æ›´ç®€å•

### éœ€æ±‚4: å…¥åœºç¡®è®¤è¯¦æƒ…
**åŸè®¾è®¡**: å­˜å‚¨åœ¨æ–°è¡¨  
**ä¼˜åŒ–æ–¹æ¡ˆ**:
- âœ… åœ¨simulation_tradesæ·»åŠ JSONå­—æ®µ `entry_confirmation`
- âœ… å­˜å‚¨ï¼š`{volOk, deltaOk, earlyOk, smartOk, confirmCount, entryMode}`

**JSONç¤ºä¾‹**:
```json
{
  "volOk": true,
  "deltaOk": true,
  "earlyOk": true,
  "smartOk": false,
  "confirmCount": 3,
  "entryMode": "breakout",
  "pullbackDetected": false,
  "smartMoneyScore": 0.45
}
```

---

## ğŸ“ æœ€ç»ˆæ•°æ®åº“ä¿®æ”¹æ–¹æ¡ˆ

### ä»…éœ€æ‰©å±•simulation_tradesè¡¨

```sql
-- V3.1-Plus æ‰©å±•å­—æ®µï¼ˆæœ€å°åŒ–ä¿®æ”¹ï¼‰
ALTER TABLE simulation_trades
ADD COLUMN entry_mode VARCHAR(20) DEFAULT NULL COMMENT 'å…¥åœºæ¨¡å¼: breakout/pullback/momentum',
ADD COLUMN entry_confirmation JSON DEFAULT NULL COMMENT 'å…¥åœºç¡®è®¤è¯¦æƒ…',
ADD COLUMN staged_entry BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦åˆ†æ‰¹å…¥åœº',
ADD COLUMN staged_orders JSON DEFAULT NULL COMMENT 'åˆ†æ‰¹è®¢å•è¯¦æƒ…',
ADD COLUMN recent_winrate DECIMAL(5,2) DEFAULT NULL COMMENT 'å…¥åœºæ—¶æœ€è¿‘èƒœç‡',
ADD COLUMN winrate_throttle_active BOOLEAN DEFAULT FALSE COMMENT 'èƒœç‡ä¿æŠ¤æ˜¯å¦æ¿€æ´»',
ADD COLUMN cooldown_bypassed BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç»•è¿‡å†·å´ï¼ˆå¼ºåˆ¶å…¥åœºï¼‰';
```

### å‚æ•°é…ç½®ï¼ˆå¤ç”¨strategy_paramsï¼‰

```sql
-- æ–¹æ¡ˆ1: ä½¿ç”¨ç°æœ‰param_nameæ ¼å¼
INSERT INTO strategy_params (param_name, param_value, param_type, category, description) VALUES
-- V3.1-Pluså‚æ•°ï¼ˆcategoryå›ºå®šä¸º'V3'ï¼‰
('v3_confirmation_wait', '1', 'number', 'V3', 'çªç ´ç¡®è®¤ç­‰å¾…(15Mæ ¹æ•°)'),
('v3_vol_factor', '1.2', 'number', 'V3', 'æˆäº¤é‡ç¡®è®¤å€æ•°'),
('v3_delta_threshold', '0.04', 'number', 'V3', 'Deltaé˜ˆå€¼'),
('v3_pullback_first_leg_ratio', '0.5', 'number', 'V3', 'Pullbacké¦–ä»“æ¯”ä¾‹'),
('v3_k_entry_high', '1.4', 'number', 'V3', 'Highç½®ä¿¡åº¦æ­¢æŸATRå€æ•°'),
('v3_k_entry_med', '2.0', 'number', 'V3', 'Medç½®ä¿¡åº¦æ­¢æŸATRå€æ•°'),
('v3_k_entry_low', '3.0', 'number', 'V3', 'Lowç½®ä¿¡åº¦æ­¢æŸATRå€æ•°'),
('v3_breakout_multiplier', '1.25', 'number', 'V3', 'çªç ´æ¨¡å¼æ­¢æŸå€æ•°'),
('v3_pullback_multiplier', '0.9', 'number', 'V3', 'å›æ’¤æ¨¡å¼æ­¢æŸå€æ•°'),
('v3_trail_step', '0.4', 'number', 'V3', 'è¿½è¸ªæ­¢ç›ˆæ­¥é•¿(ATRå€æ•°)'),
('v3_tp_factor', '2.0', 'number', 'V3', 'æ­¢ç›ˆå€æ•°å› å­'),
('v3_cooldown_minutes', '45', 'number', 'V3', 'å†·å´æ—¶é—´(åˆ†é’Ÿ)'),
('v3_max_daily_trades', '6', 'number', 'V3', 'æ¯æ—¥æœ€å¤§äº¤æ˜“æ¬¡æ•°'),
('v3_recent_window', '12', 'number', 'V3', 'èƒœç‡è·Ÿè¸ªçª—å£(ç¬”æ•°)'),
('v3_winrate_threshold', '0.30', 'number', 'V3', 'èƒœç‡ä¿æŠ¤é˜ˆå€¼'),
('v3_time_stop_base', '60', 'number', 'V3', 'æ—¶é—´æ­¢æŸåŸºå‡†(åˆ†é’Ÿ)')
ON DUPLICATE KEY UPDATE param_value = VALUES(param_value);
```

---

## ğŸ’¾ å†…å­˜ç¼“å­˜è®¾è®¡

### CooldownCacheç±»

```javascript
class CooldownCache {
  constructor() {
    this.cache = new Map(); // symbol -> {lastEntry, dailyCount, lastResetDate}
  }
  
  // ä»æ•°æ®åº“æ¢å¤çŠ¶æ€
  async restore(database) {
    const result = await database.pool.query(`
      SELECT symbol_id, MAX(entry_time) as last_entry, 
             COUNT(*) as daily_count
      FROM simulation_trades
      WHERE strategy_name = 'V3'
        AND DATE(entry_time) = CURDATE()
      GROUP BY symbol_id
    `);
    
    for (const row of result[0]) {
      this.cache.set(row.symbol_id, {
        lastEntry: new Date(row.last_entry).getTime(),
        dailyCount: row.daily_count,
        lastResetDate: new Date().toDateString()
      });
    }
  }
  
  // æ£€æŸ¥æ˜¯å¦å¯ä»¥å…¥åœº
  canEnter(symbol, cooldownMinutes, maxDaily) {
    const info = this.cache.get(symbol);
    if (!info) return {allowed: true, reason: 'first_entry'};
    
    // æ£€æŸ¥æ—¥æœŸé‡ç½®
    const today = new Date().toDateString();
    if (info.lastResetDate !== today) {
      info.dailyCount = 0;
      info.lastResetDate = today;
    }
    
    // æ£€æŸ¥å†·å´æ—¶é—´
    const minutesSince = (Date.now() - info.lastEntry) / 1000 / 60;
    if (minutesSince < cooldownMinutes) {
      return {allowed: false, reason: 'cooldown_active', minutesRemaining: cooldownMinutes - minutesSince};
    }
    
    // æ£€æŸ¥æ¯æ—¥é™åˆ¶
    if (info.dailyCount >= maxDaily) {
      return {allowed: false, reason: 'daily_limit_reached', dailyCount: info.dailyCount};
    }
    
    return {allowed: true, reason: 'ok'};
  }
  
  // æ›´æ–°å…¥åœºè®°å½•
  updateEntry(symbol) {
    const info = this.cache.get(symbol) || {dailyCount: 0, lastResetDate: new Date().toDateString()};
    const today = new Date().toDateString();
    
    if (info.lastResetDate !== today) {
      info.dailyCount = 1;
      info.lastResetDate = today;
    } else {
      info.dailyCount++;
    }
    
    info.lastEntry = Date.now();
    this.cache.set(symbol, info);
  }
}
```

---

## ğŸ“Š æ•°æ®æŸ¥è¯¢å°è£…

### WinRateTrackerç±»

```javascript
class WinRateTracker {
  constructor(database) {
    this.database = database;
  }
  
  async getRecentWinRate(symbolId, window = 12) {
    const [rows] = await this.database.pool.query(`
      SELECT 
        COUNT(*) as total,
        SUM(CASE WHEN pnl > 0 THEN 1 ELSE 0 END) as wins,
        AVG(pnl) as avg_pnl
      FROM (
        SELECT pnl
        FROM simulation_trades
        WHERE symbol_id = ?
          AND strategy_name = 'V3'
          AND status = 'CLOSED'
        ORDER BY exit_time DESC
        LIMIT ?
      ) recent
    `, [symbolId, window]);
    
    const row = rows[0];
    return {
      total: row.total,
      wins: row.wins,
      winRate: row.total > 0 ? (row.wins / row.total) : null,
      avgPnl: row.avg_pnl
    };
  }
  
  async shouldThrottle(symbolId, threshold = 0.30, window = 12) {
    const stats = await this.getRecentWinRate(symbolId, window);
    if (stats.total < window) return {throttle: false, reason: 'insufficient_data'};
    if (stats.winRate < threshold) {
      return {
        throttle: true,
        reason: 'low_winrate',
        winRate: stats.winRate,
        adjustments: {
          scoreBonus: -10,
          sizeMultiplier: 0.5
        }
      };
    }
    return {throttle: false, reason: 'ok', winRate: stats.winRate};
  }
}
```

---

## âœ… ä¼˜åŠ¿æ€»ç»“

### å¯¹æ¯”åŸæ–¹æ¡ˆ

| é¡¹ç›® | åŸæ–¹æ¡ˆï¼ˆæ–°å»º3è¡¨ï¼‰ | ä¼˜åŒ–æ–¹æ¡ˆï¼ˆæ— æ–°è¡¨ï¼‰ | ä¼˜åŠ¿ |
|------|------------------|-------------------|------|
| **è¡¨æ•°é‡** | +3ä¸ªæ–°è¡¨ | 0ä¸ªæ–°è¡¨ | ç®€åŒ–ç»´æŠ¤ |
| **å­—æ®µæ•°é‡** | simulation_trades +8 | simulation_trades +7 | å‡ ä¹ç›¸åŒ |
| **æŸ¥è¯¢å¤æ‚åº¦** | JOINæŸ¥è¯¢ | å•è¡¨æŸ¥è¯¢ | æ›´å¿« |
| **æ•°æ®ä¸€è‡´æ€§** | éœ€è¦åŒæ­¥ | å¤©ç„¶ä¸€è‡´ | æ›´å¯é  |
| **å­˜å‚¨ç©ºé—´** | å¤šè¡¨ç´¢å¼• | å°‘é‡JSON | æ›´èŠ‚çœ |
| **å¼€å‘å¤æ‚åº¦** | é«˜ï¼ˆå¤šè¡¨å…³ç³»ï¼‰ | ä½ï¼ˆå•è¡¨+ç¼“å­˜ï¼‰ | æ›´ç®€å• |
| **æ€§èƒ½** | JOINå¼€é”€ | ç¼“å­˜+å•è¡¨ | æ›´ä¼˜ |

### å…³é”®ä¼˜åŠ¿

1. **âœ… é›¶å†—ä½™**: å®Œå…¨å¤ç”¨ç°æœ‰è¡¨ç»“æ„
2. **âœ… é«˜æ€§èƒ½**: å†…å­˜ç¼“å­˜ + å•è¡¨æŸ¥è¯¢
3. **âœ… æ˜“ç»´æŠ¤**: æ— éœ€ç®¡ç†å¤šè¡¨å…³ç³»
4. **âœ… æ•°æ®ä¸€è‡´**: å•ä¸€æ•°æ®æº
5. **âœ… å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰åŠŸèƒ½
6. **âœ… å¿«é€Ÿéƒ¨ç½²**: ä»…éœ€ALTERä¸€å¼ è¡¨

---

## ğŸ“‹ å®æ–½æ£€æŸ¥æ¸…å•

### Phase 1: æ•°æ®åº“æ‰©å±•ï¼ˆ5åˆ†é’Ÿï¼‰
- [ ] æ‰§è¡ŒALTER TABLEæ·»åŠ 7ä¸ªå­—æ®µ
- [ ] æ’å…¥V3.1-Pluså‚æ•°åˆ°strategy_params
- [ ] éªŒè¯å­—æ®µæ·»åŠ æˆåŠŸ

### Phase 2: ä»£ç å®ç°ï¼ˆ2å°æ—¶ï¼‰
- [ ] å®ç°CooldownCacheç±»
- [ ] å®ç°WinRateTrackerç±»  
- [ ] å®ç°EntryConfirmationManager
- [ ] å®ç°PullbackDetector
- [ ] å®ç°StagedEntryManager
- [ ] å®ç°DynamicStopLossPlus

### Phase 3: é›†æˆæµ‹è¯•ï¼ˆ30åˆ†é’Ÿï¼‰
- [ ] å•å…ƒæµ‹è¯•å„æ¨¡å—
- [ ] é›†æˆæµ‹è¯•å®Œæ•´æµç¨‹
- [ ] æ€§èƒ½æµ‹è¯•

### Phase 4: VPSéƒ¨ç½²ï¼ˆ20åˆ†é’Ÿï¼‰
- [ ] æ‰§è¡Œæ•°æ®åº“è¿ç§»
- [ ] éƒ¨ç½²ä»£ç 
- [ ] éªŒè¯åŠŸèƒ½
- [ ] ç›‘æ§æ€§èƒ½

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… åˆ›å»ºæœ€å°åŒ–ALTER TABLEè„šæœ¬
2. â³ å®ç°æ ¸å¿ƒæ¨¡å—ï¼ˆCooldownCache, WinRateTrackerï¼‰
3. â³ é›†æˆåˆ°V3ç­–ç•¥
4. â³ æµ‹è¯•å’Œéƒ¨ç½²

**æ€»å·¥æœŸ**: çº¦3å°æ—¶ï¼ˆå‡å°‘50%ï¼‰  
**é£é™©ç­‰çº§**: ä½ï¼ˆæ— æ–°è¡¨ï¼Œæ”¹åŠ¨æœ€å°ï¼‰  
**å›æ»šæ–¹æ¡ˆ**: ç®€å•ï¼ˆåˆ é™¤æ–°å¢å­—æ®µå³å¯ï¼‰

---

**è®¾è®¡ä¼˜åŠ¿**: ğŸ† æœ€å°åŒ–æ”¹åŠ¨ï¼Œæœ€å¤§åŒ–å¤ç”¨ï¼Œé›¶å†—ä½™ï¼

