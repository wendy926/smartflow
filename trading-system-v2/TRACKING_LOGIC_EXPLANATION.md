# 大额挂单追踪逻辑详解

**页面**: https://smart.aimaventop.com/large-orders  
**问题**: 展示的是新增挂单还是累计挂单？  
**答案**: **展示当前存在的大额挂单（实时追踪）** ✅  

---

## 🔍 追踪逻辑详解

### 核心机制：实时追踪 + 生命周期管理

```
WebSocket depth流（100ms更新）
         ↓
  检测大额挂单（>1M USD）
         ↓
  【追踪Map】维护挂单生命周期
         ↓
    - 新挂单 → 创建记录（createdAt）
    - 仍存在 → 更新时间（lastSeenAt, seenCount++）
    - 消失了 → 标记撤销（canceledAt）
         ↓
  定期清理（已撤销>1小时）
         ↓
  API返回【当前存在】的挂单
```

---

## 📊 追踪Map数据结构

### Map存储格式

**Key**: `side@price` (例如: `bid@109000`)

**Value**:
```javascript
{
  symbol: 'BTCUSDT',
  side: 'bid',                 // 或 'ask'
  price: 109000,
  qty: 119.27,
  valueUSD: 13000000,
  createdAt: 1760314141814,    // 首次发现时间
  lastSeenAt: 1760314149914,   // 最后发现时间
  canceledAt: null,            // 撤销时间（null=仍存在）
  seenCount: 5,                // 连续发现次数
  filledVolumeObserved: 0,     // 观察到的成交量
  impactRatio: 4.12,           // 影响力比率
  classification: 'DEFENSIVE_BUY',
  isPersistent: true,          // 是否持续（>=3次）
  isSpoof: false,              // 是否诱导单
  wasConsumed: false           // 是否被吃掉
}
```

---

## 🔄 挂单生命周期

### 阶段1: 创建（NEW）

**触发条件**:
```
depth中出现新的大额挂单（>1M USD）
且之前Map中没有此价位的记录
```

**操作**:
```javascript
tracked.set('bid@109000', {
  createdAt: now,
  lastSeenAt: now,
  seenCount: 1,
  canceledAt: null,  // 未撤销
  ...
});
```

**前端展示**: ✅ 立即显示为新追踪挂单

---

### 阶段2: 持续（PERSIST）

**触发条件**:
```
depth中继续存在该价位的挂单
```

**操作**:
```javascript
entry.lastSeenAt = now;      // 更新最后发现时间
entry.seenCount++;           // 连续发现次数+1
entry.qty = newQty;          // 更新数量（可能变化）
entry.isPersistent = seenCount >= 3;  // >=3次标记为持续
```

**前端展示**: 
- ✅ 继续显示
- ✅ 持续时间增加
- ✅ seenCount>=3显示● 绿点

---

### 阶段3: 撤销（CANCELED）

**触发条件**:
```
depth中不再存在该价位的挂单
```

**操作**:
```javascript
entry.canceledAt = now;  // 标记撤销时间

// 如果撤销时间 - 创建时间 < 3秒 → 诱导单
if ((canceledAt - createdAt) < 3000) {
  entry.isSpoof = true;
}
```

**前端展示**: 
- ⚠️ 仍显示（1小时内）
- ⚠️ 标记为"已撤销"
- ⚠️ 如果<3s → 显示为Spoof

---

### 阶段4: 清理（CLEANUP）

**触发条件**:
```
已撤销 且 距离撤销时间>1小时
```

**操作**:
```javascript
tracked.delete('bid@109000');  // 从Map中删除
```

**前端展示**: ❌ 不再显示

---

## 🎯 当前展示逻辑

### API返回什么数据？

**调用**: `GET /api/v1/large-orders/detect?symbols=BTCUSDT`

**返回**:
```javascript
{
  symbol: 'BTCUSDT',
  trackedEntriesCount: 9,
  trackedEntries: [
    // 返回Map中所有记录（包括已撤销但<1小时的）
    {
      side: 'bid',
      price: 109000,
      canceledAt: null,        // 仍存在 ✅
      isPersistent: true,
      ...
    },
    {
      side: 'ask',
      price: 125000,
      canceledAt: 1760314000000,  // 已撤销 ⚠️
      isSpoof: true,              // 诱导单
      ...
    }
  ]
}
```

**重点**: 
- ✅ 返回**当前存在**的挂单（canceledAt=null）
- ✅ 也返回**最近撤销**的挂单（<1小时，用于Spoof分析）
- ❌ 不返回**1小时前撤销**的挂单

---

## 📋 展示类型对比

| 类型 | 含义 | 当前实现 | 适用场景 |
|------|------|---------|---------|
| **实时快照** | 仅显示此刻存在的挂单 | ❌ | 盘口分析 |
| **实时追踪** | 显示当前+最近撤销(<1h) | ✅ | 聪明钱分析 |
| **历史累计** | 显示所有历史挂单 | ❌ | 数据分析 |

**当前实现**: **实时追踪模式** ✅

---

## 🕐 时间窗口说明

### 追踪窗口

```
当前时刻
   ↓
  [------ 1小时追踪窗口 ------]
   ↓
仍存在的挂单 ✅ 显示
最近撤销的(<1h) ✅ 显示（标记为Spoof分析用）
1小时前撤销的 ❌ 不显示（已清理）
```

### 为什么保留1小时内撤销的挂单？

**原因**:
1. **Spoof检测**: 需要观察短期内的闪现-撤销模式
2. **成交验证**: 观察挂单是否被吃掉
3. **行为分析**: 识别诱多/诱空陷阱

**示例**:
```
挂单A: 创建于08:00:00，撤销于08:00:02（<3s）
→ 标记为Spoof
→ 在08:00:02 - 09:00:02之间仍会显示（标记为⚠️诱导单）
→ 09:00:02后清理，不再显示
```

---

## 📊 前端展示逻辑

### trackedEntriesCount含义

**计算**:
```javascript
trackedEntriesCount = tracker.getTrackedEntries(symbol).length
```

**包含**:
- ✅ 当前存在的挂单（canceledAt=null）
- ✅ 最近撤销的挂单（canceledAt有值 且 <1小时）

**不包含**:
- ❌ 1小时前撤销的挂单

### 前端表格过滤

**当前实现**（可优化）:
```javascript
// 显示所有追踪挂单
tbody.innerHTML = trackedEntries.map(entry => {
  // 不区分是否撤销，全部显示
  ...
}).join('');
```

**建议优化**:
```javascript
// 分两个tab显示
Tab1: 当前存在（canceledAt=null）
Tab2: 最近撤销（canceledAt!=null && <1h）

或用颜色区分：
- 存在的：正常颜色
- 已撤销的：灰色半透明
- Spoof的：橙色警告
```

---

## 🎯 实战示例

### 场景1: 正常大额挂单

```
时间线：
08:00:00 - bid@109000 出现（13M USD）✅ 新增
08:00:15 - bid@109000 仍存在 ✅ 更新（seenCount=2）
08:00:30 - bid@109000 仍存在 ✅ 更新（seenCount=3, isPersistent=true）
08:01:00 - bid@109000 仍存在 ✅ 更新（持续60s）

前端显示：
● bid@109000, 13M USD, 影响力18%, 持续60s, DEFENSIVE_BUY
```

### 场景2: 诱导挂单（Spoof）

```
时间线：
08:00:00 - bid@109000 出现（13M USD）✅ 新增
08:00:02 - bid@109000 消失 ⚠️ 撤销（仅2秒，<3秒阈值）
         → 标记为isSpoof=true

前端显示（08:00:02 - 09:00:02）：
⚠️ bid@109000, 13M USD, 影响力18%, ○2s, SPOOF（诱导单）

前端显示（09:00:02之后）：
（已清理，不再显示）
```

### 场景3: 挂单被吃掉

```
时间线：
08:00:00 - ask@116000 出现（12M USD）✅ 新增
08:00:15 - ask@116000 仍存在 ✅ 更新
08:00:30 - aggTrade显示大量买入成交@116000 ⚠️ 被吃
         → filledVolumeObserved增加
         → wasConsumed=true
08:00:35 - ask@116000 消失 ✅ 正常（被成交完）

前端显示：
🔥 ask@116000, 12M USD, 影响力16%, 35s, SWEEP_SELL（被吃）
```

---

## 📊 数据统计说明

### trackedEntriesCount统计

**BTCUSDT: 9个**

**组成**:
```
当前存在：7个
  - bid@109000 (13M) ● 持续中
  - ask@116000 (12M) ● 持续中
  - bid@98000 (10M) ● 持续中
  - ask@118000 (6M) ● 持续中
  - ask@117000 (5M) ● 持续中
  - ask@116500 (4M) ● 持续中
  - bid@107000 (5.5M) ● 持续中

最近撤销（<1h）：2个
  - bid@110000 (8M) ○ 2s前撤销 → Spoof
  - ask@115000 (7M) 🔥 30s前被吃 → SWEEP

总计：9个追踪挂单
```

**ETHUSDT: 0个**

**原因**:
```
当前存在：0个（无>1M USD挂单）
最近撤销：0个

总计：0个追踪挂单
```

---

## 🔄 实时更新逻辑

### WebSocket更新流程

```
每100ms:
  ↓
收到depth更新
  ↓
检查每个大额挂单（>1M）
  ↓
如果仍在订单簿：
  ✅ lastSeenAt = now
  ✅ seenCount++
  ✅ 更新qty（可能变化）
  ↓
如果不在订单簿：
  ⚠️ canceledAt = now
  ⚠️ 判断是否Spoof（<3s）
  ↓
每15秒保存到数据库
  ↓
前端刷新时获取最新数据
```

### 清理逻辑

```
每次depth更新时：
  ↓
遍历所有追踪挂单
  ↓
如果 (canceledAt != null && now - canceledAt > 1小时):
  ❌ 从Map删除
  ❌ 不再追踪
  ↓
如果 Map.size > 100:
  ❌ 删除最旧的记录
  ↓
保留最近的、活跃的挂单
```

---

## 🎯 前端展示的是什么？

### 明确答案

**前端显示**: **当前正在追踪的大额挂单**

**包括**:
1. ✅ **当前存在的挂单**（canceledAt=null）
   - 仍在订单簿中
   - 实时更新数量和时间
   - 显示● 绿点

2. ✅ **最近撤销的挂单**（canceledAt!=null && <1小时）
   - 已不在订单簿
   - 用于Spoof分析
   - 显示○ 灰点或⚠️警告

**不包括**:
- ❌ 1小时前撤销的挂单
- ❌ 从未达到阈值的小额挂单
- ❌ 被清理的历史记录

---

## 📈 实例说明

### 当前页面显示（假设）

**BTCUSDT - 9个追踪挂单**:

| # | 方向 | 价格 | 价值 | 状态 | 持续 | 说明 |
|---|------|------|------|------|------|------|
| 1 | BUY | 109K | 13M | ● 持续中 | 45s | **当前存在** ✅ |
| 2 | SELL | 116K | 12M | ● 持续中 | 38s | **当前存在** ✅ |
| 3 | BUY | 98K | 10M | ● 持续中 | 120s | **当前存在** ✅ |
| 4 | SELL | 118K | 6M | ● 持续中 | 65s | **当前存在** ✅ |
| 5 | BUY | 107K | 5.5M | ● 持续中 | 28s | **当前存在** ✅ |
| 6 | SELL | 117K | 5M | ● 持续中 | 52s | **当前存在** ✅ |
| 7 | SELL | 116.5K | 4M | ● 持续中 | 88s | **当前存在** ✅ |
| 8 | BUY | 110K | 8M | ○ 已撤销 | 2s | **最近撤销** ⚠️ Spoof |
| 9 | SELL | 115K | 7M | 🔥 被吃掉 | 30s | **最近撤销** ✅ 成交 |

**说明**:
- 前7个：**当前仍在订单簿**（实时追踪）
- 第8个：**2s前撤单** → Spoof诱导单
- 第9个：**30s前被吃** → 真实成交

---

## 🔍 为什么不展示所有历史累计？

### 原因1: 数据量爆炸

```
累计模式（假设）：
- 1天内可能出现1000+个大额挂单
- Map.size快速膨胀
- 内存占用>100MB
- 前端渲染卡顿
```

### 原因2: 信息噪音

```
历史挂单意义不大：
- 1小时前的挂单已无参考价值
- 市场瞬息万变
- 用户只关心"当前"的大资金意图
```

### 原因3: 性能优化

```
1小时清理机制：
- 保持Map.size在合理范围
- 避免内存泄漏
- 提高查询速度
```

---

## 💡 优化建议

### 建议1: 前端分类显示

**Tab1: 活跃挂单（canceledAt=null）**
```
显示当前仍在订单簿的挂单
更新频率：实时
用途：判断当前支撑/阻力
```

**Tab2: 最近事件（canceledAt!=null && <1h）**
```
显示最近撤销/成交的挂单
用途：Spoof分析、行为追踪
```

### 建议2: 添加历史查询

**新API**: `/api/v1/large-orders/history?symbol=BTCUSDT&timeRange=24h`

**返回**: 过去24小时所有检测记录（从数据库）

**用途**: 
- 回测分析
- 行为模式识别
- 历史告警查询

### 建议3: 实时vs历史切换

**前端添加开关**:
```
[ 实时追踪 ] [ 历史记录 ]

实时追踪：显示Map中的当前数据
历史记录：查询数据库，显示过去N小时
```

---

## ✅ 总结

### 当前实现

**展示逻辑**: ✅ **实时追踪模式**

**包含**:
- ✅ 当前存在的大额挂单
- ✅ 最近1小时撤销/成交的挂单
- ✅ 实时更新持续时间和状态

**不包含**:
- ❌ 1小时前的历史记录
- ❌ 所有累计挂单

**优点**:
- ✅ 数据新鲜，反映当前市场
- ✅ 性能优秀，内存可控
- ✅ 信噪比高，聚焦有效信号

**缺点**:
- ⚠️ 无法查看历史
- ⚠️ 无法做回测分析

### 实战应用

**实时追踪模式适用于**:
- ✅ 当前支撑/阻力位判断
- ✅ 大资金意图实时监控
- ✅ Spoof/Trap即时告警
- ✅ 交易决策辅助

**历史累计模式适用于**:
- ⚠️ 行为模式回测（未实现）
- ⚠️ 参数优化（未实现）
- ⚠️ 统计分析（未实现）

---

## 📊 数据库vs内存

### 内存Map（实时追踪）

**用途**: 实时追踪和快速查询

**数据**:
- 当前存在的挂单
- 最近1小时撤销的挂单
- 生命周期完整信息

**优点**: 查询快（O(1)），实时更新

### 数据库（历史存档）

**用途**: 持久化存储和历史查询

**数据**:
- 每15秒保存一次检测结果
- 完整的trap/swan/score字段
- 可查询任意历史时间

**优点**: 持久化，可回测

### 两者关系

```
内存Map（实时）
   ↓ 每15秒
数据库（历史）
   ↑ 历史查询API
前端历史模式（未实现）
```

---

## 🎉 结论

### 当前实现：实时追踪模式 ✅

**展示**: 当前正在追踪的大额挂单（存在中 + 最近1小时内撤销）

**优点**:
- ✅ 实时性强
- ✅ 性能优秀
- ✅ 聚焦当前市场

**ETHUSDT为0的原因**:
- ✅ 正常现象
- ✅ 当前无>1M USD挂单
- ✅ ETHUSDT流动性好，挂单分散

**优化空间**:
- ⚠️ 可添加历史查询模式
- ⚠️ 可添加活跃/撤销分tab显示
- ⚠️ 可降低ETHUSDT阈值到500K（可选）

---

🎯 **现在的实现逻辑是：实时追踪当前存在的大额挂单，保留1小时内撤销的记录用于Spoof分析**

