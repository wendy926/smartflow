# V3策略15M得分修复记录

**修复时间**: 2025-10-07  
**问题严重性**: 🔴 高（导致所有15M信号失效）

---

## 问题描述

**Dashboard显示异常**：
- 判断15m入场：都判断为"无效" ❌
- 得分：都为0 ❌

**实际日志**：
```
SOLUSDT 15M TREND市 - 传统得分:5/5, 加权得分:60.0%
但信号融合: 15M=0/5  ← 错误！
```

---

## 根本原因

### 代码层面

**文件**: `src/strategies/v3-strategy.js`  
**位置**: `calculate15MScore()` 方法返回值

```javascript
// 错误代码（第410行）
return weightedScore > 0.6 ? score : 0;
```

**问题分析**：
1. 使用 `> 0.6`（大于）而非 `>= 0.6`（大于等于）
2. 当加权得分刚好60%时，`0.6 > 0.6` = false，返回0
3. 导致所有60%临界值的有效信号被过滤

### 影响范围

- **受影响交易对**: 所有加权得分≤60%的交易对
- **典型案例**: SOLUSDT (5/5得分被降为0)
- **策略影响**: 信号融合层无法获取15M得分，导致整体评分偏低

---

## 修复方案

### 代码修复

```javascript
// 修复后（第410-412行）
// 修复：使用>= (大于等于)，60%应该返回传统得分
// 优化：直接返回传统得分，让信号融合层判断阈值
return score;
```

**修复逻辑**：
1. ~~移除阈值判断~~（在`calculate15MScore`中过滤是错误的设计）
2. 直接返回传统得分（5分制）
3. 让信号融合层(`combineSignals`)根据加权总分判断是否交易

### 设计原则

**分层职责**：
- **因子评分层** (`calculate15MScore`): 只负责计算得分，不做过滤
- **信号融合层** (`combineSignals`): 负责综合判断和阈值过滤

---

## 验证结果

### 日志对比

**修复前**：
```
SOLUSDT: 15M=0/5, 总分=35% ❌
BNBUSDT: 15M=0/5, 总分=61% ❌
```

**修复后**：
```
SOLUSDT: 15M=5/5, 总分=74% ✅
BNBUSDT: 15M=4/5, 总分=81% ✅
```

### Dashboard显示

| 项目 | 修复前 | 修复后 |
|------|--------|--------|
| 15M入场判断 | 无效 ❌ | 有效 ✅ |
| 15M得分 | 0 ❌ | 4-5 ✅ |
| 总体得分 | 35-61% ❌ | 74-81% ✅ |

---

## 影响评估

### 正面影响

1. ✅ **信号准确性提升**: 60%临界值的有效信号不再被误杀
2. ✅ **策略评分提升**: 15M得分正常参与总分计算
3. ✅ **交易机会增加**: 原本被过滤的有效信号可以正常交易
4. ✅ **逻辑一致性**: 评分和过滤职责分离，符合设计原则

### 需要监控

1. ⚠️ **信号数量**: 修复后可能产生更多交易信号
2. ⚠️ **胜率变化**: 需监控新增信号的胜率表现
3. ⚠️ **临界值优化**: 60%阈值是否需要调整（在融合层）

---

## 相关文件

- **主策略文件**: `src/strategies/v3-strategy.js`
- **加权评分**: `src/strategies/v3-strategy-weighted.js`
- **前端显示**: `src/web/app.js`
- **优化文档**: `strategy-v3-plus.md`

---

## 总结

**修复性质**: 🐛 Bug修复（逻辑错误）  
**修复难度**: ⭐ 简单（单行代码）  
**修复效果**: 🌟🌟🌟🌟🌟 显著（立即生效）

**核心经验**：
1. 边界条件检查：`>` vs `>=` 的重要性
2. 职责分离：评分层不应做过滤决策
3. 日志完整性：如果没有详细日志，很难发现这个问题

---

**修复状态**: ✅ 已完成并验证  
**生效时间**: 2025-10-07 12:40  
**文档编写**: 2025-10-07

