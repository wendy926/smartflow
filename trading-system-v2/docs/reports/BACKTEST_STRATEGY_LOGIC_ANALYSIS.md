# 回测策略逻辑分析报告

## 问题分析

### 问题1: 前端时间框架选择功能未显示
**状态**: ✅ 已修复
- 已部署更新后的`strategy-params.js`
- 用户点击"运行回测"时会弹出对话框选择时间框架

### 问题2-4: 回测逻辑与Dashboard策略不一致

#### 当前问题：

1. **回测引擎未使用Dashboard的真实策略逻辑**
   - 当前回测引擎使用简化的突破策略（价格突破前20根K线）
   - Dashboard的ICT策略使用复杂的订单块、流动性扫荡、吞没形态等逻辑
   - Dashboard的V3策略使用4H趋势、1H因子、15M执行的完整逻辑

2. **止损止盈计算不正确**
   - 当前回测：简单的ATR倍数（2倍止损，3倍止盈）
   - Dashboard ICT：结构止损（基于订单块和流动性扫荡）
   - Dashboard V3：动态止损（基于ATR和置信度，盈亏比至少2:1）

3. **信号检测逻辑过于简单**
   - 当前回测：只检测价格突破
   - Dashboard ICT：订单块 + 流动性扫荡 + 吞没形态 + 谐波形态
   - Dashboard V3：4H趋势 + 1H因子（成交量、持仓量、资金费率）+ 15M执行

4. **最大回撤和盈亏比问题**
   - 当前回测：最大回撤非常大（因为止损计算不正确）
   - Dashboard策略：最大回撤不超过20%（通过结构止损和动态止损）
   - Dashboard策略：盈亏比至少2:1（通过分层止盈和追踪止损）

## 解决方案

### 方案1: 直接调用Dashboard策略逻辑（推荐）

**优点**:
- 完全复用Dashboard的策略逻辑
- 回测结果与实时策略一致
- 无需重复维护两套逻辑

**实现方式**:
1. 回测引擎直接调用`ICTStrategy.execute()`和`V3StrategyV31.execute()`
2. 使用策略返回的`stopLoss`和`takeProfit`
3. 使用策略返回的`signal`判断入场/出场

**挑战**:
- ICT策略需要1D/4H/15M数据，回测只有1h或5m数据
- 需要模拟策略所需的数据格式
- 性能问题（逐根K线调用策略）

### 方案2: 提取关键参数并重构回测逻辑

**优点**:
- 性能更好（不需要逐根调用策略）
- 可以针对回测优化

**缺点**:
- 需要重新实现一套逻辑
- 容易与Dashboard策略不一致
- 维护成本高

## 推荐实施方案

采用**方案1**，但需要解决数据格式问题：

### 步骤1: 修改ICT策略，支持1h数据回测
- ICT策略默认需要1D/4H/15M数据
- 回测时只有1h或5m数据
- 解决方案：使用1h数据模拟4H数据，使用5m数据模拟15M数据

### 步骤2: 修改回测引擎，直接调用策略
- 使用`BacktestStrategyEngineV2`
- 逐根K线调用`ictStrategy.execute()`和`v3Strategy.execute()`
- 使用策略返回的止损止盈

### 步骤3: 验证回测结果
- 对比回测结果与Dashboard实时策略
- 确保最大回撤不超过20%
- 确保盈亏比至少2:1

## 当前状态

- ✅ 已创建`BacktestStrategyEngineV2`
- ⏳ 需要修改ICT和V3策略，支持回测数据格式
- ⏳ 需要修改`BacktestManager`，使用新的回测引擎
- ⏳ 需要测试验证

## 下一步行动

1. 修改ICT策略，支持使用1h数据作为4H数据
2. 修改V3策略，支持使用1h数据作为4H数据
3. 更新`BacktestManager`，使用`BacktestStrategyEngineV2`
4. 部署并测试
5. 对比回测结果与Dashboard实时策略

