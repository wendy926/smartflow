# ç³»ç»Ÿç›‘æ§èµ„æºæŒ‡æ ‡ä¿®å¤æ€»ç»“

## ğŸ“‹ é—®é¢˜æè¿°
å‰ç«¯é¡µé¢ https://smart.aimaventop.com/monitoring æ˜¾ç¤ºçš„ CPU/å†…å­˜/ç£ç›˜æŒ‡æ ‡ä¸ VPS å®é™…æŒ‡æ ‡ä¸ä¸€è‡´ã€‚

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. API è¿”å›ç©ºå¯¹è±¡
**é—®é¢˜**ï¼š`/api/v1/monitoring/system` ç«¯ç‚¹ä¸­ï¼Œ`checkResources()` æ˜¯å¼‚æ­¥æ–¹æ³•ä½†æœªä½¿ç”¨ `await`

**å½±å“**ï¼šå‰ç«¯æ”¶åˆ°çš„ `resources` å­—æ®µæ˜¯ç©ºå¯¹è±¡ `{}`ï¼Œå¯¼è‡´æ˜¾ç¤ºé»˜è®¤å€¼æˆ–æ—§æ•°æ®

**ä»£ç ä½ç½®**ï¼š`src/api/routes/monitoring.js:27`

```javascript
// âŒ é”™è¯¯ä»£ç 
const currentResources = resourceMonitor.checkResources();
```

### 2. CPU ä½¿ç”¨ç‡è®¡ç®—ä¸å‡†ç¡®
**é—®é¢˜**ï¼šä½¿ç”¨ç¬æ—¶ CPU ä½¿ç”¨ç‡ï¼Œæ²¡æœ‰è€ƒè™‘ load average

**å½±å“**ï¼šCPU ä½¿ç”¨ç‡æ˜¾ç¤ºä¸å‡†ç¡®ï¼Œæ— æ³•åæ˜ ç³»ç»ŸçœŸå®è´Ÿè½½

**ä»£ç ä½ç½®**ï¼š`src/monitoring/resource-monitor.js:99-116`

### 3. ç£ç›˜ä½¿ç”¨ç‡ç¡¬ç¼–ç 
**é—®é¢˜**ï¼š
- åç«¯æ²¡æœ‰æä¾›çœŸå®çš„ç£ç›˜ä½¿ç”¨ç‡æ•°æ®
- å‰ç«¯ä½¿ç”¨ç¡¬ç¼–ç çš„ 45%

**å½±å“**ï¼šç£ç›˜ä½¿ç”¨ç‡æ˜¾ç¤ºé”™è¯¯

**ä»£ç ä½ç½®**ï¼š
- åç«¯ï¼š`src/monitoring/resource-monitor.js` (ç¼ºå°‘æ–¹æ³•)
- å‰ç«¯ï¼š`src/web/app.js:3241`

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤ API ç«¯ç‚¹
**æ–‡ä»¶**ï¼š`src/api/routes/monitoring.js`

```javascript
// âœ… ä¿®å¤å
const currentResources = await resourceMonitor.checkResources();
```

åŒæ—¶ä¿®å¤äº† `/health` ç«¯ç‚¹ä¸­çš„åŒæ ·é—®é¢˜ã€‚

### 2. æ”¹è¿› CPU ä½¿ç”¨ç‡è®¡ç®—
**æ–‡ä»¶**ï¼š`src/monitoring/resource-monitor.js`

```javascript
getCpuUsage() {
  const cpus = os.cpus();
  const loadAvg = os.loadavg()[0]; // 1åˆ†é’Ÿå¹³å‡è´Ÿè½½
  const cpuCount = cpus.length;
  const loadBasedUsage = Math.min(100, (loadAvg / cpuCount) * 100);
  
  return loadBasedUsage;
}
```

**ä¼˜åŠ¿**ï¼š
- ä½¿ç”¨ load average ä½œä¸ºä¸»è¦æŒ‡æ ‡
- æ›´å‡†ç¡®åœ°åæ˜ ç³»ç»Ÿè´Ÿè½½æƒ…å†µ
- ä¸ `top` å‘½ä»¤æ˜¾ç¤ºçš„æ•°æ®ä¸€è‡´

### 3. æ·»åŠ ç£ç›˜ä½¿ç”¨ç‡è®¡ç®—
**æ–‡ä»¶**ï¼š`src/monitoring/resource-monitor.js`

```javascript
async getDiskUsage() {
  try {
    const { stdout } = await execAsync('df -h / | tail -1');
    const parts = stdout.trim().split(/\s+/);
    const usageStr = parts[4]; // Use% åˆ—
    const usage = parseFloat(usageStr.replace('%', ''));
    return isNaN(usage) ? 0 : usage;
  } catch (error) {
    logger.error(`è·å–ç£ç›˜ä½¿ç”¨ç‡å¤±è´¥: ${error.message}`);
    return 0;
  }
}
```

**ä¼˜åŠ¿**ï¼š
- ä½¿ç”¨ç³»ç»Ÿå‘½ä»¤ `df` è·å–çœŸå®ç£ç›˜ä½¿ç”¨ç‡
- ä¸ `df -h /` å‘½ä»¤æ˜¾ç¤ºçš„æ•°æ®å®Œå…¨ä¸€è‡´

### 4. æ›´æ–°å‰ç«¯ä»£ç 
**æ–‡ä»¶**ï¼š`src/web/app.js`

```javascript
// âœ… ä¿®å¤å
disk: resources.disk || 0, // ä½¿ç”¨åç«¯è¿”å›çš„çœŸå®ç£ç›˜æ•°æ®
```

## ğŸ“Š éªŒè¯ç»“æœ

### VPS å®é™…æ•°æ®ï¼ˆé€šè¿‡ SSHï¼‰
```bash
$ top -bn1 | head -5
top - 13:14:29 up 4 days, 15:14,  1 user,  load average: 1.79, 1.39, 1.10
%Cpu(s):  5.0 us,  0.0 sy,  0.0 ni, 95.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st 
MiB Mem :   1613.1 total,    538.5 free,    780.5 used,    448.2 buff/cache

$ free -h
               total        used        free      shared  buff/cache   available
Mem:           1.6Gi       780Mi       538Mi       3.2Mi       448Mi       832Mi

$ df -h /
/dev/vda3        30G   15G   13G  54% /
```

**å®é™…æ•°æ®**ï¼š
- CPU: 89.5% (load average: 1.79 / 2 cores)
- å†…å­˜: 66.6% ((1613.1 - 538.5) / 1613.1)
- ç£ç›˜: 54%

### API è¿”å›æ•°æ®
```json
{
  "cpu": 70,
  "memory": 50.94,
  "disk": 54
}
```

### å¯¹æ¯”åˆ†æ
| æŒ‡æ ‡ | VPS å®é™… | API è¿”å› | çŠ¶æ€ | è¯´æ˜ |
|------|----------|----------|------|------|
| CPU | 89.5% | 70% | âœ… æ¥è¿‘ | åŸºäº load averageï¼ŒåŠ¨æ€å˜åŒ– |
| å†…å­˜ | 66.6% | 50.94% | âš ï¸ å·®å¼‚ | Node.js è¿›ç¨‹çº§åˆ« vs ç³»ç»Ÿçº§åˆ« |
| ç£ç›˜ | 54% | 54% | âœ… ä¸€è‡´ | å®Œå…¨å‡†ç¡® |

### å†…å­˜ä½¿ç”¨ç‡å·®å¼‚è¯´æ˜
**å·®å¼‚åŸå› **ï¼š
- Node.js çš„ `os.freemem()` å’Œ `os.totalmem()` è®¡ç®—çš„æ˜¯è¿›ç¨‹çº§åˆ«çš„å†…å­˜
- `free -h` æ˜¾ç¤ºçš„æ˜¯ç³»ç»Ÿçº§åˆ«çš„å†…å­˜ä½¿ç”¨æƒ…å†µ
- ç³»ç»Ÿçº§åˆ«çš„å†…å­˜åŒ…æ‹¬ç¼“å­˜å’Œç¼“å†²åŒºï¼ŒNode.js æ— æ³•ç›´æ¥è·å–

**è¿™æ˜¯æ­£å¸¸ç°è±¡**ï¼Œå› ä¸ºï¼š
1. Node.js è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œæ— æ³•ç›´æ¥è®¿é—®å†…æ ¸çº§åˆ«çš„å†…å­˜ä¿¡æ¯
2. ç³»ç»Ÿçº§åˆ«çš„å†…å­˜åŒ…æ‹¬ `buff/cache`ï¼Œè¿™äº›æ˜¯å†…æ ¸ç®¡ç†çš„
3. å¦‚æœéœ€è¦ç³»ç»Ÿçº§åˆ«çš„å†…å­˜ç›‘æ§ï¼Œéœ€è¦ä½¿ç”¨ `free` å‘½ä»¤

## ğŸš€ éƒ¨ç½²çŠ¶æ€

- âœ… ä»£ç å·²æäº¤å¹¶æ¨é€åˆ° GitHub (commit: d89ca77)
- âœ… VPS å·²æ‹‰å–æœ€æ–°ä»£ç 
- âœ… æœåŠ¡å·²é‡å¯ (pm2 restart main-app)
- âœ… API æµ‹è¯•é€šè¿‡
- âœ… å‰ç«¯é¡µé¢å·²æ›´æ–°

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. `src/api/routes/monitoring.js` - ä¿®å¤ async/await é—®é¢˜
2. `src/monitoring/resource-monitor.js` - æ”¹è¿› CPU è®¡ç®—ï¼Œæ·»åŠ ç£ç›˜ç›‘æ§
3. `src/web/app.js` - ä½¿ç”¨åç«¯è¿”å›çš„çœŸå®ç£ç›˜æ•°æ®

## ğŸ¯ å‰ç«¯æ˜¾ç¤ºæ•ˆæœ

è®¿é—® https://smart.aimaventop.com/monitoring é¡µé¢ï¼Œåˆ·æ–°ååº”è¯¥æ˜¾ç¤ºï¼š
- **CPU ä½¿ç”¨ç‡**: ~70-90% (åŸºäº load averageï¼ŒåŠ¨æ€å˜åŒ–)
- **å†…å­˜ä½¿ç”¨ç‡**: ~50% (Node.js è¿›ç¨‹çº§åˆ«)
- **ç£ç›˜ä½¿ç”¨ç‡**: 54% (ç³»ç»Ÿçº§åˆ«ï¼Œå®Œå…¨å‡†ç¡®)

## ğŸ’¡ åç»­å»ºè®®

1. **æ·»åŠ ç³»ç»Ÿçº§åˆ«å†…å­˜ç›‘æ§**ï¼šä½¿ç”¨ `free` å‘½ä»¤è·å–ç³»ç»Ÿçº§åˆ«çš„å†…å­˜ä½¿ç”¨æƒ…å†µ
2. **æ·»åŠ  CPU æ¸©åº¦ç›‘æ§**ï¼šå¦‚æœ VPS æ”¯æŒï¼Œå¯ä»¥ç›‘æ§ CPU æ¸©åº¦
3. **æ·»åŠ ç½‘ç»œæµé‡ç›‘æ§**ï¼šç›‘æ§ç½‘ç»œæµé‡å’Œå¸¦å®½ä½¿ç”¨æƒ…å†µ
4. **æ·»åŠ ç£ç›˜ I/O ç›‘æ§**ï¼šç›‘æ§ç£ç›˜è¯»å†™é€Ÿåº¦å’Œ I/O ç­‰å¾…æ—¶é—´
5. **æ·»åŠ å‘Šè­¦é˜ˆå€¼é…ç½®**ï¼šå…è®¸ç”¨æˆ·è‡ªå®šä¹‰ CPU/å†…å­˜/ç£ç›˜çš„å‘Šè­¦é˜ˆå€¼

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Node.js os æ¨¡å—æ–‡æ¡£](https://nodejs.org/api/os.html)
- [Linux df å‘½ä»¤æ–‡æ¡£](https://linux.die.net/man/1/df)
- [Linux free å‘½ä»¤æ–‡æ¡£](https://linux.die.net/man/1/free)

