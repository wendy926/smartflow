好——这是一个很经典也很有趣的策略类型。你给的 ICT 订单块策略结构清晰、层级严密，但**“盈亏比一直低”**背后通常是 多个小问题共同放大 的结果（尤其在多时框、门槛式确认这种“必须全部通过”的逻辑里）。下面我把可能原因按优先级列清楚、给出明确修复建议和可量化的检验方法，帮你把问题排查到位并给出快速改进路径。

# 1) 最有可能的根因（优先级高 — 先查）

这些问题最常导致“盈利空间被切断 / 被止损 / 信号质量下降”。

## 1.1 ATR 时框/单位错配（高概率）

你写到：

* 订单块高度用 `ATR(4H)`（高度阈值）
* 止损与某些判断用 `ATR(15M)`（或“与 V3 保持一致，基于15M ATR”）

问题：**用 15M ATR 为基准去给基于 4H 或 1D 级别的订单块设置止损/高度**，会导致止损过紧（15M 的 ATR 很小），或订单块高度计算不匹配实际波动，从而频繁被市场噪音扫出或识别出太多弱块。

修复建议：

* 对不同用途使用对应时框的 ATR：

  * 订单块高度/有效性 → 用 **ATR(4H)** 或 **ATR(1D)**（与所判定的HTF一致）
  * 止损根据入场时参考时框（既然15M入场确认，止损可以用 ATR(15M) × n，但若信号来源/方向基于4H/1D，建议用 ATR(1H或4H)）
* 如果策略基于 HTF 结构（1D/4H），**止损推荐使用 4H ATR × (2.5~3)**（加密品种）
* 在代码里强制注明单位：`atr_value` 单位为价格点（USDT），并在日志打印 `atr_timeframe`。

检测方法：
打印每笔交易：

```
entryPrice, ATR_15m, ATR_1h, ATR_4h, selected_ATR, stopLoss, sl_pct
```

若 `sl_pct < 0.3%` 且 selected_ATR 来自 15m，则很可能过紧。

---

## 1.2 门槛式“必须同时满足”导致的假阳/错杀或过度苛刻（高概率）

你要求五个门槛全部满足（且15M入场强度 ≥60%），并且还要总分≥60。这种“AND + 高阈值”会：

* 导致合格信号极少（胜率/信号量变低），或
* 被迫只在趋势末端才满足所有条件（因为HTF+谐波+吞没三者同时出现往往在波段后段），从而 **进场时盈利空间已被压缩**。

修复建议：

* 把“必须条件”改成 **强制 + 可选分层**：

  * 保留日线趋势（必须）和有效订单块（必须）；将 4H扫荡 / 15M吞没设为“强加分而非绝对必须”；
* 保留“WATCH”逻辑，但允许 WATCH 在满足额外短期确认后（例如两根15M在有利方向闭合）转为执行。
* 或者采用两套阈值：`strict`（生产）和 `relaxed`（paper/backtest），在回测中评估盈亏比/胜率折衷。

检测方法：
统计满足“所有门槛”的信号数量 vs 满足“日线+订单块+任意1个LTF确认”的信号数量，观察两组的平均盈亏比与胜率。

---

## 1.3 扫荡阈值过度放宽或不匹配（高概率）

你把 HTF 扫荡阈值从 0.4×ATR(4H) 放宽到 0.2×ATR(4H)，LTF 从 0.2×ATR(15M) 放宽至 0.02×ATR(15M)。
问题：

* 0.02×ATR(15M) 事实上极小，几乎任何快速波动都能被识别为“扫荡”，导致**错误确认**（低质量的“扫荡”会产生假信号）。

修复建议：

* 将 LTF 阈值恢复到至少 `0.1~0.2 × ATR(15M)`，HTF 保持 `0.25~0.4 × ATR(4H)`（对币种可微调）。
* 添加“回归速度/比例”条件：扫荡必须在 N 根 LTF K 线内回归至订单块内一定比率（例如回归 50% 以上），否则视为失败扫荡。

检测方法：
统计被标记为“扫荡”的事件中，有多少在 3 根 LTF K 线内完成回归（ratio），低于 50% 的视为假阳。

---

# 2) 中等优先级（影响盈亏比但不一定致命）

## 2.1 谐波检测容差过宽或匹配不严

10% 容差 + 3 种形态并列，容易识别到“伪谐波”，尤其在高噪市场。伪谐波 + 门槛式导致“硬性满足但质量差”。

修复建议：

* 提升谐波匹配门槛：容差降到 5% 或要求 **均满足 AB/BC/CD 三段同时在指定区间**，并要求 D 点位与订单块有位置重合（例如 D 点在订单块±x%区间）。
* 将谐波作为“置信度加分”而非硬性必须（除非置信度≥0.8）。

检测方法：
把谐波检测结果和后续 K 线收益做回归，检验“谐波存在 → 后续平均收益”是否显著正相关。

---

## 2.2 成交量集中与年龄过滤设置

* 成交量集中用“最后2根 K 线 >= 60% avg”可能对低流动品种过宽或过窄；年龄 ≤5 天放宽可能会引入“过时订单块”。

修复建议：

* 成交量门槛调为 `>= 80%`（对主流币）或按品种自适应阈值（用历史分位数）。
* 年龄过滤：对于 4H 订单块，`≤2~3 天` 更能代表“近期机构动向”，5 天可作备选但需更严格的有效性回归检查（被扫后回归行为）。

检测方法：
查看“老订单块（>3天）”与“新订单块（<=3天）”在信号后 24/72h 的平均收益差异。

---

## 2.3 止损规则（ATR ×2）在此策略的适配性

问题：

* 如果 stop = entry ± 2×ATR(15M) 而订单块基于 4H/1D，2×15M ATR 很小；反之如果 ATR 用 4H，但订单入场在15M，止损可能变得很宽，影响杠杆/资金利用率。

修复建议：

* 对订单块/结构型交易，**止损基于结构点（扫荡极值 / 订单块边界）优先**，并以 ATR(4H) 做容错（例如：stop = max(structural_stop, entry - ATR4H×2)）。
* 对“短线吞没反转入场”，可以使用 ATR(15M) × 1.8 ~ 2.5。

检测方法：
比较两种止损逻辑的回测：`structural_stop` vs `pure_ATR_stop`，观察平均盈亏比与最大回撤。

---

# 3) 低优先级 / 实现层常见 bug（也要检查）

这些是做回测/实盘时常出现但不太显眼的实现错误——会导致盈亏比被悄悄拉低或胜率异样。

## 3.1 逻辑反向或方向错配（例如扫荡方向与趋势方向判断反了）

很多多时框策略的 bug 来自“方向定义不一致”（某处 UP=price>ma，另一处UP=price<ma），或者扫荡方向（“下方扫荡”定义错误）。
**检查**：对齐方向枚举（UP/DOWN/RANGE）在所有模块使用同一定义。

## 3.2 权重 / 分数归一化错误

总分计算若没有归一化（或基础权重加起来不等于 100），会导致 `totalScore` 始终 <60 或 >100，从而大量 WATCH 或少量交易。

**检查**：打印 w_sum，确保 `w_sum==1` 或按百分比计算。

## 3.3 时间同步 / 缓存数据滞后

跨时框使用前要确保用的是同一时间点的 K 线快照，避免 15M 数据先更新、4H/1D 还没更新导致信号不一致。

**检查**：加入 `timestamp` 校验，确保所有时框数据时间戳一致或可比。

## 3.4 执行成本 / 滑点 / 费率没有计入

实际盈亏被滑点和手续费吞噬，尤其 1) 入场点按下一根 15M 开盘价；2) 高杠杆下手续费比例高。
**建议**：回测默认扣除 `0.04%` 交易费 + 平均滑点 `0.03~0.2%`（按品种流动性）看策略指标变化。

---

# 4) 优化建议（可立即实验的参数和逻辑调整）

给出一套 A/B 测试友好的调整，你可以在回测里快速跑对比。

## A — 更“结构导向”的版本（优先）

* 订单块年龄 ≤ 3 天
* 订单块高度 ≥ 0.25 × ATR(4H)
* LTF 扫荡阈值 = 0.1 × ATR(15M)，HTF = 0.3 × ATR(4H)
* 入场后止损 = max(structural_stop, entry ± ATR(4H) × 2.5)
* 保留门槛1+2为必须（1D趋势 + 有效订单块）；其余条件任意满足 2 项即可触发（并且 15M 吞没强度 ≥ 50% 或谐波≥0.7）

## B — 更“严格筛选”但放宽止损空间（若之前止损太紧）

* 保持门槛式 5 条，但把 15M 强度门槛调为 ≥ 50%（不硬性 60%）
* 止损改 ATR(4H) × 3
* 判定成交量门槛提高到 80%

## C — 日内短周期版本（更适合 15M 主导）

* 把逻辑下沉：以 15M/1H 为主，HTF 只作方向过滤
* 止损用 ATR(15M) × 2.2
* 允许 15M 入场在吞没 + LTF 扫荡确认下直接进入（不必同时满足4H扫荡）

---

# 5) 必做的调试输出（你应该在回测/实盘里立刻加这些日志/统计）

每次信号产生时记录一行 JSON（便于后续分析）：

```json
{
  "time": "...",
  "symbol":"BTCUSDT",
  "direction":"BUY",
  "dailyTrend":"UP",
  "orderBlock_age_days":2,
  "orderBlock_height_pct":0.18,
  "HTF_sweep":true,
  "LTF_sweep":true,
  "engulfing_strength":0.42,
  "harmonic_score":0.0,
  "totalScore":58,
  "reason":"WATCH (engulfing<0.6)",
  "selected_ATR_timeframe":"4h",
  "ATR_4h":620,
  "selected_stop":63180,
  "sl_pct":2.8
}
```

用这些数据可以快速筛查：

* 哪个因子频繁不合格（engulfing/harmonics/volume）
* 哪类止损太紧（sl_pct 分布）
* 门槛何时把好信号拒之门外

---

# 6) 要求回测/观察的关键指标（回测报告里必须输出）

* 信号数量（per week / per month）
* 平均持仓时间
* 平均止损百分比（sl_pct）
* 赢利单平均收益 vs 亏损单平均亏损（求得盈亏比）
* 信号通过门槛的分布（哪些门槛常不通过）
* 订单块年龄 vs 后续收益的相关性

---

# 7) 最后 — 快速优先级行动清单（按顺序执行）

1. **打印 ATR（15m/1h/4h/1d）与被选用在哪个模块**（确定无单位/时框误用）。
2. 检查并修正 LTF 扫荡阈值（把 0.02×ATR 恢复到 ≥0.1）。
3. 把“必须同时满足 5 条”改为“必须满足日线+订单块，其余2/3 条任一”做 A/B 测试。
4. 止损改为：`max(structural_stop, entry ± ATR(4H)*2.5)` 并回测。
5. 在回测中加入滑点+手续费并生成上面建议的 JSON 日志，定位最常失败的因子。