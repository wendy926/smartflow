# äº¤æ˜“ç­–ç•¥æ‰§è¡Œ

æ—¢æœ‰é€»è¾‘ä¸¥è°¨æ€§ï¼Œåˆèƒ½å¢åŠ å…¥åœºæœºä¼šçš„ç‰ˆæœ¬

# **ğŸ”¹ æ”¹è¿›ç‰ˆå¤šå‘¨æœŸäº¤æ˜“ç­–ç•¥**

**æ­¥éª¤ 1ï¼šå¤§å‘¨æœŸè¶‹åŠ¿è¿‡æ»¤ï¼ˆæ—¥çº¿-å¤©çº§åˆ«ï¼‰**

ç›®çš„æ˜¯åªåšè¶‹åŠ¿æ–¹å‘çš„å•å­ï¼Œé¿å…é€†åŠ¿äº¤æ˜“ã€‚åªè¦ä»·æ ¼å’ŒçŸ­ä¸­å‡çº¿ä¸€è‡´ï¼ŒåŒæ—¶è¶‹åŠ¿å¼ºåº¦å’Œæ³¢åŠ¨ç‡æ‰©å¼ ç¡®è®¤ï¼Œå°±è®¤ä¸ºæœ‰æ–¹å‘æ€§è¡Œæƒ…ã€‚

- å¤šå¤´è¶‹åŠ¿ï¼š
    - ä»·æ ¼åœ¨ MA20 ä¸Šæ–¹
    - MA20 > MA50 > MA200
    - ADX(14) > 20ï¼ˆè¯´æ˜è¶‹åŠ¿å¼ºåº¦è¶³å¤Ÿï¼‰
    - å¸ƒæ—å¸¦å¼€å£æ‰©å¼ ï¼šå¸ƒæ—å¸¦ä¸Šè½¨å’Œä¸‹è½¨é—´è·æœ€è¿‘ 20 æ ¹ K çº¿é€æ¸æ‰©å¤§ï¼Œä»£è¡¨æ³¢åŠ¨ç‡å¢åŠ ï¼Œè¶‹åŠ¿åœ¨èµ°å¼ºã€‚
- ç©ºå¤´è¶‹åŠ¿ï¼š
    - ä»·æ ¼åœ¨ MA20 ä¸‹æ–¹
    - MA20 < MA50 < MA200
    - ADX(14) > 20
    - å¸ƒæ—å¸¦å¼€å£æ‰©å¼ ï¼šå¸ƒæ—å¸¦ä¸Šè½¨å’Œä¸‹è½¨é—´è·æœ€è¿‘ 20 æ ¹ K çº¿é€æ¸æ‰©å¤§ï¼Œä»£è¡¨æ³¢åŠ¨ç‡å¢åŠ ï¼Œè¶‹åŠ¿åœ¨èµ°å¼ºã€‚
  
  è¶‹åŠ¿ä¿¡å·ç¡®è®¤æ¡ä»¶ï¼š
1. è¶‹åŠ¿åŸºç¡€æ¡ä»¶ï¼ˆå¿…é¡»æ»¡è¶³ï¼‰
    - ä»·æ ¼ç›¸å¯¹ MA20 çš„ä½ç½®ï¼ˆåœ¨ä¸Šæ–¹åšå¤š / ä¸‹æ–¹åšç©ºï¼‰
    - MA20 / MA50 /MA200 é¡ºåºä¸è¶‹åŠ¿æ–¹å‘ä¸€è‡´
2. è¶‹åŠ¿å¼ºåº¦ & æ³¢åŠ¨ç‡æ¡ä»¶ï¼ˆæ‹©ä¸€å³å¯ï¼‰
    - ADX(14) > 20 æˆ–
    - å¸ƒæ—å¸¦å¼€å£æ‰©å¼ 
è¾“å‡ºï¼štrend4h = "å¤šå¤´" | "ç©ºå¤´" | "éœ‡è¡"

**æ­¥éª¤ 2ï¼šä¸­å‘¨æœŸç¡®è®¤ï¼ˆ1Hï¼‰ â†’ å¤šå› å­æ‰“åˆ†ä½“ç³»**

è¦æ±‚å¿…é¡»æ»¡è¶³VWAPæ–¹å‘ä¸€è‡´ï¼Œå¹¶ä¸”ç»™æ¯ä¸ªæ¡ä»¶æ‰“åˆ†ï¼Œåªè¦æ€»åˆ†è¾¾åˆ° 3 åˆ†åŠä»¥ä¸Š å°±å…è®¸è¿›åœºã€‚

**æ‰“åˆ†ä½“ç³»ï¼ˆä»¥ä¸‹æ¯ä¸ªæ¡ä»¶æ»¡è¶³éƒ½ä¸º1 åˆ†ï¼Œæ»¡è¶³ä¸€ä¸ªåˆ™åŠ 1åˆ†ï¼‰ï¼š**

1. VWAPæ–¹å‘ä¸€è‡´ï¼šï¼ˆå¿…é¡»æ»¡è¶³ï¼‰
  - å¤šå¤´ï¼šæ”¶ç›˜ä»· > VWAP
  - ç©ºå¤´ï¼šæ”¶ç›˜ä»· < VWAP
2. çªç ´ç»“æ„ï¼š
  - å¤šå¤´ï¼šæ”¶ç›˜ä»·çªç ´æœ€è¿‘ 20 æ ¹ 4H Kçº¿é«˜ç‚¹
  - ç©ºå¤´ï¼šæ”¶ç›˜ä»·è·Œç ´æœ€è¿‘ 20 æ ¹ 4H Kçº¿ä½ç‚¹
3. æˆäº¤é‡ç¡®è®¤ï¼š
  - 15m æˆäº¤é‡ â‰¥ 1.5 Ã— 20æœŸå‡é‡
  - 1h æˆäº¤é‡ â‰¥ 1.2 Ã— 20æœŸå‡é‡
4. OIç¡®è®¤ï¼š
  - å¤šå¤´ï¼š6h OI â‰¥ +2%
  - ç©ºå¤´ï¼š6h OI â‰¤ -3%
5. èµ„é‡‘è´¹ç‡ï¼š0.05% â‰¤ Funding Rate â‰¤ +0.05%
6. Deltaç¡®è®¤ï¼šä¹°å–ç›˜ä¸å¹³è¡¡ï¼ˆè§£é‡Šè§ä¸‹ï¼‰ã€‚
  - å¤šå¤´ï¼šä¸»åŠ¨ä¹°ç›˜ â‰¥ å–ç›˜ Ã— 1.2
  - ç©ºå¤´ï¼šä¸»åŠ¨å–ç›˜ â‰¥ ä¹°ç›˜ Ã— 1.2

Deltaç¡®è®¤çš„åˆ¤æ–­é€»è¾‘è¯´æ˜ï¼š
- Deltaï¼ˆå‡€ä¸»åŠ¨ä¹°å–é‡ï¼‰ = ä¸»åŠ¨ä¹°å•æˆäº¤é‡ - ä¸»åŠ¨å–å•æˆäº¤é‡ã€‚
- å¦‚æœ Delta åœ¨çªç ´æ–¹å‘æ˜¾è‘—æ”¾å¤§ï¼ˆå¦‚çªç ´æ—¶ 15m Delta > è¿‡å» 20 æ ¹å¹³å‡ Delta çš„ 2 å€ï¼‰ï¼Œè¯´æ˜æ˜¯çœŸå®èµ„é‡‘æ¨åŠ¨ï¼Œè€Œä¸æ˜¯å‡çªç ´ã€‚
- äº¤æ˜“æ‰€å±‚é¢ï¼šçœ‹ CVDï¼ˆCumulative Volume Delta ç´¯ç§¯ä¹°å–ç›˜å·®ï¼‰ã€‚CVD å‘ä¸Šå€¾æ–œ â†’ ä¹°æ–¹ä¸»åŠ¨ï¼Œå‘ä¸‹å€¾æ–œ â†’ å–æ–¹ä¸»åŠ¨ã€‚

**æ ¹æ®æ‰“åˆ†ä½“ç³»å°æ—¶çº§ä¿¡å·å¤§å°åˆ¤æ–­çš„æ‰§è¡Œè§„åˆ™ï¼š**

- VWAPæ–¹å‘ä¸€è‡´ï¼šï¼ˆå¿…é¡»æ»¡è¶³ï¼‰
- å¾—åˆ† â‰¥ 3 åˆ†ã€‚

**æ­¥éª¤ 3ï¼šå°å‘¨æœŸæ‰§è¡Œï¼ˆ15mï¼‰ â†’ å…¥åœºä¸é£æ§**

**ğŸŸ¢ å¤šå¤´æ¨¡å¼ï¼ˆè¶‹åŠ¿è·Ÿéšå‹ï¼‰**

- å…¥åœºé€»è¾‘ï¼šå›è¸©EMA20/50 æˆ– å‰é«˜/å‰ä½æ”¯æ’‘ â†’ setup candleçªç ´ç¡®è®¤ã€‚
- æ­¢ç›ˆï¼šâ‰¥ 2Rï¼ˆå¯åˆ†æ‰¹å‡ºåœºï¼‰ã€‚
- æ­¢æŸï¼šsetup candle å¦ä¸€ç«¯ æˆ– ATR1.2Ã—ã€‚
- ç‰¹ç‚¹ï¼šæŒä»“å‘¨æœŸå¯ä»¥æ›´ä¹…ï¼Œå› ä¸ºä¸Šæ¶¨è¶‹åŠ¿å»¶ç»­æ€§å¼ºã€‚

**ğŸ”´ ç©ºå¤´æ¨¡å¼ï¼ˆåŠ¨èƒ½çŸ­çº¿å‹ï¼‰**

- å…¥åœºé€»è¾‘ï¼šå¼ºè¶‹åŠ¿ç¡®è®¤åï¼Œ15m æˆ– 5m å‡ºç° æ”¾é‡è·Œç ´å‰ä½ â†’ ç›´æ¥åšç©ºã€‚
- æ­¢ç›ˆï¼š1.2R ~ 1.5R å°±å¹³å¤§éƒ¨åˆ†ä»“ä½ï¼Œå‰©ä½™ç”¨ç§»åŠ¨æ­¢æŸè·Ÿè¸ªã€‚
- æ­¢æŸï¼šsetup candle é«˜ç‚¹ æˆ– ATR1.2Ã—ã€‚
- ç‰¹ç‚¹ï¼šå¼ºè°ƒâ€œå¿«è¿›å¿«å‡ºâ€ï¼Œä¸åƒé•¿æ³¢æ®µï¼Œé¿å…ç©ºå¤´åæŠ½ã€‚

# **ğŸ”¹ æ‰§è¡Œæµç¨‹ç®€è¿°**

1. çœ‹å¤§å‘¨æœŸï¼ˆ1Dï¼‰ï¼š
    - ç¡®è®¤è¶‹åŠ¿æ–¹å‘ï¼ˆä»·æ ¼ vs MA200 + MA20/50 é¡ºåº + ADX>20 + å¸ƒæ—å¸¦å¼€å£æ‰©å¼ ï¼‰ã€‚
    - ç¡®å®šåªåšå¤š or åªåšç©ºã€‚
2. çœ‹ä¸­å‘¨æœŸï¼ˆ1Hï¼‰ï¼š
    - ä¾æ¬¡æ£€æŸ¥ 6 ä¸ªæ¡ä»¶ï¼ˆVWAP / çªç ´ / æˆäº¤é‡ / OI / èµ„é‡‘è´¹ç‡ / Deltaï¼‰ã€‚
    - æ¯æ»¡è¶³ä¸€ä¸ª +1 åˆ†ï¼Œâ‰¥2 åˆ†æ‰è¿›å…¥ 15m è§‚å¯Ÿã€‚
3. çœ‹å°å‘¨æœŸï¼ˆ15mï¼‰ï¼š
    - å¦‚æœè¡Œæƒ…ç»™å›è¸©ï¼ŒæŒ‰ å›è¸©æ¨¡å¼ å…¥åœºã€‚
    - å¦‚æœçªç ´æ—¶ä¼´éšæˆäº¤é‡ & OI æ”¾å¤§ï¼ŒæŒ‰ åŠ¨èƒ½æ¨¡å¼ è¿½å•ã€‚
4. é£é™©æ§åˆ¶ï¼š
    - æ­¢æŸ = setup candle å¦ä¸€ç«¯ æˆ– ATR Ã— 1.2ï¼Œå–æ›´è¿œã€‚
    - æ­¢ç›ˆ = åˆ†æ‰¹ï¼š1.5R å¹³ä¸€åŠï¼Œå‰©ä½™è·Ÿè¸ªæ­¢æŸã€‚

**ADX(14) çš„è®¡ç®—é€»è¾‘**

åŸºäº Kçº¿æ•°æ®è‡ªå·±ç®—ï¼š/fapi/v1/klinesï¼ˆè·å– high, low, closeï¼‰

1. è®¡ç®— True Range (TR)

TR = max(high - low, abs(high - previous_close), abs(low - previous_close))

2. è®¡ç®—æ–¹å‘ç§»åŠ¨ DM+ / DM-

DM+ = high - previous_high (è‹¥ >0 ä¸” > (previous_low - low)ï¼Œå¦åˆ™ 0)

DM- = previous_low - low (è‹¥ >0 ä¸” > (high - previous_high)ï¼Œå¦åˆ™ 0)

3. å¹³æ»‘å¤„ç† (14 å‘¨æœŸ)
ç”¨ Wilderâ€™s smoothingï¼ˆç±»ä¼¼EMAï¼‰ï¼š

TR14 = TR14_prev - (TR14_prev / 14) + TR

DM+14 = DM+14_prev - (DM+14_prev / 14) + DM+

DM-14 = DM-14_prev - (DM-14_prev / 14) + DM-

4. è®¡ç®—æ–¹å‘æŒ‡æ ‡ DI+ / DI-

DI+ = 100 * (DM+14 / TR14)

DI- = 100 * (DM-14 / TR14)

5. è®¡ç®— DX

DX = 100 * abs(DI+ - DI-) / (DI+ + DI-)

6. å¹³æ»‘å¾—åˆ° ADX

ADX = (å‰ä¸€ADX * 13 + DX) / 14



# 4å°æ—¶è¶‹åŠ¿åˆ¤æ–­ä»£ç é€»è¾‘ï¼š
```jsx
/**
 * è®¡ç®—ç®€å•ç§»åŠ¨å¹³å‡ (SMA)
 */
function sma(values, period) {
  if (values.length < period) return null;
  const slice = values.slice(-period);
  const sum = slice.reduce((a, b) => a + b, 0);
  return sum / period;
}

/**
 * è®¡ç®—çœŸå®æ³¢åŠ¨èŒƒå›´ (TR)
 */
function trueRange(high, low, prevClose) {
  return Math.max(
    high - low,
    Math.abs(high - prevClose),
    Math.abs(low - prevClose)
  );
}

/**
 * è®¡ç®— ADX(14)
 */
function calculateADX(klines, period = 14) {
  if (klines.length < period + 1) return null;

  let trs = [];
  let dmPlus = [];
  let dmMinus = [];

  for (let i = 1; i < klines.length; i++) {
    const [ , , high, low, close ] = klines[i].map(Number);
    const [ , , prevHigh, prevLow, prevClose ] = klines[i - 1].map(Number);

    const tr = trueRange(high, low, prevClose);
    trs.push(tr);

    const upMove = high - prevHigh;
    const downMove = prevLow - low;

    dmPlus.push(upMove > downMove && upMove > 0 ? upMove : 0);
    dmMinus.push(downMove > upMove && downMove > 0 ? downMove : 0);
  }

  const atr = sma(trs, period);
  const avgDMPlus = sma(dmPlus, period);
  const avgDMMinus = sma(dmMinus, period);

  if (!atr || atr === 0) return null;

  const diPlus = (100 * avgDMPlus) / atr;
  const diMinus = (100 * avgDMMinus) / atr;
  const dx = (100 * Math.abs(diPlus - diMinus)) / (diPlus + diMinus);

  return dx; // ç®€åŒ–ç‰ˆï¼Œå¯æ‰©å±•ä¸ºå¹³æ»‘ADX
}

/**
 * è®¡ç®—å¸ƒæ—å¸¦å¸¦å®½
 */
function bollingerBandwidth(closes, period = 20, k = 2) {
  if (closes.length < period) return null;

  const ma = sma(closes, period);
  const slice = closes.slice(-period);
  const variance = slice.reduce((sum, p) => sum + Math.pow(p - ma, 2), 0) / period;
  const stdDev = Math.sqrt(variance);

  const upper = ma + k * stdDev;
  const lower = ma - k * stdDev;

  return (upper - lower) / ma; // å¸¦å®½ç›¸å¯¹å€¼
}

/**
 * ä¸»è¶‹åŠ¿åˆ¤æ–­é€»è¾‘ (4H)
 */
function getTrend4h(klines) {
  const closes = klines.map(k => parseFloat(k[4]));

  const ma20 = sma(closes, 20);
  const ma50 = sma(closes, 50);
  const ma200 = sma(closes, 200);
  const lastClose = closes[closes.length - 1];

  const adx = calculateADX(klines, 14);
  const bbWidth = bollingerBandwidth(closes, 20);

  // è¿‡æ»¤æ¡ä»¶
  const adxOk = adx && adx > 20;
  const bbOk = bbWidth && bbWidth > 0.05; // ç»éªŒé˜ˆå€¼ï¼Œå¯è°ƒ

  if (ma20 && ma50 && ma200 && adxOk && bbOk) {
    if (ma20 > ma50 && ma50 > ma200 && lastClose > ma20) {
      return "å¤šå¤´";
    }
    if (ma20 < ma50 && ma50 < ma200 && lastClose < ma20) {
      return "ç©ºå¤´";
    }
  }

  return "éœ‡è¡";
}

// ==== ä½¿ç”¨ç¤ºä¾‹ ====
// å‡è®¾ä» Binance FAPI /fapi/v1/klines è·å– 4h æ•°æ®
(async () => {
  const sampleKlines = [
    // [openTime, open, high, low, close, volume, ...]
    [1690000000000, "30000", "30100", "29900", "30050", "120.5"],
    [1690014400000, "30050", "30200", "29950", "30100", "150.8"],
    [1690028800000, "30100", "30250", "30000", "30200", "200.3"],
    // ... è‡³å°‘200æ ¹æ•°æ®
  ];

  const trend = getTrend4h(sampleKlines);
  console.log("4Hè¶‹åŠ¿åˆ¤æ–­:", trend);
})();
```

# å°æ—¶çº§åˆ«è¶‹åŠ¿åŠ å¼ºåˆ¤æ–­ä»£ç é€»è¾‘
```jsx
import fetch from "node-fetch";

// === è·å–Kçº¿æ•°æ® ===
async function fetchKlines(symbol = "BTCUSDT", interval = "1h", limit = 50) {
  const url = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  const response = await fetch(url);
  const data = await response.json();
  return data.map(k => ({
    time: k[0],
    open: parseFloat(k[1]),
    high: parseFloat(k[2]),
    low: parseFloat(k[3]),
    close: parseFloat(k[4]),
    volume: parseFloat(k[5]),
  }));
}

// === è·å–æœªå¹³ä»“åˆçº¦ OI ===
async function fetchOI(symbol = "BTCUSDT") {
  const url = `https://fapi.binance.com/fapi/v1/openInterest?symbol=${symbol}`;
  const data = await fetch(url).then(res => res.json());
  return parseFloat(data.openInterest);
}

// === è·å–èµ„é‡‘è´¹ç‡ ===
async function fetchFundingRate(symbol = "BTCUSDT") {
  const url = `https://fapi.binance.com/fapi/v1/fundingRate?symbol=${symbol}&limit=1`;
  const data = await fetch(url).then(res => res.json());
  return parseFloat(data[0].fundingRate);
}

// === è®¡ç®—VWAP ===
function calculateVWAP(klines) {
  let cumulativePV = 0;
  let cumulativeVolume = 0;
  klines.forEach(k => {
    const typicalPrice = (k.high + k.low + k.close) / 3;
    cumulativePV += typicalPrice * k.volume;
    cumulativeVolume += k.volume;
  });
  return cumulativePV / cumulativeVolume;
}

// === è®¡ç®—çªç ´ç»“æ„ ===
function isBreakout(klines) {
  const lastClose = klines[klines.length - 1].close;
  const last20 = klines.slice(-21, -1); // æœ€è¿‘20æ ¹
  const high20 = Math.max(...last20.map(k => k.high));
  const low20 = Math.min(...last20.map(k => k.low));
  return {
    breakoutLong: lastClose > high20,
    breakoutShort: lastClose < low20
  };
}

// === è®¡ç®—æˆäº¤é‡ç¡®è®¤ ===
function isVolumeConfirmed(klines, multiplier = 1.5) {
  const lastClose = klines[klines.length - 1];
  const avgVol = klines.slice(-21, -1).reduce((a, k) => a + k.volume, 0) / 20;
  return lastClose.volume >= avgVol * multiplier;
}

// === Deltaï¼ˆç®€åŒ–ï¼‰ ===
function isDeltaPositive(klines, threshold = 1.0) {
  // ç”¨é«˜ä½ä»·ä¸æ”¶ç›˜ä»·å·®æ¨¡æ‹Ÿä¸»åŠ¨ä¹°å–å¼ºåº¦
  const last = klines[klines.length - 1];
  const delta = (last.close - last.open); // æ”¶-å¼€ ç®€åŒ–ä»£æ›¿çœŸå®CVD
  return delta > 0; // å¤§äº0 è®¤ä¸ºä¹°æ–¹å ä¼˜
}

// === è®¡ç®—è¶‹åŠ¿å¼ºåº¦æ‰“åˆ† ===
async function calculateTrendScore(symbol, trend) {
  const klines = await fetchKlines(symbol, "1h", 50);

  let score = 0;

  // VWAPæ–¹å‘
  const vwap = calculateVWAP(klines);
  const lastClose = klines[klines.length - 1].close;
  if ((trend === "å¤šå¤´è¶‹åŠ¿" && lastClose > vwap) ||
      (trend === "ç©ºå¤´è¶‹åŠ¿" && lastClose < vwap)) {
    score += 1;
  }

  // çªç ´ç»“æ„
  const breakout = isBreakout(klines);
  if ((trend === "å¤šå¤´è¶‹åŠ¿" && breakout.breakoutLong) ||
      (trend === "ç©ºå¤´è¶‹åŠ¿" && breakout.breakoutShort)) {
    score += 1;
  }

  // æˆäº¤é‡ç¡®è®¤
  if (isVolumeConfirmed(klines)) score += 1;

  // OIç¡®è®¤
  const oi = await fetchOI(symbol);
  // å‡è®¾6hå†…å˜åŒ–Â±2%åˆ¤æ–­
  if (trend === "å¤šå¤´è¶‹åŠ¿" && oi > 1.02 * oi) score += 1;
  if (trend === "ç©ºå¤´è¶‹åŠ¿" && oi < 0.98 * oi) score += 1;

  // èµ„é‡‘è´¹ç‡
  const funding = await fetchFundingRate(symbol);
  if (Math.abs(funding) <= 0.0015) score += 1;

  // Deltaç¡®è®¤
  if ((trend === "å¤šå¤´è¶‹åŠ¿" && isDeltaPositive(klines)) ||
      (trend === "ç©ºå¤´è¶‹åŠ¿" && !isDeltaPositive(klines))) {
    score += 1;
  }

  // æœ€ç»ˆåˆ¤æ–­
  let action = "è§‚æœ›/ä¸åš";
  if (score >= 4) {
    action = trend === "å¤šå¤´è¶‹åŠ¿" ? "åšå¤š" : "åšç©º";
  }

  return {
    symbol,
    trend,
    score,
    action
  };
}

// === ç¤ºä¾‹è¿è¡Œ ===
(async () => {
  const symbol = "BTCUSDT";
  // è¿™é‡Œå‡è®¾ä¹‹å‰è¶‹åŠ¿JSè¿”å›çš„ç»“æœ
  const trend = "å¤šå¤´è¶‹åŠ¿"; // å¯ä»¥æ›¿æ¢æˆä½ ä¹‹å‰è¶‹åŠ¿åˆ¤æ–­çš„è¿”å›å€¼

  const result = await calculateTrendScore(symbol, trend);
  console.log("=== è¶‹åŠ¿å¼ºåº¦æ‰“åˆ† ===");
  console.log("äº¤æ˜“å¯¹:", result.symbol);
  console.log("è¶‹åŠ¿:", result.trend);
  console.log("æ€»åˆ†:", result.score);
  console.log("æ“ä½œå»ºè®®:", result.action);
})();
```
## å°æ—¶çº§åˆ«æ‰“åˆ†è®¡ç®—é€»è¾‘
```jsx
/**
 * 4å°æ—¶çº§åˆ«å¤šå› å­æ‰“åˆ†ç³»ç»Ÿ
 * 
 * VWAP å¿…é¡»æ–¹å‘ä¸€è‡´ï¼Œå¦åˆ™ç›´æ¥è¿”å› 0 åˆ†
 * å…¶ä»–å› å­æ¯æ»¡è¶³ä¸€ä¸ª +1
 * 
 * @param {Object} params
 * @param {string} params.trend4h - 4å°æ—¶è¶‹åŠ¿ ("å¤šå¤´" | "ç©ºå¤´" | "éœ‡è¡")
 * @param {number} params.close - æœ€æ–°æ”¶ç›˜ä»·
 * @param {number} params.vwap - å½“å‰ VWAP å€¼
 * @param {number} params.breakoutLevel - å…³é”®çªç ´ä»·ä½ï¼ˆæ¯”å¦‚20æ ¹4Hé«˜ç‚¹/ä½ç‚¹ï¼‰
 * @param {number} params.volume15m - æœ€æ–°15mæˆäº¤é‡
 * @param {number} params.avgVolume15m - è¿‡å»20æœŸ15må‡é‡
 * @param {number} params.volume1h - æœ€æ–°1hæˆäº¤é‡
 * @param {number} params.avgVolume1h - è¿‡å»20æœŸ1hå‡é‡
 * @param {number} params.oiChange6h - æœ€è¿‘6å°æ—¶OIå˜åŠ¨ç™¾åˆ†æ¯” (å¦‚ 0.025 = +2.5%)
 * @param {number} params.fundingRate - å½“å‰èµ„é‡‘è´¹ç‡ (æ¯8h)
 * @param {number} params.deltaBuy - ä¸»åŠ¨ä¹°ç›˜æˆäº¤é‡
 * @param {number} params.deltaSell - ä¸»åŠ¨å–ç›˜æˆäº¤é‡
 * 
 * @returns {Object} { score, allowLong, allowShort }
 */
function scoreFactors4h({
  trend4h,
  close,
  vwap,
  breakoutLevel,
  volume15m,
  avgVolume15m,
  volume1h,
  avgVolume1h,
  oiChange6h,
  fundingRate,
  deltaBuy,
  deltaSell
}) {
  let score = 0;
  let allowLong = false;
  let allowShort = false;

  // 1. VWAP å¿…é¡»æ–¹å‘ä¸€è‡´
  if (trend4h === "å¤šå¤´" && close <= vwap) return { score: 0, allowLong, allowShort };
  if (trend4h === "ç©ºå¤´" && close >= vwap) return { score: 0, allowLong, allowShort };

  // 2. çªç ´æ¡ä»¶ (4hå…³é”®ä½çªç ´)
  if (trend4h === "å¤šå¤´" && close > breakoutLevel) score++;
  if (trend4h === "ç©ºå¤´" && close < breakoutLevel) score++;

  // 3. æˆäº¤é‡åŒç¡®è®¤ (15m + 1h)
  if (volume15m >= 1.5 * avgVolume15m && volume1h >= 1.2 * avgVolume1h) {
    score++;
  }

  // 4. OIå˜åŒ–
  if (trend4h === "å¤šå¤´" && oiChange6h >= 0.02) score++; // â‰¥+2%
  if (trend4h === "ç©ºå¤´" && oiChange6h <= -0.03) score++; // â‰¤-3%

  // 5. èµ„é‡‘è´¹ç‡åˆç†
  if (fundingRate >= -0.0005 && fundingRate <= 0.0005) {
    score++;
  }

  // 6. Delta/ä¸»åŠ¨ä¹°å–ç›˜ä¸å¹³è¡¡
  if (trend4h === "å¤šå¤´" && deltaBuy >= 1.2 * deltaSell) score++;
  if (trend4h === "ç©ºå¤´" && deltaSell >= 1.2 * deltaBuy) score++;

  // åˆ¤æ–­æ˜¯å¦å…è®¸å¼€ä»“
  if (trend4h === "å¤šå¤´" && score >= 3) allowLong = true;
  if (trend4h === "ç©ºå¤´" && score >= 3) allowShort = true;

  return { score, allowLong, allowShort };
}

// ==== ç¤ºä¾‹è°ƒç”¨ ====
const result = scoreFactors4h({
  trend4h: "å¤šå¤´",
  close: 102,
  vwap: 101,
  breakoutLevel: 100,
  volume15m: 1500,
  avgVolume15m: 900,
  volume1h: 6000,
  avgVolume1h: 4500,
  oiChange6h: 0.025, // +2.5%
  fundingRate: 0.0002, // 0.02%/8h
  deltaBuy: 1200,
  deltaSell: 800
});

console.log(result);
/**
 è¾“å‡ºç¤ºä¾‹:
 {
   score: 5,
   allowLong: true,
   allowShort: false
 }
 */
```
## deltaè®¡ç®—é€»è¾‘
```jsx
// deltaOrderflow.js
const WebSocket = require("ws");

class DeltaOrderflow {
  constructor(symbol = "btcusdt") {
    this.symbol = symbol.toLowerCase();
    this.deltaBuy = 0;
    this.deltaSell = 0;
    this.orderbook = { bids: [], asks: [] };

    // è¿æ¥ aggTrade WebSocket
    this.wsTrade = new WebSocket(
      `wss://fstream.binance.com/ws/${this.symbol}@aggTrade`
    );

    this.wsTrade.on("message", (msg) => {
      const data = JSON.parse(msg);
      this.handleAggTrade(data);
    });

    // è¿æ¥ orderbook WebSocket
    this.wsDepth = new WebSocket(
      `wss://fstream.binance.com/ws/${this.symbol}@depth20@100ms`
    );

    this.wsDepth.on("message", (msg) => {
      const data = JSON.parse(msg);
      this.handleDepth(data);
    });
  }

  // å¤„ç†é€ç¬”æˆäº¤
  handleAggTrade(trade) {
    const qty = parseFloat(trade.q);
    if (trade.m === false) {
      // ä¹°æ–¹ä¸»åŠ¨ï¼ˆtaker æ˜¯ä¹°ï¼‰
      this.deltaBuy += qty;
    } else {
      // å–æ–¹ä¸»åŠ¨ï¼ˆtaker æ˜¯å–ï¼‰
      this.deltaSell += qty;
    }
  }

  // å¤„ç†è®¢å•ç°¿å¿«ç…§
  handleDepth(data) {
    this.orderbook = {
      bids: data.b.map(([price, qty]) => ({
        price: parseFloat(price),
        qty: parseFloat(qty),
      })),
      asks: data.a.map(([price, qty]) => ({
        price: parseFloat(price),
        qty: parseFloat(qty),
      })),
    };
  }

  // è·å–ä¹°å–ç›˜ä¸å¹³è¡¡ (ä¸»åŠ¨æˆäº¤)
  getDeltaImbalance() {
    if (this.deltaSell === 0) return Infinity;
    return this.deltaBuy / this.deltaSell;
  }

  // è·å–è®¢å•ç°¿æŒ‚å•ä¸å¹³è¡¡
  getOrderbookImbalance() {
    const bidSum = this.orderbook.bids.reduce((s, b) => s + b.qty, 0);
    const askSum = this.orderbook.asks.reduce((s, a) => s + a.qty, 0);
    if (askSum === 0) return Infinity;
    return bidSum / askSum;
  }

  // å®šæœŸé‡ç½®ï¼ˆé¿å…æ•°æ®æ— é™ç´¯ç§¯ï¼‰
  resetDelta() {
    this.deltaBuy = 0;
    this.deltaSell = 0;
  }
}

// ==== ä½¿ç”¨ç¤ºä¾‹ ====
const deltaFlow = new DeltaOrderflow("btcusdt");

// æ¯ 10 ç§’è¾“å‡ºä¸€æ¬¡æ•°æ®
setInterval(() => {
  console.log("ä¸»åŠ¨ä¹°å–ç›˜ç»Ÿè®¡:");
  console.log("deltaBuy:", deltaFlow.deltaBuy.toFixed(2));
  console.log("deltaSell:", deltaFlow.deltaSell.toFixed(2));
  console.log("æˆäº¤ä¸å¹³è¡¡ (Buy/Sell):", deltaFlow.getDeltaImbalance().toFixed(2));
  console.log("æŒ‚å•ä¸å¹³è¡¡ (Bid/Ask):", deltaFlow.getOrderbookImbalance().toFixed(2));
  console.log("----");

  // é‡ç½®ï¼Œé¿å…æ— é™ç´¯ç§¯
  deltaFlow.resetDelta();
}, 10000);
```

# 15åˆ†é’Ÿçº§åˆ«å…¥åœºåˆ¤æ–­ä»£ç é€»è¾‘
```jsx
/**
 * 15åˆ†é’Ÿçº§åˆ«å…¥åœºä¿¡å·åˆ¤æ–­
 * @param {Object} params
 * @param {string} params.dailyTrend - æ—¥çº¿è¶‹åŠ¿ç»“æœ ("å¤šå¤´" | "ç©ºå¤´" | "éœ‡è¡")
 * @param {string} params.hourlyConfirm - å°æ—¶çº§åˆ«ç¡®è®¤ç»“æœ ("çœ‹å¤š" | "çœ‹ç©º" | "æ— ä¿¡å·")
 * @param {Array} params.klines15m - 15m Kçº¿æ•°ç»„ [{open, high, low, close, volume}]
 * @param {Array} params.ema20 - EMA20 æ•°ç»„
 * @param {Array} params.ema50 - EMA50 æ•°ç»„
 * @param {number} params.atr14 - æœ€æ–° ATR14 å€¼
 * @param {number} params.oiChange6h - æœ€è¿‘6h OI å˜åŠ¨ç™¾åˆ†æ¯”ï¼ˆå¦‚ +0.025 = +2.5%ï¼‰
 */
function calculateEntry15m({ 
  dailyTrend, 
  hourlyConfirm, 
  klines15m, 
  ema20, 
  ema50, 
  atr14, 
  oiChange6h 
}) {
  const last = klines15m[klines15m.length - 1];
  const prev = klines15m[klines15m.length - 2]; // setup candle
  const lastClose = last.close;
  const lastHigh = last.high;
  const lastLow = last.low;
  const setupHigh = prev.high;
  const setupLow = prev.low;

  let entrySignal = null;
  let stopLoss = null;
  let takeProfit = null;
  let stopLossPct = null;
  let mode = null;

  // === è¿‡æ»¤æ¡ä»¶ ===
  // å¿…é¡»æ—¥çº¿è¶‹åŠ¿å’Œå°æ—¶çº§ç¡®è®¤ä¸€è‡´ï¼Œæ‰è€ƒè™‘å…¥åœº
  if ((dailyTrend === "å¤šå¤´" && hourlyConfirm !== "çœ‹å¤š") ||
      (dailyTrend === "ç©ºå¤´" && hourlyConfirm !== "çœ‹ç©º")) {
    return { entrySignal, stopLoss, takeProfit, stopLossPct, mode };
  }

  // === å¤šå¤´æ¨¡å¼ ===
  if (dailyTrend === "å¤šå¤´" && oiChange6h >= 0.02) {
    const supportLevel = Math.min(
      ema20[ema20.length - 1],
      ema50[ema50.length - 1]
    );

    // å›è¸© EMA20/50 ä¸Šæ–¹å¹¶çªç ´ setup candle é«˜ç‚¹
    if (lastClose >= supportLevel && lastHigh > setupHigh) {
      entrySignal = lastHigh;
      stopLoss = Math.min(setupLow, lastClose - 1.2 * atr14);
      takeProfit = entrySignal + 2 * (entrySignal - stopLoss);
      stopLossPct = ((entrySignal - stopLoss) / entrySignal) * 100;
      mode = "å¤šå¤´å›è¸©çªç ´";
    }
  }

  // === ç©ºå¤´æ¨¡å¼ ===
  if (dailyTrend === "ç©ºå¤´" && oiChange6h <= -0.02) {
    const resistanceLevel = Math.max(
      ema20[ema20.length - 1],
      ema50[ema50.length - 1]
    );

    // åæŠ½ EMA20/50 ä¸‹æ–¹å¹¶è·Œç ´ setup candle ä½ç‚¹
    if (lastClose <= resistanceLevel && lastLow < setupLow) {
      entrySignal = lastLow;
      stopLoss = Math.max(setupHigh, lastClose + 1.2 * atr14);
      takeProfit = entrySignal - 2 * (stopLoss - entrySignal);
      stopLossPct = ((stopLoss - entrySignal) / entrySignal) * 100;
      mode = "ç©ºå¤´åæŠ½ç ´ä½";
    }
  }

  return { entrySignal, stopLoss, takeProfit, stopLossPct, mode };
}

// ==== ç¤ºä¾‹è°ƒç”¨ ====
const klines15m = [
  {open: 100, high: 102, low: 99, close: 101, volume: 10},
  {open: 101, high: 103, low: 100, close: 102, volume: 12},
  {open: 102, high: 104, low: 101, close: 103, volume: 15},
];

const ema20 = [100, 101, 102];
const ema50 = [99, 100, 101];
const atr14 = 1.5;

const result = calculateEntry15m({
  dailyTrend: "å¤šå¤´",
  hourlyConfirm: "çœ‹å¤š",
  klines15m,
  ema20,
  ema50,
  atr14,
  oiChange6h: 0.03  // OI +3%
});

console.log(result);

/**
è¾“å‡ºç¤ºä¾‹:
{
  entrySignal: 103,
  stopLoss: 100,
  takeProfit: 106,
  stopLossPct: 2.91,
  mode: "å¤šå¤´å›è¸©çªç ´"
}
*/
```

# æ­¢æŸå‡ºåœºé€»è¾‘
```jsx
/**
 * å‡ºåœºåˆ¤æ–­ï¼ˆåŒ…å«æ—¶é—´æ­¢æŸï¼‰
 * @param {Object} params
 * @param {string} params.position - "long" æˆ– "short"
 * @param {number} params.entryPrice - å…¥åœºä»·æ ¼
 * @param {Object} params.setupCandle - å…¥åœºKçº¿ { high, low, close }
 * @param {number} params.atr14 - ATR(14) æœ€æ–°å€¼
 * @param {number} params.currentPrice - å½“å‰ä»·æ ¼
 * @param {number} params.score1h - 1H å¤šå› å­æ‰“åˆ†
 * @param {string} params.trend4h - å½“å‰4Hè¶‹åŠ¿ ("å¤šå¤´" | "ç©ºå¤´" | "éœ‡è¡")
 * @param {number} params.deltaBuy - å½“å‰ä¸»åŠ¨ä¹°ç›˜é‡
 * @param {number} params.deltaSell - å½“å‰ä¸»åŠ¨å–ç›˜é‡
 * @param {number} params.ema20 - EMA20 å½“å‰å€¼
 * @param {number} params.ema50 - EMA50 å½“å‰å€¼
 * @param {number} params.prevHigh - è¿‘æœŸå‰é«˜
 * @param {number} params.prevLow - è¿‘æœŸå‰ä½
 * @param {number} params.timeInPosition - å·²æŒä»“æ—¶é—´ï¼Œå•ä½ï¼š15m Kçº¿æ•°
 * @param {number} params.maxTimeInPosition - æœ€å¤§å…è®¸æŒä»“æ—¶é—´ï¼Œå•ä½ï¼š15m Kçº¿æ•°
 * @returns {Object} { exit: boolean, reason: string, exitPrice: number }
 */
function checkExit(params) {
  const {
    position,
    entryPrice,
    setupCandle,
    atr14,
    currentPrice,
    score1h,
    trend4h,
    deltaBuy,
    deltaSell,
    ema20,
    ema50,
    prevHigh,
    prevLow,
    timeInPosition,
    maxTimeInPosition
  } = params;

  let stopLoss, takeProfit;

  // æ­¢æŸè®¡ç®—
  if (position === "long") {
    stopLoss = Math.min(setupCandle.low, entryPrice - 1.2 * atr14);
    takeProfit = entryPrice + 2 * (entryPrice - stopLoss);
  } else {
    stopLoss = Math.max(setupCandle.high, entryPrice + 1.2 * atr14);
    takeProfit = entryPrice - 2 * (stopLoss - entryPrice);
  }

  // 1ï¸âƒ£ æ­¢æŸè§¦å‘
  if ((position === "long" && currentPrice <= stopLoss) ||
      (position === "short" && currentPrice >= stopLoss)) {
    return { exit: true, reason: "æ­¢æŸè§¦å‘", exitPrice: stopLoss };
  }

  // 2ï¸âƒ£ æ­¢ç›ˆè§¦å‘
  if ((position === "long" && currentPrice >= takeProfit) ||
      (position === "short" && currentPrice <= takeProfit)) {
    return { exit: true, reason: "æ­¢ç›ˆè§¦å‘", exitPrice: takeProfit };
  }

  // 3ï¸âƒ£ è¶‹åŠ¿åè½¬
  if ((position === "long" && (trend4h !== "å¤šå¤´" || score1h < 3)) ||
      (position === "short" && (trend4h !== "ç©ºå¤´" || score1h < 3))) {
    return { exit: true, reason: "è¶‹åŠ¿æˆ–å¤šå› å­åè½¬", exitPrice: currentPrice };
  }

  // 4ï¸âƒ£ Delta / ä¹°å–ç›˜å‡å¼±
  if ((position === "long" && deltaBuy / (deltaSell || 1) < 1.1) ||
      (position === "short" && deltaSell / (deltaBuy || 1) < 1.1)) {
    return { exit: true, reason: "Delta / ä¸»åŠ¨ä¹°å–ç›˜å‡å¼±", exitPrice: currentPrice };
  }

  // 5ï¸âƒ£ ä»·æ ¼è·Œç ´å…³é”®æ”¯æ’‘ / çªç ´å…³é”®é˜»åŠ›
  if ((position === "long" && (currentPrice < ema20 || currentPrice < ema50 || currentPrice < prevLow)) ||
      (position === "short" && (currentPrice > ema20 || currentPrice > ema50 || currentPrice > prevHigh))) {
    return { exit: true, reason: "è·Œç ´æ”¯æ’‘æˆ–çªç ´é˜»åŠ›", exitPrice: currentPrice };
  }

  // 6ï¸âƒ£ æ—¶é—´æ­¢æŸ
  if (timeInPosition >= maxTimeInPosition) {
    return { exit: true, reason: "è¶…æ—¶æ­¢æŸ", exitPrice: currentPrice };
  }

  // å¦åˆ™ç»§ç»­æŒä»“
  return { exit: false, reason: "", exitPrice: null };
}

// ==== ä½¿ç”¨ç¤ºä¾‹ ====
const exitSignal = checkExit({
  position: "long",
  entryPrice: 100,
  setupCandle: { high: 102, low: 99, close: 101 },
  atr14: 1.5,
  currentPrice: 101.2,
  score1h: 4,
  trend4h: "å¤šå¤´",
  deltaBuy: 1200,
  deltaSell: 900,
  ema20: 101.5,
  ema50: 100.8,
  prevHigh: 103,
  prevLow: 99.5,
  timeInPosition: 13,   // å·²æŒä»“13æ ¹15m Kçº¿
  maxTimeInPosition: 12 // æœ€å¤§å…è®¸12æ ¹15m Kçº¿
});

console.log(exitSignal);
/**
 è¾“å‡ºç¤ºä¾‹:
 {
   exit: true,
   reason: "è¶…æ—¶æ­¢æŸ",
   exitPrice: 101.2
 }
*/
```

# æ•°æ®åˆ·æ–°é¢‘ç‡ï¼š
| **æ—¶é—´æ¡†æ¶** | **åˆ·æ–°é¢‘ç‡** | **ç†ç”±** |
| --- | --- | --- |
| 4H è¶‹åŠ¿ | æ¯ 1 å°æ—¶ | è¶³å¤Ÿç¨³å®šï¼Œå‡å°‘APIå‹åŠ› |
| 1H æ‰“åˆ† | æ¯ 5 åˆ†é’Ÿ | æå‰æ•æ‰çªç ´å’ŒVWAPåç§» |
| 15m å…¥åœº | æ¯ 1~3 åˆ†é’Ÿ | ç²¾ç¡®æ•æ‰setupçªç ´ |
| Delta/ç›˜å£ | å®æ—¶ï¼ˆWebSocketï¼‰ | å¦åˆ™å¤±å»æ„ä¹‰ |


é‡‡ç”¨é€ä»“æ¨¡å¼ï¼Œæ­¢æŸè·ç¦»ï¼Œæœ€å¤§æ æ†æ•°å’Œæœ€å°ä¿è¯é‡‘æ•°è®¡ç®—æ–¹å¼ï¼š
- æ­¢æŸè·ç¦»X%ï¼š
  - å¤šå¤´ï¼š(entrySignal - stopLoss) / entrySignal
  - ç©ºå¤´ï¼š(stopLoss - entrySignal) / entrySignal
- æœ€å¤§æŸå¤±é‡‘é¢(U)ï¼šç”¨æˆ·é€‰æ‹©çš„å•æ¬¡äº¤æ˜“æœ€å¤§æŸå¤±é‡‘é¢
    - æœ€å¤§æ æ†æ•°Yï¼š1/(X%+0.5%) æ•°å€¼å‘ä¸‹å–æ•´ã€‚
    - ä¿è¯é‡‘Zï¼šM/(Y*X%) æ•°å€¼å‘ä¸Šå–æ•´ã€‚