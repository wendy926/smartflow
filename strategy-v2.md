# äº¤æ˜“ç­–ç•¥æ‰§è¡Œ

æ—¢æœ‰é€»è¾‘ä¸¥è°¨æ€§ï¼Œåˆèƒ½å¢åŠ å…¥åœºæœºä¼šçš„ç‰ˆæœ¬

# **ğŸ”¹ æ”¹è¿›ç‰ˆå¤šå‘¨æœŸäº¤æ˜“ç­–ç•¥**

**æ­¥éª¤ 1ï¼šå¤§å‘¨æœŸè¶‹åŠ¿è¿‡æ»¤ï¼ˆæ—¥çº¿-å¤©çº§åˆ«ï¼‰**

ç›®çš„æ˜¯åªåšè¶‹åŠ¿æ–¹å‘çš„å•å­ï¼Œé¿å…é€†åŠ¿äº¤æ˜“ã€‚åªè¦ä»·æ ¼å’ŒçŸ­ä¸­å‡çº¿ä¸€è‡´ï¼ŒåŒæ—¶è¶‹åŠ¿å¼ºåº¦å’Œæ³¢åŠ¨ç‡æ‰©å¼ ç¡®è®¤ï¼Œå°±è®¤ä¸ºæœ‰æ–¹å‘æ€§è¡Œæƒ…ã€‚

- å¤šå¤´è¶‹åŠ¿ï¼š
    - ä»·æ ¼åœ¨ MA200 ä¸Šæ–¹
    - MA20 > MA50
    - ADX(14) > 20ï¼ˆè¯´æ˜è¶‹åŠ¿å¼ºåº¦è¶³å¤Ÿï¼‰
    - å¸ƒæ—å¸¦å¼€å£æ‰©å¼ ï¼šå¸ƒæ—å¸¦ä¸Šè½¨å’Œä¸‹è½¨é—´è·æœ€è¿‘ 20 æ ¹ K çº¿é€æ¸æ‰©å¤§ï¼Œä»£è¡¨æ³¢åŠ¨ç‡å¢åŠ ï¼Œè¶‹åŠ¿åœ¨èµ°å¼ºã€‚
- ç©ºå¤´è¶‹åŠ¿ï¼š
    - ä»·æ ¼åœ¨ MA200 ä¸‹æ–¹
    - MA20 < MA50
    - ADX(14) > 20
    - å¸ƒæ—å¸¦å¼€å£æ‰©å¼ ï¼šå¸ƒæ—å¸¦ä¸Šè½¨å’Œä¸‹è½¨é—´è·æœ€è¿‘ 20 æ ¹ K çº¿é€æ¸æ‰©å¤§ï¼Œä»£è¡¨æ³¢åŠ¨ç‡å¢åŠ ï¼Œè¶‹åŠ¿åœ¨èµ°å¼ºã€‚
  
  è¶‹åŠ¿ä¿¡å·ç¡®è®¤æ¡ä»¶ï¼š
1. è¶‹åŠ¿åŸºç¡€æ¡ä»¶ï¼ˆå¿…é¡»æ»¡è¶³ï¼‰
    - ä»·æ ¼ç›¸å¯¹ MA200 çš„ä½ç½®ï¼ˆåœ¨ä¸Šæ–¹åšå¤š / ä¸‹æ–¹åšç©ºï¼‰
    - MA20 / MA50 é¡ºåºä¸è¶‹åŠ¿æ–¹å‘ä¸€è‡´
2. è¶‹åŠ¿å¼ºåº¦ & æ³¢åŠ¨ç‡æ¡ä»¶ï¼ˆæ‹©ä¸€å³å¯ï¼‰
    - ADX(14) > 20 æˆ–
    - å¸ƒæ—å¸¦å¼€å£æ‰©å¼ 

**æ­¥éª¤ 2ï¼šä¸­å‘¨æœŸç¡®è®¤ï¼ˆ1Hï¼‰ â†’ å¤šå› å­æ‰“åˆ†ä½“ç³»**

æˆ‘ä»¬ä¸è¦æ±‚æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³ï¼Œè€Œæ˜¯ç»™æ¯ä¸ªæ¡ä»¶æ‰“åˆ†ï¼Œåªè¦æ€»åˆ†è¾¾åˆ° 2 åˆ†åŠä»¥ä¸Š å°±å…è®¸è¿›åœºã€‚

**æ‰“åˆ†ä½“ç³»ï¼ˆä»¥ä¸‹æ¯ä¸ªæ¡ä»¶æ»¡è¶³éƒ½ä¸º1 åˆ†ï¼Œæ»¡è¶³ä¸€ä¸ªåˆ™åŠ 1åˆ†ï¼‰ï¼š**

1. VWAPæ–¹å‘ä¸€è‡´ï¼šæ”¶ç›˜ä»·åœ¨ VWAP ä¸Šæ–¹ï¼ˆåšå¤šï¼‰/ä¸‹æ–¹ï¼ˆåšç©ºï¼‰ã€‚
2. çªç ´ç»“æ„ï¼šæ”¶ç›˜ä»·çªç ´æœ€è¿‘ 20 æ ¹ K çº¿çš„æœ€é«˜ç‚¹/æœ€ä½ç‚¹ã€‚
3. æˆäº¤é‡ç¡®è®¤ï¼šå½“å‰ K çº¿æˆäº¤é‡ â‰¥ 1.5 Ã— 20æœŸå¹³å‡æˆäº¤é‡ã€‚
4. OIç¡®è®¤ï¼šæœªå¹³ä»“åˆçº¦ OI åœ¨ 6h å†…ä¸Šæ¶¨ â‰¥ +2%ï¼ˆåšå¤šï¼‰/ä¸‹é™ â‰¥ -2%ï¼ˆåšç©ºï¼‰ã€‚
5. èµ„é‡‘è´¹ç‡ï¼šèµ„é‡‘è´¹ç‡ â‰¤ 0.15%/8hã€‚
6. Deltaç¡®è®¤ï¼šä¹°å–ç›˜ä¸å¹³è¡¡ï¼ˆè§£é‡Šè§ä¸‹ï¼‰ã€‚

Deltaç¡®è®¤çš„åˆ¤æ–­é€»è¾‘è¯´æ˜ï¼š

- Deltaï¼ˆå‡€ä¸»åŠ¨ä¹°å–é‡ï¼‰ = ä¸»åŠ¨ä¹°å•æˆäº¤é‡ - ä¸»åŠ¨å–å•æˆäº¤é‡ã€‚
- å¦‚æœ Delta åœ¨çªç ´æ–¹å‘æ˜¾è‘—æ”¾å¤§ï¼ˆå¦‚çªç ´æ—¶ 15m Delta > è¿‡å» 20 æ ¹å¹³å‡ Delta çš„ 2 å€ï¼‰ï¼Œè¯´æ˜æ˜¯çœŸå®èµ„é‡‘æ¨åŠ¨ï¼Œè€Œä¸æ˜¯å‡çªç ´ã€‚
- äº¤æ˜“æ‰€å±‚é¢ï¼šçœ‹ CVDï¼ˆCumulative Volume Delta ç´¯ç§¯ä¹°å–ç›˜å·®ï¼‰ã€‚CVD å‘ä¸Šå€¾æ–œ â†’ ä¹°æ–¹ä¸»åŠ¨ï¼Œå‘ä¸‹å€¾æ–œ â†’ å–æ–¹ä¸»åŠ¨ã€‚

**æ ¹æ®æ‰“åˆ†ä½“ç³»å°æ—¶çº§ä¿¡å·å¤§å°åˆ¤æ–­çš„æ‰§è¡Œè§„åˆ™ï¼š**

- å¾—åˆ† â‰¥ 2 åˆ† â†’ å¯ä»¥è¿›å…¥å°å‘¨æœŸè§‚å¯Ÿå…¥åœºæœºä¼šã€‚
- å¾—åˆ† â‰¥ 4 åˆ† â†’ ä¼˜å…ˆçº§æœ€é«˜ï¼ˆå¼ºä¿¡å·ï¼Œå…è®¸åŠ ä»“ï¼‰ã€‚

**æ­¥éª¤ 3ï¼šå°å‘¨æœŸæ‰§è¡Œï¼ˆ15mï¼‰ â†’ å…¥åœºä¸é£æ§**

è¦æ±‚ï¼šä¸¤ç§å…¥åœºæ¨¡å¼åŒæ—¶æ‰§è¡Œï¼Œé¿å…é”™è¿‡æœºä¼šã€‚

**æ¨¡å¼ Aï¼šå›è¸©ç¡®è®¤æ¨¡å¼ï¼ˆèƒœç‡é«˜ï¼‰**

- ç­‰ä»·æ ¼å›è¸©åˆ° EMA20/50 æˆ–å‰é«˜/å‰ä½æ”¯æ’‘ä½ã€‚
- å›è¸©æ—¶æˆäº¤é‡ç¼©å°ï¼Œä»·æ ¼ä¸æœ‰æ•ˆè·Œç ´æ”¯æ’‘ã€‚
- ä¸‹ä¸€æ ¹ K çº¿çªç ´ setup candle çš„é«˜ç‚¹ï¼ˆåšå¤šï¼‰/ä½ç‚¹ï¼ˆåšç©ºï¼‰ â†’ å…¥åœºã€‚

**æ¨¡å¼ Bï¼šåŠ¨èƒ½çªç ´æ¨¡å¼ï¼ˆæœºä¼šå¤šï¼‰**

- å½“ä»·æ ¼çªç ´ setup candle çš„é«˜ç‚¹/ä½ç‚¹æ—¶ï¼Œå¦‚æœ 15m æˆäº¤é‡ & OI åŒæ­¥æ”¾å¤§ï¼Œç›´æ¥è¿½å•å…¥åœºï¼Œä¸ç­‰å›è¸©ã€‚

æ­¢æŸæ­¢ç›ˆè®¡ç®—é€»è¾‘ï¼š

ğŸ‘‰ æ­¢æŸï¼š

- è®¾ç½®åœ¨ setup candle çš„å¦ä¸€ç«¯ æˆ– 1.2 Ã— ATR(14)ï¼Œå–æ›´è¿œçš„ä½ç½®ã€‚

ğŸ‘‰ æ­¢ç›ˆï¼š

- ç¬¬ä¸€ç›®æ ‡ï¼š1.5R å¹³æ‰ 50% ä»“ä½ã€‚
- ç¬¬äºŒç›®æ ‡ï¼šå‰©ä½™ä»“ä½ç”¨ è¿½è¸ªæ­¢æŸï¼ˆå¦‚è·Ÿéš 15m EMA20 / å‰ä¸€å°æ—¶ä½ç‚¹ï¼‰ç›´åˆ°è¢«åŠ¨å‡ºåœºã€‚

# **ğŸ”¹ æ‰§è¡Œæµç¨‹ç®€è¿°**

1. çœ‹å¤§å‘¨æœŸï¼ˆ1Dï¼‰ï¼š
    - ç¡®è®¤è¶‹åŠ¿æ–¹å‘ï¼ˆä»·æ ¼ vs MA200 + MA20/50 é¡ºåº + ADX>20 + å¸ƒæ—å¸¦å¼€å£æ‰©å¼ ï¼‰ã€‚
    - ç¡®å®šåªåšå¤š or åªåšç©ºã€‚
2. çœ‹ä¸­å‘¨æœŸï¼ˆ1Hï¼‰ï¼š
    - ä¾æ¬¡æ£€æŸ¥ 6 ä¸ªæ¡ä»¶ï¼ˆVWAP / çªç ´ / æˆäº¤é‡ / OI / èµ„é‡‘è´¹ç‡ / Deltaï¼‰ã€‚
    - æ¯æ»¡è¶³ä¸€ä¸ª +1 åˆ†ï¼Œâ‰¥2 åˆ†æ‰è¿›å…¥ 15m è§‚å¯Ÿã€‚
3. çœ‹å°å‘¨æœŸï¼ˆ15mï¼‰ï¼š
    - å¦‚æœè¡Œæƒ…ç»™å›è¸©ï¼ŒæŒ‰ å›è¸©æ¨¡å¼ å…¥åœºã€‚
    - å¦‚æœçªç ´æ—¶ä¼´éšæˆäº¤é‡ & OI æ”¾å¤§ï¼ŒæŒ‰ åŠ¨èƒ½æ¨¡å¼ è¿½å•ã€‚
4. é£é™©æ§åˆ¶ï¼š
    - æ­¢æŸ = setup candle å¦ä¸€ç«¯ æˆ– ATR Ã— 1.2ï¼Œå–æ›´è¿œã€‚
    - æ­¢ç›ˆ = åˆ†æ‰¹ï¼š1.5R å¹³ä¸€åŠï¼Œå‰©ä½™è·Ÿè¸ªæ­¢æŸã€‚

**ADX(14) çš„è®¡ç®—é€»è¾‘**

åŸºäº Kçº¿æ•°æ®è‡ªå·±ç®—ï¼š/fapi/v1/klinesï¼ˆè·å– high, low, closeï¼‰

1. è®¡ç®— True Range (TR)

TR = max(high - low, abs(high - previous_close), abs(low - previous_close))

2. è®¡ç®—æ–¹å‘ç§»åŠ¨ DM+ / DM-

DM+ = high - previous_high (è‹¥ >0 ä¸” > (previous_low - low)ï¼Œå¦åˆ™ 0)

DM- = previous_low - low (è‹¥ >0 ä¸” > (high - previous_high)ï¼Œå¦åˆ™ 0)

3. å¹³æ»‘å¤„ç† (14 å‘¨æœŸ)
ç”¨ Wilderâ€™s smoothingï¼ˆç±»ä¼¼EMAï¼‰ï¼š

TR14 = TR14_prev - (TR14_prev / 14) + TR

DM+14 = DM+14_prev - (DM+14_prev / 14) + DM+

DM-14 = DM-14_prev - (DM-14_prev / 14) + DM-

4. è®¡ç®—æ–¹å‘æŒ‡æ ‡ DI+ / DI-

DI+ = 100 * (DM+14 / TR14)

DI- = 100 * (DM-14 / TR14)

5. è®¡ç®— DX

DX = 100 * abs(DI+ - DI-) / (DI+ + DI-)

6. å¹³æ»‘å¾—åˆ° ADX

ADX = (å‰ä¸€ADX * 13 + DX) / 14

# å¤©çº§è¶‹åŠ¿åˆ¤æ–­ä»£ç é€»è¾‘ï¼š
```jsx
// è®¡ç®—å¸ƒæ—å¸¦å¸¦å®½åºåˆ— (BBW) å¹¶åˆ¤æ–­æ˜¯å¦åœ¨æ‰©å¼ 
function calculateBBW(closes, period = 20, k = 2) {
  if (closes.length < period) {
    throw new Error("æ•°æ®é•¿åº¦ä¸è¶³ï¼Œè‡³å°‘éœ€è¦ç­‰äº period çš„Kçº¿æ•°æ®");
  }

  let bbw = [];

  for (let i = period - 1; i < closes.length; i++) {
    // å–æœ€è¿‘ N æ ¹æ”¶ç›˜ä»·
    const slice = closes.slice(i - period + 1, i + 1);

    // è®¡ç®—å‡å€¼ (ä¸­è½¨ MB)
    const mean = slice.reduce((a, b) => a + b, 0) / period;

    // è®¡ç®—æ ‡å‡†å·® Ïƒ
    const variance = slice.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / period;
    const stdDev = Math.sqrt(variance);

    // ä¸Šä¸‹è½¨
    const upper = mean + k * stdDev;
    const lower = mean - k * stdDev;

    // å¸¦å®½ (BBW)
    const bbwValue = (upper - lower) / mean;
    bbw.push(bbwValue);
  }

  return bbw;
}

// åˆ¤æ–­å¸ƒæ—å¸¦æ˜¯å¦å¤„äºæ‰©å¼ çŠ¶æ€
function isBBWExpanding(closes, period = 20, k = 2) {
  const bbw = calculateBBW(closes, period, k);

  // æœ€è¿‘ä¸¤ä¸ªBBWå€¼
  const n = bbw.length;
  if (n < 2) return false;

  // åˆ¤æ–­æœ€æ–°BBWæ˜¯å¦å¤§äºå‰ä¸€ä¸ªBBW
  return bbw[n - 1] > bbw[n - 2];
}

// ==== ç¤ºä¾‹ ====
// å‡è®¾ä½ ä» Binance Kçº¿æ¥å£æ‹¿åˆ°æ”¶ç›˜ä»·æ•°ç»„
const closes = [100, 102, 101, 103, 104, 106, 105, 107, 108, 110, 111, 112, 113, 115, 116, 118, 120, 121, 119, 122, 124];

console.log("BBWåºåˆ—:", calculateBBW(closes));
console.log("å½“å‰æ˜¯å¦æ‰©å¼ :", isBBWExpanding(closes));
```

# å°æ—¶çº§åˆ«è¶‹åŠ¿åŠ å¼ºåˆ¤æ–­ä»£ç é€»è¾‘
```jsx
import fetch from "node-fetch";

// === è·å–Kçº¿æ•°æ® ===
async function fetchKlines(symbol = "BTCUSDT", interval = "1h", limit = 50) {
  const url = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  const response = await fetch(url);
  const data = await response.json();
  return data.map(k => ({
    time: k[0],
    open: parseFloat(k[1]),
    high: parseFloat(k[2]),
    low: parseFloat(k[3]),
    close: parseFloat(k[4]),
    volume: parseFloat(k[5]),
  }));
}

// === è·å–æœªå¹³ä»“åˆçº¦ OI ===
async function fetchOI(symbol = "BTCUSDT") {
  const url = `https://fapi.binance.com/fapi/v1/openInterest?symbol=${symbol}`;
  const data = await fetch(url).then(res => res.json());
  return parseFloat(data.openInterest);
}

// === è·å–èµ„é‡‘è´¹ç‡ ===
async function fetchFundingRate(symbol = "BTCUSDT") {
  const url = `https://fapi.binance.com/fapi/v1/fundingRate?symbol=${symbol}&limit=1`;
  const data = await fetch(url).then(res => res.json());
  return parseFloat(data[0].fundingRate);
}

// === è®¡ç®—VWAP ===
function calculateVWAP(klines) {
  let cumulativePV = 0;
  let cumulativeVolume = 0;
  klines.forEach(k => {
    const typicalPrice = (k.high + k.low + k.close) / 3;
    cumulativePV += typicalPrice * k.volume;
    cumulativeVolume += k.volume;
  });
  return cumulativePV / cumulativeVolume;
}

// === è®¡ç®—çªç ´ç»“æ„ ===
function isBreakout(klines) {
  const lastClose = klines[klines.length - 1].close;
  const last20 = klines.slice(-21, -1); // æœ€è¿‘20æ ¹
  const high20 = Math.max(...last20.map(k => k.high));
  const low20 = Math.min(...last20.map(k => k.low));
  return {
    breakoutLong: lastClose > high20,
    breakoutShort: lastClose < low20
  };
}

// === è®¡ç®—æˆäº¤é‡ç¡®è®¤ ===
function isVolumeConfirmed(klines, multiplier = 1.5) {
  const lastClose = klines[klines.length - 1];
  const avgVol = klines.slice(-21, -1).reduce((a, k) => a + k.volume, 0) / 20;
  return lastClose.volume >= avgVol * multiplier;
}

// === Deltaï¼ˆç®€åŒ–ï¼‰ ===
function isDeltaPositive(klines, threshold = 1.0) {
  // ç”¨é«˜ä½ä»·ä¸æ”¶ç›˜ä»·å·®æ¨¡æ‹Ÿä¸»åŠ¨ä¹°å–å¼ºåº¦
  const last = klines[klines.length - 1];
  const delta = (last.close - last.open); // æ”¶-å¼€ ç®€åŒ–ä»£æ›¿çœŸå®CVD
  return delta > 0; // å¤§äº0 è®¤ä¸ºä¹°æ–¹å ä¼˜
}

// === è®¡ç®—è¶‹åŠ¿å¼ºåº¦æ‰“åˆ† ===
async function calculateTrendScore(symbol, trend) {
  const klines = await fetchKlines(symbol, "1h", 50);

  let score = 0;

  // VWAPæ–¹å‘
  const vwap = calculateVWAP(klines);
  const lastClose = klines[klines.length - 1].close;
  if ((trend === "å¤šå¤´è¶‹åŠ¿" && lastClose > vwap) ||
      (trend === "ç©ºå¤´è¶‹åŠ¿" && lastClose < vwap)) {
    score += 1;
  }

  // çªç ´ç»“æ„
  const breakout = isBreakout(klines);
  if ((trend === "å¤šå¤´è¶‹åŠ¿" && breakout.breakoutLong) ||
      (trend === "ç©ºå¤´è¶‹åŠ¿" && breakout.breakoutShort)) {
    score += 1;
  }

  // æˆäº¤é‡ç¡®è®¤
  if (isVolumeConfirmed(klines)) score += 1;

  // OIç¡®è®¤
  const oi = await fetchOI(symbol);
  // å‡è®¾6hå†…å˜åŒ–Â±2%åˆ¤æ–­
  if (trend === "å¤šå¤´è¶‹åŠ¿" && oi > 1.02 * oi) score += 1;
  if (trend === "ç©ºå¤´è¶‹åŠ¿" && oi < 0.98 * oi) score += 1;

  // èµ„é‡‘è´¹ç‡
  const funding = await fetchFundingRate(symbol);
  if (Math.abs(funding) <= 0.0015) score += 1;

  // Deltaç¡®è®¤
  if ((trend === "å¤šå¤´è¶‹åŠ¿" && isDeltaPositive(klines)) ||
      (trend === "ç©ºå¤´è¶‹åŠ¿" && !isDeltaPositive(klines))) {
    score += 1;
  }

  // æœ€ç»ˆåˆ¤æ–­
  let action = "è§‚æœ›/ä¸åš";
  if (score >= 4) {
    action = trend === "å¤šå¤´è¶‹åŠ¿" ? "åšå¤š" : "åšç©º";
  }

  return {
    symbol,
    trend,
    score,
    action
  };
}

// === ç¤ºä¾‹è¿è¡Œ ===
(async () => {
  const symbol = "BTCUSDT";
  // è¿™é‡Œå‡è®¾ä¹‹å‰è¶‹åŠ¿JSè¿”å›çš„ç»“æœ
  const trend = "å¤šå¤´è¶‹åŠ¿"; // å¯ä»¥æ›¿æ¢æˆä½ ä¹‹å‰è¶‹åŠ¿åˆ¤æ–­çš„è¿”å›å€¼

  const result = await calculateTrendScore(symbol, trend);
  console.log("=== è¶‹åŠ¿å¼ºåº¦æ‰“åˆ† ===");
  console.log("äº¤æ˜“å¯¹:", result.symbol);
  console.log("è¶‹åŠ¿:", result.trend);
  console.log("æ€»åˆ†:", result.score);
  console.log("æ“ä½œå»ºè®®:", result.action);
})();
```

# 15åˆ†é’Ÿçº§åˆ«å…¥åœºåˆ¤æ–­ä»£ç é€»è¾‘
```jsx
/**
 * å…¥åœºä¿¡å·ä¸é£æ§è®¡ç®—ï¼ˆç»“åˆè¶‹åŠ¿åˆ¤æ–­ + æ‰“åˆ†ç³»ç»Ÿï¼‰
 * æ¨¡å¼Aï¼šå›è¸©ç¡®è®¤
 * æ¨¡å¼Bï¼šåŠ¨èƒ½çªç ´
 */

function calculateEntryAndRisk({
  trend,          // ä»è¶‹åŠ¿åˆ¤æ–­æ¨¡å—å¾—åˆ°: "å¤šå¤´è¶‹åŠ¿" / "ç©ºå¤´è¶‹åŠ¿" / "éœ‡è¡"
  score,          // æ‰“åˆ†ç³»ç»Ÿè¾“å‡º: 0-6
  klines15m,      // 15åˆ†é’ŸKçº¿æ•°ç»„ [{open, high, low, close, volume}]
  ema20,          // EMA20æ•°ç»„
  ema50,          // EMA50æ•°ç»„
  atr14           // ATR14æœ€æ–°å€¼
}) {
  const last = klines15m[klines15m.length - 1];
  const prev = klines15m[klines15m.length - 2]; // setup candle
  const lastClose = last.close;
  const lastHigh = last.high;
  const lastLow = last.low;
  const setupHigh = prev.high;
  const setupLow = prev.low;

  let entrySignal = null;
  let stopLoss = null;
  let takeProfit = null;
  let mode = null;

  // åªåœ¨æ˜ç¡®è¶‹åŠ¿ä¸”æ‰“åˆ†è¶³å¤Ÿæ—¶è€ƒè™‘å…¥åœº
  if (trend === "éœ‡è¡/æ— è¶‹åŠ¿" || score < 2) {
    return { entrySignal, stopLoss, takeProfit, mode };
  }

  // === æ¨¡å¼Aï¼šå›è¸©ç¡®è®¤ ===
  const supportLevel = Math.min(ema20[ema20.length - 1], ema50[ema50.length - 1]);
  const resistanceLevel = Math.max(ema20[ema20.length - 1], ema50[ema50.length - 1]);

  if (trend === "å¤šå¤´è¶‹åŠ¿" && lastClose <= supportLevel && lastClose > prev.low) {
    // å›è¸©EMAç¡®è®¤
    if (lastHigh > setupHigh) {
      entrySignal = lastHigh;          // å…¥åœºä»·ä¸ºçªç ´setupé«˜ç‚¹
      stopLoss = Math.min(prev.low, lastClose - 1.2 * atr14); // å–æ›´è¿œè€…
      takeProfit = entrySignal + 2 * (entrySignal - stopLoss); // é£æŠ¥æ¯”2:1
      mode = "å›è¸©ç¡®è®¤A";
    }
  } else if (trend === "ç©ºå¤´è¶‹åŠ¿" && lastClose >= resistanceLevel && lastClose < prev.high) {
    if (lastLow < setupLow) {
      entrySignal = lastLow;
      stopLoss = Math.max(prev.high, lastClose + 1.2 * atr14);
      takeProfit = entrySignal - 2 * (stopLoss - entrySignal);
      mode = "å›è¸©ç¡®è®¤A";
    }
  }

  // === æ¨¡å¼Bï¼šåŠ¨èƒ½çªç ´ ===
  const avgVol = klines15m.slice(-21, -1).reduce((a, k) => a + k.volume, 0) / 20;
  const breakoutLong = lastHigh > setupHigh && last.volume >= 1.5 * avgVol;
  const breakoutShort = lastLow < setupLow && last.volume >= 1.5 * avgVol;

  if (!entrySignal) { // å¦‚æœæ¨¡å¼Aæœªè§¦å‘
    if (trend === "å¤šå¤´è¶‹åŠ¿" && breakoutLong) {
      entrySignal = lastHigh;
      stopLoss = Math.min(prev.low, lastClose - 1.2 * atr14);
      takeProfit = entrySignal + 2 * (entrySignal - stopLoss);
      mode = "åŠ¨èƒ½çªç ´B";
    } else if (trend === "ç©ºå¤´è¶‹åŠ¿" && breakoutShort) {
      entrySignal = lastLow;
      stopLoss = Math.max(prev.high, lastClose + 1.2 * atr14);
      takeProfit = entrySignal - 2 * (stopLoss - entrySignal);
      mode = "åŠ¨èƒ½çªç ´B";
    }
  }

  return { entrySignal, stopLoss, takeProfit, mode };
}

// ==== ç¤ºä¾‹è°ƒç”¨ ====
const klines15m = [
  // 15m Kçº¿ç¤ºä¾‹æ•°æ®
  {open: 100, high: 102, low: 99, close: 101, volume: 10},
  {open: 101, high: 103, low: 100, close: 102, volume: 12},
  {open: 102, high: 104, low: 101, close: 103, volume: 15},
];

const ema20 = [100, 101, 102];
const ema50 = [99, 100, 101];
const atr14 = 1.5;

const trend = "å¤šå¤´è¶‹åŠ¿";
const score = 4; // å‡è®¾æ‰“åˆ†ç³»ç»Ÿè¾“å‡º

const result = calculateEntryAndRisk({trend, score, klines15m, ema20, ema50, atr14});

console.log(result);

/**
è¾“å‡ºç¤ºä¾‹:
{
  entrySignal: 104,
  stopLoss: 101.5,
  takeProfit: 106.5,
  mode: 'åŠ¨èƒ½çªç ´B'
}
*/
```

é‡‡ç”¨é€ä»“æ¨¡å¼ï¼Œæ­¢æŸè·ç¦»ï¼Œæœ€å¤§æ æ†æ•°å’Œæœ€å°ä¿è¯é‡‘æ•°è®¡ç®—æ–¹å¼ï¼š
- æ­¢æŸè·ç¦»X%ï¼š
  - å¤šå¤´ï¼š(entrySignal - stopLoss) / entrySignal
  - ç©ºå¤´ï¼š(stopLoss - entrySignal) / entrySignal
- æœ€å¤§æŸå¤±é‡‘é¢(U)ï¼šM
    - æœ€å¤§æ æ†æ•°Yï¼š1/(X%+0.5%) æ•°å€¼å‘ä¸‹å–æ•´ã€‚
    - ä¿è¯é‡‘Zï¼šM/(Y*X%) æ•°å€¼å‘ä¸Šå–æ•´ã€‚