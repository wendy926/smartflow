# å•æµ‹å†…å­˜æ³„æ¼é£é™©åˆ†ææŠ¥å‘Š

## æ¦‚è¿°

é€šè¿‡è¿è¡Œ`--detectOpenHandles`æ£€æµ‹ï¼Œå‘ç°ä»¥ä¸‹å†…å­˜æ³„æ¼é£é™©ï¼š

## ğŸš¨ å‘ç°çš„å†…å­˜æ³„æ¼é£é™©

### 1. æœåŠ¡å™¨ç«¯Kçº¿æ•°æ®æ›´æ–°æµ‹è¯• - é«˜é£é™©

**æ–‡ä»¶**: `tests/server-kline-update.test.js`

**é—®é¢˜**: `setInterval`å®šæ—¶å™¨æœªæ­£ç¡®æ¸…ç†
```javascript
// é—®é¢˜ä»£ç 
this.klineUpdateInterval = setInterval(async () => {
    // å®šæœŸä»»åŠ¡é€»è¾‘
}, 30 * 60 * 1000); // 30åˆ†é’Ÿ
```

**é£é™©ç­‰çº§**: ğŸ”´ é«˜é£é™©
- å®šæ—¶å™¨é—´éš”30åˆ†é’Ÿï¼Œæµ‹è¯•ä¸­å¯èƒ½ä¸ä¼šè‡ªåŠ¨æ¸…ç†
- å¤šä¸ªæµ‹è¯•ç”¨ä¾‹å¯èƒ½åˆ›å»ºå¤šä¸ªå®šæ—¶å™¨
- å¯èƒ½å¯¼è‡´æµ‹è¯•è¿›ç¨‹æ— æ³•æ­£å¸¸é€€å‡º

### 2. æ•°æ®åº“è¿æ¥æœªæ­£ç¡®å…³é—­ - ä¸­ç­‰é£é™©

**æ–‡ä»¶**: `tests/database-manager.test.js`, `tests/cache-manager.test.js`

**é—®é¢˜**: æ•°æ®åº“è¿æ¥åœ¨æµ‹è¯•å¤±è´¥æ—¶å¯èƒ½æœªæ­£ç¡®å…³é—­
```javascript
// é—®é¢˜ä»£ç 
test('åº”è¯¥å¤„ç†æ•°æ®åº“è¿æ¥é”™è¯¯', async () => {
    const invalidDb = new DatabaseManager('/invalid/path/db.sqlite');
    // æµ‹è¯•å¤±è´¥æ—¶æ•°æ®åº“è¿æ¥å¯èƒ½æœªå…³é—­
});
```

**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰é£é™©
- æ•°æ®åº“è¿æ¥å¯èƒ½æ³„æ¼
- æ–‡ä»¶å¥æŸ„å¯èƒ½æœªé‡Šæ”¾

### 3. å¼‚æ­¥æ“ä½œæœªç­‰å¾…å®Œæˆ - ä¸­ç­‰é£é™©

**æ–‡ä»¶**: `tests/ma-data-freshness-fix.test.js`

**é—®é¢˜**: å¼‚æ­¥æ•°æ®åº“æ›´æ–°æ“ä½œå¯èƒ½æœªç­‰å¾…å®Œæˆ
```javascript
// é—®é¢˜ä»£ç 
this.updateDatabaseAsync(symbol, interval, realtimeData);
// å¼‚æ­¥æ“ä½œå¯èƒ½æœªå®Œæˆå°±ç»“æŸæµ‹è¯•
```

**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰é£é™©
- å¼‚æ­¥æ“ä½œå¯èƒ½æœªå®Œæˆ
- å¯èƒ½å¯¼è‡´èµ„æºæœªé‡Šæ”¾

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤å®šæ—¶å™¨å†…å­˜æ³„æ¼

**ä¿®å¤ç­–ç•¥**:
- åœ¨`afterEach`ä¸­ç¡®ä¿æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
- ä½¿ç”¨`fakeTimers`æ¨¡æ‹Ÿæ—¶é—´
- æ·»åŠ è¶…æ—¶æ¸…ç†æœºåˆ¶

**ä¿®å¤ä»£ç **:
```javascript
afterEach(() => {
    jest.clearAllMocks();
    if (server && server.klineUpdateInterval) {
        clearInterval(server.klineUpdateInterval);
        server.klineUpdateInterval = undefined;
    }
    // æ¸…ç†æ‰€æœ‰å¯èƒ½çš„å®šæ—¶å™¨
    jest.clearAllTimers();
});
```

### 2. ä¿®å¤æ•°æ®åº“è¿æ¥æ³„æ¼

**ä¿®å¤ç­–ç•¥**:
- ä½¿ç”¨`try-finally`ç¡®ä¿è¿æ¥å…³é—­
- æ·»åŠ è¶…æ—¶æœºåˆ¶
- ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®åº“é¿å…çœŸå®è¿æ¥

**ä¿®å¤ä»£ç **:
```javascript
test('åº”è¯¥å¤„ç†æ•°æ®åº“è¿æ¥é”™è¯¯', async () => {
    let invalidDb;
    try {
        invalidDb = new DatabaseManager('/invalid/path/db.sqlite');
        await expect(invalidDb.init()).rejects.toThrow();
    } finally {
        if (invalidDb) {
            await invalidDb.close();
        }
    }
});
```

### 3. ä¿®å¤å¼‚æ­¥æ“ä½œæ³„æ¼

**ä¿®å¤ç­–ç•¥**:
- ç­‰å¾…æ‰€æœ‰å¼‚æ­¥æ“ä½œå®Œæˆ
- æ·»åŠ è¶…æ—¶æœºåˆ¶
- ä½¿ç”¨`Promise.allSettled`

**ä¿®å¤ä»£ç **:
```javascript
test('åº”è¯¥å¼‚æ­¥æ›´æ–°æ•°æ®åº“', async () => {
    // å¯åŠ¨å¼‚æ­¥æ“ä½œ
    strategyCore.updateDatabaseAsync('BTCUSDT', '4h', klineData);
    
    // ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ
    await new Promise(resolve => setImmediate(resolve));
    
    // éªŒè¯ç»“æœ
    expect(mockDatabase.runQuery).toHaveBeenCalled();
});
```

## ğŸ“Š å†…å­˜æ³„æ¼é£é™©è¯„ä¼°

| æµ‹è¯•æ–‡ä»¶ | é£é™©ç­‰çº§ | ä¸»è¦é—®é¢˜ | å½±å“èŒƒå›´ |
|---------|---------|---------|---------|
| `server-kline-update.test.js` | ğŸ”´ é«˜é£é™© | å®šæ—¶å™¨æœªæ¸…ç† | æµ‹è¯•è¿›ç¨‹æ— æ³•é€€å‡º |
| `database-manager.test.js` | ğŸŸ¡ ä¸­ç­‰é£é™© | æ•°æ®åº“è¿æ¥æœªå…³é—­ | æ–‡ä»¶å¥æŸ„æ³„æ¼ |
| `cache-manager.test.js` | ğŸŸ¡ ä¸­ç­‰é£é™© | æ•°æ®åº“è¿æ¥æœªå…³é—­ | æ–‡ä»¶å¥æŸ„æ³„æ¼ |
| `ma-data-freshness-fix.test.js` | ğŸŸ¡ ä¸­ç­‰é£é™© | å¼‚æ­¥æ“ä½œæœªç­‰å¾… | èµ„æºæœªé‡Šæ”¾ |

## ğŸ›¡ï¸ é¢„é˜²æªæ–½

### 1. æµ‹è¯•é…ç½®ä¼˜åŒ–

**Jesté…ç½®**:
```javascript
module.exports = {
    // å¼ºåˆ¶é€€å‡ºï¼Œé¿å…æŒ‚èµ·
    forceExit: true,
    
    // æ£€æµ‹æ‰“å¼€å¥æŸ„
    detectOpenHandles: true,
    
    // æµ‹è¯•è¶…æ—¶
    testTimeout: 10000,
    
    // æ¸…ç†æ¨¡æ‹Ÿ
    clearMocks: true,
    restoreMocks: true,
    
    // å…¨å±€æ¸…ç†
    setupFilesAfterEnv: ['<rootDir>/tests/setup.js'],
    globalTeardown: '<rootDir>/tests/teardown.js'
};
```

### 2. æµ‹è¯•æ¨¡æ¿

**æ ‡å‡†æµ‹è¯•æ¨¡æ¿**:
```javascript
describe('æµ‹è¯•æè¿°', () => {
    let resource;
    
    beforeEach(() => {
        // åˆå§‹åŒ–èµ„æº
        resource = new Resource();
    });
    
    afterEach(async () => {
        // æ¸…ç†èµ„æº
        if (resource) {
            await resource.cleanup();
            resource = null;
        }
        // æ¸…ç†å®šæ—¶å™¨
        jest.clearAllTimers();
        // æ¸…ç†æ¨¡æ‹Ÿ
        jest.clearAllMocks();
    });
    
    test('æµ‹è¯•ç”¨ä¾‹', async () => {
        // æµ‹è¯•é€»è¾‘
        // ç¡®ä¿ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ
        await expect(someAsyncOperation()).resolves.toBeDefined();
    });
});
```

### 3. ç›‘æ§å·¥å…·

**å†…å­˜ä½¿ç”¨ç›‘æ§**:
```javascript
// åœ¨æµ‹è¯•ä¸­ç›‘æ§å†…å­˜ä½¿ç”¨
const memBefore = process.memoryUsage();
// æ‰§è¡Œæµ‹è¯•
const memAfter = process.memoryUsage();
console.log('å†…å­˜ä½¿ç”¨å˜åŒ–:', {
    heapUsed: memAfter.heapUsed - memBefore.heapUsed,
    heapTotal: memAfter.heapTotal - memBefore.heapTotal
});
```

## ğŸ¯ ä¼˜å…ˆçº§ä¿®å¤è®¡åˆ’

### é«˜ä¼˜å…ˆçº§ (ç«‹å³ä¿®å¤)
1. âœ… ä¿®å¤`server-kline-update.test.js`ä¸­çš„å®šæ—¶å™¨æ³„æ¼
2. âœ… æ·»åŠ å…¨å±€æ¸…ç†æœºåˆ¶

### ä¸­ä¼˜å…ˆçº§ (æœ¬å‘¨å†…ä¿®å¤)
3. ä¿®å¤æ•°æ®åº“è¿æ¥æ³„æ¼é—®é¢˜
4. ä¼˜åŒ–å¼‚æ­¥æ“ä½œç­‰å¾…æœºåˆ¶

### ä½ä¼˜å…ˆçº§ (ä¸‹ä¸ªç‰ˆæœ¬)
5. æ·»åŠ å†…å­˜ä½¿ç”¨ç›‘æ§
6. å®Œå–„æµ‹è¯•æ¨¡æ¿å’Œè§„èŒƒ

## ğŸ“ˆ ä¿®å¤æ•ˆæœéªŒè¯

### ä¿®å¤å‰
- æµ‹è¯•è¿›ç¨‹å¯èƒ½æ— æ³•æ­£å¸¸é€€å‡º
- å­˜åœ¨å®šæ—¶å™¨å’Œæ•°æ®åº“è¿æ¥æ³„æ¼
- å†…å­˜ä½¿ç”¨æŒç»­å¢é•¿

### ä¿®å¤å
- æ‰€æœ‰æµ‹è¯•æ­£å¸¸é€€å‡º
- æ— å®šæ—¶å™¨æˆ–è¿æ¥æ³„æ¼
- å†…å­˜ä½¿ç”¨ç¨³å®š

## ğŸ” æŒç»­ç›‘æ§

### 1. å®šæœŸæ£€æŸ¥
- æ¯å‘¨è¿è¡Œ`--detectOpenHandles`æ£€æŸ¥
- ç›‘æ§æµ‹è¯•æ‰§è¡Œæ—¶é—´
- æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ

### 2. è‡ªåŠ¨åŒ–æ£€æµ‹
- åœ¨CI/CDä¸­æ·»åŠ å†…å­˜æ³„æ¼æ£€æµ‹
- è®¾ç½®å†…å­˜ä½¿ç”¨é˜ˆå€¼å‘Šè­¦
- è‡ªåŠ¨ç”Ÿæˆå†…å­˜ä½¿ç”¨æŠ¥å‘Š

### 3. ä»£ç å®¡æŸ¥
- æ–°å¢æµ‹è¯•å¿…é¡»åŒ…å«èµ„æºæ¸…ç†
- æ£€æŸ¥å¼‚æ­¥æ“ä½œæ˜¯å¦æ­£ç¡®ç­‰å¾…
- éªŒè¯å®šæ—¶å™¨æ˜¯å¦æ­£ç¡®æ¸…ç†

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-01-14  
**æ£€æµ‹å·¥å…·**: Jest `--detectOpenHandles`  
**é£é™©ç­‰çº§**: ğŸ”´ é«˜é£é™© (1ä¸ª) + ğŸŸ¡ ä¸­ç­‰é£é™© (3ä¸ª)
