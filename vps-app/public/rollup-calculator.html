<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–æ³¢æ‹‰å¥‘æ»šä»“è®¡ç®—å™¨ - SmartFlow</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header p {
      color: #666;
      font-size: 1.1rem;
    }

    .calculator-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .input-section,
    .result-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 10px;
      border: 1px solid #e9ecef;
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .result-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .result-table th,
    .result-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }

    .result-table th {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      font-weight: 600;
    }

    .result-table tr:hover {
      background: rgba(102, 126, 234, 0.05);
    }

    .profit {
      color: #28a745;
      font-weight: bold;
    }

    .loss {
      color: #dc3545;
      font-weight: bold;
    }

    .summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .summary h3 {
      margin-bottom: 15px;
      font-size: 1.3rem;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    .summary-item.total {
      font-weight: bold;
      font-size: 1.2rem;
      border-top: 2px solid rgba(255, 255, 255, 0.3);
      padding-top: 10px;
      margin-top: 10px;
    }

    .fibonacci-levels {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .fib-level {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .fib-level h4 {
      color: #667eea;
      margin-bottom: 8px;
    }

    .fib-level .price {
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
    }

    .fib-level .profit {
      color: #28a745;
      font-weight: bold;
    }

    .fib-level .loss {
      color: #dc3545;
      font-weight: bold;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      border: 1px solid #f5c6cb;
    }

    .success {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      border: 1px solid #c3e6cb;
    }

    @media (max-width: 768px) {
      .calculator-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .container {
        padding: 20px;
      }

      .header h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š æ–æ³¢æ‹‰å¥‘æ»šä»“è®¡ç®—å™¨</h1>
      <p>åŸºäºæ–æ³¢æ‹‰å¥‘å›æ’¤çº§åˆ«çš„æ™ºèƒ½æ»šä»“ç­–ç•¥è®¡ç®—å·¥å…·</p>
    </div>

    <div class="calculator-grid">
      <div class="input-section">
        <h3 class="section-title">ğŸ“ è¾“å…¥å‚æ•°</h3>

        <div class="form-group">
          <label for="maxLossAmount">ğŸ’° å•æ¬¡äº¤æ˜“æœ€å¤§æŸå¤± (USDT)</label>
          <select id="maxLossAmount">
            <option value="10">10 USDT</option>
            <option value="20" selected>20 USDT</option>
            <option value="50">50 USDT</option>
            <option value="100">100 USDT</option>
          </select>
        </div>

        <div class="form-group">
          <label for="entryPrice">ğŸ“ˆ å…¥åœºä»·æ ¼ (USDT)</label>
          <input type="number" id="entryPrice" placeholder="ä¾‹å¦‚: 50000" step="0.01" min="0">
        </div>

        <div class="form-group">
          <label for="stopLoss">ğŸ›‘ æ­¢æŸä»·æ ¼ (USDT)</label>
          <input type="number" id="stopLoss" placeholder="ä¾‹å¦‚: 48000" step="0.01" min="0">
        </div>

        <div class="form-group">
          <label for="takeProfit">ğŸ¯ ç›®æ ‡ä»·æ ¼ (USDT)</label>
          <input type="number" id="takeProfit" placeholder="ä¾‹å¦‚: 54000" step="0.01" min="0">
        </div>

        <div class="form-group">
          <label for="leverage">âš¡ æ æ†å€æ•°</label>
          <select id="leverage">
            <option value="1">1x</option>
            <option value="2">2x</option>
            <option value="3">3x</option>
            <option value="5">5x</option>
            <option value="10">10x</option>
            <option value="20">20x</option>
          </select>
        </div>

        <div class="form-group">
          <label for="fibonacciLevels">ğŸ“Š æ–æ³¢æ‹‰å¥‘å›æ’¤çº§åˆ«</label>
          <select id="fibonacciLevels">
            <option value="3">3ä¸ªçº§åˆ« (23.6%, 38.2%, 61.8%)</option>
            <option value="5" selected>5ä¸ªçº§åˆ« (23.6%, 38.2%, 50%, 61.8%, 78.6%)</option>
            <option value="7">7ä¸ªçº§åˆ« (å…¨éƒ¨)</option>
          </select>
        </div>

        <button class="btn" onclick="calculateRollup()">ğŸ§® è®¡ç®—æ»šä»“ç­–ç•¥</button>
      </div>

      <div class="result-section">
        <h3 class="section-title">ğŸ“Š è®¡ç®—ç»“æœ</h3>
        <div id="results">
          <p style="color: #666; text-align: center; margin-top: 50px;">
            è¯·å¡«å†™å‚æ•°å¹¶ç‚¹å‡»"è®¡ç®—æ»šä»“ç­–ç•¥"
          </p>
        </div>
      </div>
    </div>

    <div id="fibonacciLevels" class="fibonacci-levels" style="display: none;">
      <!-- æ–æ³¢æ‹‰å¥‘çº§åˆ«å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <div id="summary" class="summary" style="display: none;">
      <!-- æ±‡æ€»ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
    </div>
  </div>

  <script>
    // æ–æ³¢æ‹‰å¥‘å›æ’¤çº§åˆ«
    const fibonacciLevels = {
      3: [0.236, 0.382, 0.618],
      5: [0.236, 0.382, 0.5, 0.618, 0.786],
      7: [0.236, 0.382, 0.5, 0.618, 0.786, 0.886, 0.95]
    };

    // è®¡ç®—æ»šä»“ç­–ç•¥
    function calculateRollup() {
      try {
        // è·å–è¾“å…¥å‚æ•°
        const maxLoss = parseFloat(document.getElementById('maxLossAmount').value);
        const entryPrice = parseFloat(document.getElementById('entryPrice').value);
        const stopLoss = parseFloat(document.getElementById('stopLoss').value);
        const takeProfit = parseFloat(document.getElementById('takeProfit').value);
        const leverage = parseInt(document.getElementById('leverage').value);
        const levelCount = parseInt(document.getElementById('fibonacciLevels').value);

        // éªŒè¯è¾“å…¥
        if (!entryPrice || !stopLoss || !takeProfit) {
          showError('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€çš„ä»·æ ¼å‚æ•°');
          return;
        }

        if (entryPrice <= stopLoss) {
          showError('å…¥åœºä»·æ ¼å¿…é¡»å¤§äºæ­¢æŸä»·æ ¼');
          return;
        }

        if (takeProfit <= entryPrice) {
          showError('ç›®æ ‡ä»·æ ¼å¿…é¡»å¤§äºå…¥åœºä»·æ ¼');
          return;
        }

        // è®¡ç®—åŸºç¡€æ•°æ®
        const priceRange = takeProfit - entryPrice;
        const stopDistance = entryPrice - stopLoss;
        const riskRewardRatio = priceRange / stopDistance;

        // è·å–æ–æ³¢æ‹‰å¥‘çº§åˆ«
        const levels = fibonacciLevels[levelCount];
        if (!levels) {
          showError('æ— æ•ˆçš„æ–æ³¢æ‹‰å¥‘çº§åˆ«è®¾ç½®');
          return;
        }

        // è®¡ç®—æ¯ä¸ªçº§åˆ«çš„æ•°æ®
        const levelData = levels.map((level, index) => {
          const levelPrice = entryPrice + (priceRange * level);
          const levelStopLoss = stopLoss + (stopDistance * level);
          const levelTakeProfit = takeProfit;

          // è®¡ç®—è¯¥çº§åˆ«çš„ç›ˆäº
          const levelProfit = (levelTakeProfit - levelPrice) / levelPrice * leverage * 100;
          const levelLoss = (levelStopLoss - levelPrice) / levelPrice * leverage * 100;

          // è®¡ç®—è¯¥çº§åˆ«éœ€è¦çš„ä¿è¯é‡‘
          const levelMargin = maxLoss / Math.abs(levelLoss) * 100;

          return {
            level: (level * 100).toFixed(1) + '%',
            price: levelPrice.toFixed(2),
            stopLoss: levelStopLoss.toFixed(2),
            takeProfit: levelTakeProfit.toFixed(2),
            profit: levelProfit.toFixed(2),
            loss: levelLoss.toFixed(2),
            margin: levelMargin.toFixed(2),
            riskReward: (levelProfit / Math.abs(levelLoss)).toFixed(2)
          };
        });

        // æ˜¾ç¤ºç»“æœ
        displayResults(levelData, maxLoss, riskRewardRatio);
        displayFibonacciLevels(levelData);
        displaySummary(levelData, maxLoss);

      } catch (error) {
        showError('è®¡ç®—è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
      }
    }

    // æ˜¾ç¤ºç»“æœè¡¨æ ¼
    function displayResults(data, maxLoss, riskRewardRatio) {
      const resultsDiv = document.getElementById('results');

      let html = `
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>çº§åˆ«</th>
                            <th>å…¥åœºä»·</th>
                            <th>æ­¢æŸä»·</th>
                            <th>ç›®æ ‡ä»·</th>
                            <th>é¢„æœŸæ”¶ç›Š%</th>
                            <th>æœ€å¤§äºæŸ%</th>
                            <th>éœ€è¦ä¿è¯é‡‘</th>
                            <th>é£é™©æ”¶ç›Šæ¯”</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

      data.forEach((level, index) => {
        html += `
                    <tr>
                        <td><strong>${level.level}</strong></td>
                        <td>$${level.price}</td>
                        <td>$${level.stopLoss}</td>
                        <td>$${level.takeProfit}</td>
                        <td class="profit">+${level.profit}%</td>
                        <td class="loss">${level.loss}%</td>
                        <td>$${level.margin}</td>
                        <td>${level.riskReward}:1</td>
                    </tr>
                `;
      });

      html += `
                    </tbody>
                </table>
                <div class="success">
                    <strong>ç­–ç•¥è¯´æ˜ï¼š</strong><br>
                    â€¢ åŸºäºæ–æ³¢æ‹‰å¥‘å›æ’¤çº§åˆ«çš„åˆ†æ‰¹å…¥åœºç­–ç•¥<br>
                    â€¢ æ¯ä¸ªçº§åˆ«ç‹¬ç«‹è®¡ç®—æ­¢æŸå’Œæ­¢ç›ˆ<br>
                    â€¢ æ€»é£é™©æ§åˆ¶åœ¨ ${maxLoss} USDT ä»¥å†…<br>
                    â€¢ æ•´ä½“é£é™©æ”¶ç›Šæ¯”: ${riskRewardRatio.toFixed(2)}:1
                </div>
            `;

      resultsDiv.innerHTML = html;
    }

    // æ˜¾ç¤ºæ–æ³¢æ‹‰å¥‘çº§åˆ«å¡ç‰‡
    function displayFibonacciLevels(data) {
      const container = document.getElementById('fibonacciLevels');
      container.style.display = 'block';

      let html = '';
      data.forEach((level, index) => {
        const isProfit = parseFloat(level.profit) > 0;
        html += `
                    <div class="fib-level">
                        <h4>çº§åˆ« ${level.level}</h4>
                        <div class="price">$${level.price}</div>
                        <div>æ­¢æŸ: $${level.stopLoss}</div>
                        <div>ç›®æ ‡: $${level.takeProfit}</div>
                        <div class="${isProfit ? 'profit' : 'loss'}">
                            ${isProfit ? '+' : ''}${level.profit}%
                        </div>
                        <div>ä¿è¯é‡‘: $${level.margin}</div>
                    </div>
                `;
      });

      container.innerHTML = html;
    }

    // æ˜¾ç¤ºæ±‡æ€»ä¿¡æ¯
    function displaySummary(data, maxLoss) {
      const summaryDiv = document.getElementById('summary');
      summaryDiv.style.display = 'block';

      const totalMargin = data.reduce((sum, level) => sum + parseFloat(level.margin), 0);
      const avgProfit = data.reduce((sum, level) => sum + parseFloat(level.profit), 0) / data.length;
      const maxLossPercent = Math.max(...data.map(level => Math.abs(parseFloat(level.loss))));

      let html = `
                <h3>ğŸ“Š ç­–ç•¥æ±‡æ€»</h3>
                <div class="summary-item">
                    <span>æ€»éœ€è¦ä¿è¯é‡‘:</span>
                    <span>$${totalMargin.toFixed(2)}</span>
                </div>
                <div class="summary-item">
                    <span>å¹³å‡é¢„æœŸæ”¶ç›Š:</span>
                    <span class="profit">+${avgProfit.toFixed(2)}%</span>
                </div>
                <div class="summary-item">
                    <span>æœ€å¤§å•æ¬¡äºæŸ:</span>
                    <span class="loss">${maxLossPercent.toFixed(2)}%</span>
                </div>
                <div class="summary-item">
                    <span>é£é™©æ§åˆ¶:</span>
                    <span>$${maxLoss} USDT</span>
                </div>
                <div class="summary-item total">
                    <span>æ€»é£é™©æ”¶ç›Šæ¯”:</span>
                    <span>${(avgProfit / maxLossPercent).toFixed(2)}:1</span>
                </div>
            `;

      summaryDiv.innerHTML = html;
    }

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showError(message) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="error">${message}</div>`;

      document.getElementById('fibonacciLevels').style.display = 'none';
      document.getElementById('summary').style.display = 'none';
    }

    // é¡µé¢åŠ è½½æ—¶è®¾ç½®é»˜è®¤å€¼
    document.addEventListener('DOMContentLoaded', function () {
      // ä»çˆ¶çª—å£è·å–æœ€å¤§æŸå¤±é‡‘é¢ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
      try {
        if (window.opener && window.opener.document) {
          const parentMaxLoss = window.opener.document.getElementById('maxLossAmount');
          if (parentMaxLoss) {
            document.getElementById('maxLossAmount').value = parentMaxLoss.value;
          }
        }
      } catch (error) {
        console.log('æ— æ³•ä»çˆ¶çª—å£è·å–å‚æ•°:', error);
      }
    });
  </script>
</body>

</html>