<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartFlow äº¤æ˜“ç­–ç•¥ä»ªè¡¨æ¿</title>

    <!-- PWA æ”¯æŒ -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SmartFlow">

    <!-- é˜²æ­¢ç§»åŠ¨ç«¯ä¸‹æ‹‰åˆ·æ–° -->
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">

    <!-- é˜²æ­¢iOS Safariç¼©æ”¾ -->
    <meta name="format-detection" content="telephone=no">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            /* é˜²æ­¢ç§»åŠ¨ç«¯ä¸‹æ‹‰åˆ·æ–° */
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            /* é˜²æ­¢iOS Safariçš„å¼¹æ€§æ»šåŠ¨ */
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            /* æ”¯æŒæ»šåŠ¨ */
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* é¡¶éƒ¨æ§åˆ¶åŒºåŸŸ */
        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* åº•éƒ¨æ§åˆ¶åŒºåŸŸ */
        .bottom-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: 2px solid #667eea;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            background: linear-gradient(45deg, #5a6fd8, #6a4c93);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
                /* iOS æ¨èçš„æœ€å°è§¦æ‘¸ç›®æ ‡ */
                min-width: 44px;
            }

            .expand-btn {
                min-width: 44px;
                min-height: 44px;
            }

            .refresh-select,
            .symbol-input {
                min-height: 44px;
                font-size: 16px;
                /* é˜²æ­¢iOSç¼©æ”¾ */
            }

            .mark-btn {
                min-height: 36px;
                min-width: 60px;
            }
        }

        .btn.primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border-color: #ff6b6b;
        }

        .btn.secondary {
            background: linear-gradient(45deg, #4834d4, #686de0);
            border-color: #4834d4;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card p {
            color: #666;
            font-weight: 500;
        }

        .win-rate-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .win-rate-card h3 {
            color: white;
            -webkit-text-fill-color: white;
            background: none;
            -webkit-background-clip: unset;
            background-clip: unset;
        }

        .win-rate-card p {
            color: rgba(255, 255, 255, 0.9);
        }

        .win-rate-card small {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
            display: block;
            margin-top: 2px;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.1);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            /* iOS å¹³æ»‘æ»šåŠ¨ */
        }

        .table {
            width: 100%;
            min-width: 800px;
            /* ç¡®ä¿è¡¨æ ¼åœ¨å°å±å¹•ä¸Šå¯æ»šåŠ¨ */
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .signal {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
        }

        .signal.long {
            background: linear-gradient(45deg, #00b894, #00cec9);
            color: white;
        }

        .signal.short {
            background: linear-gradient(45deg, #e17055, #d63031);
            color: white;
        }

        .signal.no-signal {
            background: #ddd;
            color: #666;
        }

        /* ä¿¡å·é«˜äº®æ˜¾ç¤º */
        .signal.long.highlight {
            background: linear-gradient(45deg, #00b894, #00cec9);
            color: white;
            box-shadow: 0 0 15px rgba(0, 184, 148, 0.5);
            animation: pulse 2s infinite;
        }

        .signal.short.highlight {
            background: linear-gradient(45deg, #e17055, #d63031);
            color: white;
            box-shadow: 0 0 15px rgba(225, 112, 85, 0.5);
            animation: pulse 2s infinite;
        }

        .trend.uptrend.highlight {
            background: #d4edda;
            color: #155724;
            box-shadow: 0 0 10px rgba(21, 87, 36, 0.3);
            animation: pulse 2s infinite;
        }

        .trend.downtrend.highlight {
            background: #f8d7da;
            color: #721c24;
            box-shadow: 0 0 10px rgba(114, 28, 36, 0.3);
            animation: pulse 2s infinite;
        }

        .execution.long-execute.highlight {
            background: linear-gradient(45deg, #00b894, #00cec9);
            color: white;
            box-shadow: 0 0 15px rgba(0, 184, 148, 0.5);
            animation: pulse 2s infinite;
        }

        .execution.short-execute.highlight {
            background: linear-gradient(45deg, #e17055, #d63031);
            color: white;
            box-shadow: 0 0 15px rgba(225, 112, 85, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 184, 148, 0.7);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(0, 184, 148, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 184, 148, 0);
            }
        }

        /* è¡¨æ ¼è¡Œæ‚¬åœæ•ˆæœä¼˜åŒ– */
        .table tr:hover {
            background: rgba(102, 126, 234, 0.05);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* é«˜äº®ä¿¡å·çš„è¡Œæ‚¬åœæ•ˆæœ */
        .table tr:hover .highlight {
            transform: scale(1.02);
        }

        /* è¯¦æƒ…æŒ‰é’®ä¼˜åŒ– */
        .expand-btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .expand-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        .expand-btn:hover::before {
            width: 100%;
            height: 100%;
        }

        /* æ“ä½œæŒ‰é’®ä¼˜åŒ– */
        .btn.small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .btn.small:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .trend {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .trend.uptrend {
            background: #d4edda;
            color: #155724;
        }

        .trend.downtrend {
            background: #f8d7da;
            color: #721c24;
        }

        .trend.range {
            background: #fff3cd;
            color: #856404;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        /* è§„åˆ™è¯´æ˜æ ·å¼ */
        .rules-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .rules-section h2 {
            color: #333;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.8rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .rule-category {
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .rule-category h3 {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin: 0;
            padding: 15px 20px;
            font-size: 1.2rem;
        }

        .rule-content {
            padding: 20px;
            background: #f8f9fa;
        }

        .rule-content h4 {
            color: #495057;
            margin: 15px 0 10px 0;
            font-size: 1.1rem;
            border-left: 4px solid #667eea;
            padding-left: 10px;
        }

        .rule-content ul {
            margin: 0 0 15px 20px;
            padding: 0;
        }

        .rule-content li {
            margin-bottom: 8px;
            line-height: 1.6;
            color: #6c757d;
        }

        .rule-content li strong {
            color: #495057;
        }

        /* å†å²è®°å½•æ ·å¼ */
        .expand-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .expand-btn:hover {
            background: #5a6fd8;
            transform: scale(1.1);
        }

        .history-row {
            background: #f8f9fa;
        }

        .history-container {
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 10px 0;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .history-header h4 {
            margin: 0;
            color: #333;
        }

        .load-history-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .load-history-btn:hover {
            background: #218838;
        }

        .history-record {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 10px;
            padding: 15px;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .record-time {
            font-weight: bold;
            color: #495057;
        }

        .record-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .record-status.correct {
            background: #d4edda;
            color: #155724;
        }

        .record-status.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .record-status.unmarked {
            background: #fff3cd;
            color: #856404;
        }

        .record-details {
            font-size: 14px;
        }

        .detail-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 8px;
        }

        .label {
            font-weight: bold;
            color: #6c757d;
            min-width: 80px;
        }

        .value {
            color: #495057;
        }

        .record-notes {
            background: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            margin: 10px 0;
            font-style: italic;
            color: #6c757d;
        }

        .record-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .mark-btn {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .mark-btn.correct {
            background: #d4edda;
            color: #155724;
        }

        .mark-btn.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .mark-btn.unmarked {
            background: #fff3cd;
            color: #856404;
        }

        .mark-btn:hover {
            opacity: 0.8;
        }

        .no-data {
            text-align: center;
            color: #6c757d;
            padding: 20px;
        }

        /* æ¶ˆæ¯æç¤ºæ ·å¼ */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
        }

        .message.success {
            background: #28a745;
        }

        .message.error {
            background: #dc3545;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ç§»åŠ¨ç«¯æ¶ˆæ¯æç¤ºä¼˜åŒ– */
        @media screen and (max-width: 430px) {
            .message {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                text-align: center;
                font-size: 14px;
            }
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }

        .modal-close {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #ff3742;
            transform: scale(1.1);
        }

        .modal-body {
            padding: 25px;
            flex: 1;
            overflow-y: auto;
        }

        /* ç§»åŠ¨ç«¯æ¨¡æ€æ¡†ä¼˜åŒ– */
        @media screen and (max-width: 430px) {
            .modal {
                padding: 10px;
            }

            .modal-content {
                max-height: 90vh;
                border-radius: 12px;
            }

            .modal-header {
                padding: 15px 20px;
            }

            .modal-header h2 {
                font-size: 1.2rem;
            }

            .modal-close {
                width: 28px;
                height: 28px;
                font-size: 16px;
            }

            .modal-body {
                padding: 20px;
            }
        }

        /* Telegramé…ç½®æ ·å¼ */
        .telegram-config h3 {
            color: #0088cc;
            margin-bottom: 20px;
            text-align: center;
        }

        .config-status {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .config-status p {
            margin: 10px 0;
            font-size: 16px;
        }

        .status-success {
            color: #28a745;
            font-weight: bold;
        }

        .status-error {
            color: #dc3545;
            font-weight: bold;
        }

        .config-instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .config-instructions h4 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .config-instructions ol {
            margin-left: 20px;
        }

        .config-instructions li {
            margin: 10px 0;
            line-height: 1.6;
        }

        .config-instructions code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d63384;
        }

        .config-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .config-actions .btn {
            min-width: 120px;
            flex: 1;
            max-width: 200px;
        }

        .config-actions .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ç§»åŠ¨ç«¯æŒ‰é’®ä¼˜åŒ– */
        @media screen and (max-width: 430px) {
            .config-actions {
                flex-direction: column;
                gap: 10px;
            }

            .config-actions .btn {
                min-width: auto;
                max-width: none;
                width: 100%;
            }
        }

        /* äº¤æ˜“å¯¹åˆ—è¡¨æ ·å¼ */
        .symbols-list h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .symbols-content {
            margin-bottom: 20px;
        }

        .default-symbols,
        .custom-symbols {
            margin-bottom: 20px;
        }

        .default-symbols h4,
        .custom-symbols h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .symbols-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .symbol-tag {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            position: relative;
        }

        .default-tag {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .custom-tag {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .remove-symbol {
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .remove-symbol:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        .symbol-status {
            font-size: 10px;
            color: #666;
            margin-left: 5px;
            font-weight: normal;
        }

        .trigger-reason {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .trigger-reason.signal {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .trigger-reason.execution {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }

        .no-symbols {
            color: #6c757d;
            font-style: italic;
            padding: 10px;
        }

        .symbols-actions {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 12px;
        }

        /* ç§»åŠ¨ç«¯äº¤æ˜“å¯¹åˆ—è¡¨ä¼˜åŒ– */
        @media screen and (max-width: 430px) {
            .symbols-list h3 {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }

            .symbols-content {
                margin-bottom: 15px;
            }

            .default-symbols h4,
            .custom-symbols h4 {
                font-size: 0.9rem;
                margin-bottom: 8px;
            }

            .symbols-grid {
                gap: 6px;
            }

            .symbol-tag {
                padding: 4px 8px;
                font-size: 12px;
            }

            .remove-symbol {
                width: 20px;
                height: 20px;
                font-size: 12px;
                margin-left: 6px;
            }

            .symbols-actions {
                flex-direction: column;
                gap: 8px;
            }

            .symbols-actions .btn {
                width: 100%;
            }
        }

        /* æ¨¡æ‹Ÿäº¤æ˜“å†å²æ ·å¼ */
        .simulation-history {
            margin-top: 20px;
        }

        .simulation-history h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .profit {
            color: #27ae60;
            font-weight: bold;
        }

        .loss {
            color: #e74c3c;
            font-weight: bold;
        }

        .no-data {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }

        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .debug-info h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .debug-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #856404;
        }

        /* åˆ·æ–°æ§åˆ¶æ ·å¼ */
        .refresh-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            min-width: 100px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .refresh-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .refresh-status {
            font-size: 12px;
            color: #6c757d;
            margin-left: 10px;
        }

        /* äº¤æ˜“å¯¹è¾“å…¥ç»„æ ·å¼ */
        .symbol-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loss-amount-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 20px;
        }

        .loss-amount-group label {
            font-weight: 600;
            color: #333;
            white-space: nowrap;
        }

        .loss-select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .loss-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .loss-select:hover {
            border-color: #667eea;
        }

        .calculator-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 20px;
        }

        .calculator-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .calculator-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .symbols-list-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 20px;
        }

        .symbols-list-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .symbols-list-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .symbol-input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            color: #333;
            font-size: 14px;
            min-width: 200px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .symbol-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        /* é˜²æ­¢ç§»åŠ¨ç«¯ä¸‹æ‹‰åˆ·æ–° */
        @media screen and (max-width: 768px) {
            body {
                /* é˜²æ­¢iOS Safariçš„ä¸‹æ‹‰åˆ·æ–° */
                overscroll-behavior-y: none;
                -webkit-overflow-scrolling: touch;
            }

            .container {
                /* ç¡®ä¿å®¹å™¨å¯ä»¥æ­£å¸¸æ»šåŠ¨ */
                overscroll-behavior-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* é˜²æ­¢è¡¨æ ¼åŒºåŸŸçš„ä¸‹æ‹‰åˆ·æ–° */
            .table-container {
                overscroll-behavior-y: none;
            }
        }

        /* iPhone 16 Pro Max å’Œå…¶ä»–å¤§å±æ‰‹æœº */
        @media screen and (max-width: 430px) and (max-height: 932px) {
            .container {
                padding: 8px;
            }

            .header h1 {
                font-size: 1.6rem;
                margin-bottom: 8px;
                line-height: 1.2;
            }

            .header p {
                font-size: 0.85rem;
                line-height: 1.3;
            }

            .top-controls {
                flex-direction: column;
                gap: 10px;
                padding: 12px;
                margin-bottom: 15px;
            }

            .refresh-controls {
                flex-direction: column;
                gap: 6px;
                align-items: center;
            }

            .symbol-input-group {
                flex-direction: column;
                gap: 6px;
                align-items: center;
            }

            .loss-amount-group {
                flex-direction: column;
                gap: 6px;
                align-items: center;
                margin-left: 0;
                margin-top: 8px;
            }

            .loss-amount-group label {
                font-size: 0.85rem;
                white-space: nowrap;
            }

            .calculator-group {
                flex-direction: column;
                gap: 6px;
                align-items: center;
                margin-left: 0;
                margin-top: 8px;
            }

            .calculator-btn {
                width: 100%;
                max-width: 260px;
                font-size: 0.85rem;
                padding: 8px 16px;
            }

            .symbols-list-group {
                flex-direction: column;
                gap: 6px;
                align-items: center;
                margin-left: 0;
                margin-top: 8px;
            }

            .symbols-list-btn {
                width: 100%;
                max-width: 260px;
                font-size: 0.85rem;
                padding: 8px 16px;
            }

            .symbol-input {
                min-width: 100%;
                max-width: 260px;
                font-size: 0.9rem;
            }

            .bottom-controls {
                flex-direction: column;
                gap: 8px;
                padding: 12px;
                margin: 15px 0;
            }

            .btn {
                width: 100%;
                max-width: 260px;
                padding: 10px 16px;
                font-size: 0.85rem;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 15px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-card h3 {
                font-size: 1.3rem;
            }

            .stat-card p {
                font-size: 0.8rem;
            }

            .table-container {
                padding: 8px;
                margin-bottom: 12px;
            }

            .table {
                font-size: 0.75rem;
            }

            .table th,
            .table td {
                padding: 6px 3px;
                white-space: nowrap;
            }

            /* ç§»åŠ¨ç«¯éšè—æ¬¡è¦åˆ— */
            .table th:nth-child(7),
            .table th:nth-child(8),
            .table th:nth-child(9),
            .table th:nth-child(10),
            .table th:nth-child(11),
            .table td:nth-child(7),
            .table td:nth-child(8),
            .table td:nth-child(9),
            .table td:nth-child(10),
            .table td:nth-child(11) {
                display: none;
            }

            .expand-btn {
                width: 22px;
                height: 22px;
                font-size: 11px;
            }

            .btn.small {
                padding: 4px 8px;
                font-size: 10px;
            }

            .trend,
            .signal,
            .execution {
                padding: 4px 6px;
                font-size: 0.7rem;
            }

            .history-container {
                padding: 12px;
            }

            .history-record {
                padding: 10px;
            }

            .detail-row {
                flex-direction: column;
                gap: 4px;
                margin-bottom: 8px;
            }

            .label {
                min-width: auto;
                font-size: 0.75rem;
            }

            .rules-section {
                padding: 15px;
                margin-top: 15px;
            }

            .rules-section h2 {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }

            .rule-category h3 {
                font-size: 0.9rem;
                padding: 10px 12px;
            }

            .rule-content {
                padding: 12px;
            }

            .rule-content h4 {
                font-size: 0.9rem;
                margin: 10px 0 6px 0;
            }

            .rule-content li {
                font-size: 0.8rem;
                margin-bottom: 5px;
                line-height: 1.4;
            }
        }

        /* iPhone æ¨ªå±æ¨¡å¼ */
        @media screen and (max-height: 430px) and (orientation: landscape) {
            .container {
                padding: 5px;
            }

            .header {
                margin-bottom: 10px;
            }

            .header h1 {
                font-size: 1.3rem;
                margin-bottom: 3px;
                line-height: 1.1;
            }

            .header p {
                font-size: 0.75rem;
                line-height: 1.2;
            }

            .top-controls {
                flex-direction: row;
                gap: 8px;
                padding: 8px;
                margin-bottom: 10px;
            }

            .refresh-controls {
                flex-direction: row;
                gap: 4px;
            }

            .symbol-input-group {
                flex-direction: row;
                gap: 4px;
            }

            .symbol-input {
                min-width: 100px;
                max-width: 120px;
                font-size: 0.8rem;
            }

            .loss-amount-group {
                margin-left: 8px;
            }

            .loss-amount-group label {
                font-size: 0.75rem;
            }

            .calculator-btn,
            .symbols-list-btn {
                font-size: 0.75rem;
                padding: 6px 12px;
            }

            .bottom-controls {
                flex-direction: row;
                gap: 8px;
                padding: 8px;
                margin: 10px 0;
            }

            .btn {
                font-size: 0.75rem;
                padding: 6px 12px;
            }

            .stats {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                margin-bottom: 10px;
            }

            .stat-card {
                padding: 8px;
            }

            .stat-card h3 {
                font-size: 1.1rem;
            }

            .stat-card p {
                font-size: 0.7rem;
            }

            .table-container {
                padding: 6px;
            }

            .table {
                font-size: 0.7rem;
            }

            .table th,
            .table td {
                padding: 4px 2px;
            }

            .trend,
            .signal,
            .execution {
                padding: 3px 5px;
                font-size: 0.65rem;
            }

            .expand-btn {
                width: 20px;
                height: 20px;
                font-size: 10px;
            }

            .btn.small {
                padding: 3px 6px;
                font-size: 9px;
            }

            .rules-section {
                display: none;
                /* æ¨ªå±æ—¶éšè—è§„åˆ™è¯´æ˜ä»¥èŠ‚çœç©ºé—´ */
            }
        }

        /* å¹³æ¿è®¾å¤‡ */
        @media screen and (min-width: 768px) and (max-width: 1024px) {
            .container {
                padding: 15px;
            }

            .top-controls {
                gap: 20px;
            }

            .symbol-input {
                min-width: 250px;
            }

            .table th,
            .table td {
                padding: 12px 8px;
                font-size: 0.9rem;
            }
        }

        /* æ¡Œé¢ç«¯ä¼˜åŒ– */
        @media screen and (min-width: 1025px) {
            .container {
                max-width: 1600px;
            }

            .top-controls {
                gap: 30px;
            }

            .symbol-input {
                min-width: 300px;
            }

            .table th,
            .table td {
                padding: 15px 10px;
                font-size: 1rem;
            }

            .btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .top-controls {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .refresh-controls {
                justify-content: center;
            }

            .symbol-input-group {
                justify-content: center;
            }

            .symbol-input {
                min-width: 150px;
            }

            .bottom-controls {
                flex-direction: column;
                align-items: center;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 300px;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .table-container {
                padding: 15px;
            }

            .table th,
            .table td {
                padding: 10px 8px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ SmartFlow äº¤æ˜“ç­–ç•¥ä»ªè¡¨æ¿</h1>
            <p>åŸºäºå¤šå‘¨æœŸå…±æŒ¯çš„é«˜èƒœç‡é«˜ç›ˆäºæ¯”åŠ å¯†è´§å¸äº¤æ˜“ç­–ç•¥</p>
        </div>

        <!-- é¡¶éƒ¨æŒ‰é’®åŒºåŸŸ -->
        <div class="top-controls">
            <div class="refresh-controls">
                <button class="btn" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                    â° è‡ªåŠ¨åˆ·æ–°
                </button>
                <select id="refreshInterval" onchange="updateRefreshInterval()" class="refresh-select">
                    <option value="300000">5åˆ†é’Ÿ</option>
                    <option value="900000">15åˆ†é’Ÿ</option>
                    <option value="1800000">30åˆ†é’Ÿ</option>
                    <option value="3600000">1å°æ—¶</option>
                    <option value="14400000">4å°æ—¶</option>
                    <option value="86400000">1å¤©</option>
                </select>
                <span id="refreshStatus" class="refresh-status"></span>
            </div>
            <button class="btn primary" onclick="refreshAllSignals()">
                ğŸ”„ æ‰‹åŠ¨åˆ·æ–°
            </button>
            <div class="symbol-input-group">
                <input type="text" id="customSymbol" placeholder="è¾“å…¥äº¤æ˜“å¯¹ (å¦‚: ADAUSDT)" class="symbol-input">
                <button class="btn secondary" onclick="addCustomSymbol()">
                    â• æ·»åŠ äº¤æ˜“å¯¹
                </button>
            </div>
            <div class="loss-amount-group">
                <label for="maxLossAmount">ğŸ’° å•æ¬¡äº¤æ˜“æœ€å¤§æŸå¤±ï¼š</label>
                <select id="maxLossAmount" class="loss-select" onchange="updateMaxLossAmount()">
                    <option value="10">10 USDT</option>
                    <option value="20" selected>20 USDT</option>
                    <option value="50">50 USDT</option>
                    <option value="100">100 USDT</option>
                </select>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3 id="totalSignals">0</h3>
                <p>æ€»ä¿¡å·æ•°</p>
            </div>
            <div class="stat-card">
                <h3 id="longSignals">0</h3>
                <p>å¤šå¤´ä¿¡å·</p>
            </div>
            <div class="stat-card">
                <h3 id="shortSignals">0</h3>
                <p>ç©ºå¤´ä¿¡å·</p>
            </div>
            <div class="stat-card">
                <h3 id="lastUpdate">--</h3>
                <p>æœ€åæ›´æ–°</p>
            </div>
            <div class="stat-card win-rate-card">
                <h3 id="winRate">0%</h3>
                <p>ç­–ç•¥èƒœç‡</p>
                <small id="winRateDetails">0/0</small>
            </div>
        </div>

        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>è¯¦æƒ…</th>
                        <th>äº¤æ˜“å¯¹</th>
                        <th>è¶‹åŠ¿</th>
                        <th>ä¿¡å·</th>
                        <th>å…¥åœºæ‰§è¡Œ</th>
                        <th>å½“å‰ä»·æ ¼</th>
                        <th>VWAP</th>
                        <th>æˆäº¤é‡å€æ•°</th>
                        <th>OIå˜åŒ–%</th>
                        <th>èµ„é‡‘è´¹ç‡</th>
                        <th>CVD</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="signalsTable">
                    <tr>
                        <td colspan="12" class="loading">ç‚¹å‡»"åˆ·æ–°æ‰€æœ‰ä¿¡å·"å¼€å§‹åˆ†æ</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- æ¨¡æ‹Ÿäº¤æ˜“å†å²è¡¨æ ¼ -->
        <div class="table-container simulation-history" id="simulationHistoryContainer" style="display: none;">
            <h3>ğŸ“Š æ¨¡æ‹Ÿäº¤æ˜“å†å²</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>äº¤æ˜“å¯¹</th>
                        <th>å…¥åœºä»·æ ¼</th>
                        <th>æ­¢æŸä»·æ ¼</th>
                        <th>æ­¢ç›ˆä»·æ ¼</th>
                        <th>æ æ†å€æ•°</th>
                        <th>æœ€å°ä¿è¯é‡‘</th>
                        <th>å…¥åœºæ—¶é—´</th>
                        <th>å‡ºåœºæ—¶é—´</th>
                        <th>å‡ºåœºä»·æ ¼</th>
                        <th>å‡ºåœºåŸå› </th>
                        <th>è§¦å‘åŸå› </th>
                        <th>ç›ˆäº</th>
                        <th>ç»“æœ</th>
                    </tr>
                </thead>
                <tbody id="simulationHistoryTable">
                    <tr>
                        <td colspan="13" class="loading">åŠ è½½ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- åº•éƒ¨æŒ‰é’®åŒºåŸŸ -->
        <div class="bottom-controls">
            <button class="btn secondary" onclick="testAPI()">
                ğŸ§ª æµ‹è¯•APIè¿æ¥
            </button>
            <button class="btn secondary" onclick="loadDataMonitor()">
                ğŸ“Š æŸ¥çœ‹æ•°æ®ç›‘æ§
            </button>
            <button class="btn secondary" onclick="viewTelegramConfig()">
                ğŸ“± Telegramé€šçŸ¥
            </button>
            <button class="btn calculator-btn" onclick="openRollupCalculator()">
                ğŸ“Š æ–æ³¢æ‹‰å¥‘æ»šä»“è®¡ç®—å™¨
            </button>
            <button class="btn symbols-list-btn" onclick="showSymbolsList()">
                ğŸ“‹ äº¤æ˜“å¯¹ç®¡ç† (${allSymbols.length})
            </button>
            <button class="btn secondary" onclick="toggleSimulationHistory()">
                ğŸ“ˆ æ¨¡æ‹Ÿäº¤æ˜“å†å²
            </button>
        </div>

        <!-- ç­–ç•¥è§„åˆ™è¯´æ˜ -->
        <div class="rules-section">
            <h2>ğŸ“‹ äº¤æ˜“ç­–ç•¥è§„åˆ™è¯´æ˜</h2>

            <div class="rule-category">
                <h3>ğŸ¯ è¶‹åŠ¿åˆ¤æ–­ (æ—¥çº¿çº§åˆ«)</h3>
                <div class="rule-content">
                    <h4>å¤šå¤´è¶‹åŠ¿æ¡ä»¶ï¼š</h4>
                    <ul>
                        <li>MA20 > MA50 > MA200 (ç§»åŠ¨å¹³å‡çº¿å¤šå¤´æ’åˆ—)</li>
                        <li>å½“å‰ä»·æ ¼ > MA20 (ä»·æ ¼åœ¨çŸ­æœŸå‡çº¿ä¹‹ä¸Š)</li>
                        <li>æ»¡è¶³ä»¥ä¸Šæ¡ä»¶æ—¶æ˜¾ç¤º "å¤šå¤´"</li>
                    </ul>

                    <h4>ç©ºå¤´è¶‹åŠ¿æ¡ä»¶ï¼š</h4>
                    <ul>
                        <li>MA20 < MA50 < MA200 (ç§»åŠ¨å¹³å‡çº¿ç©ºå¤´æ’åˆ—)</li>
                        <li>å½“å‰ä»·æ ¼ < MA20 (ä»·æ ¼åœ¨çŸ­æœŸå‡çº¿ä¹‹ä¸‹)</li>
                        <li>æ»¡è¶³ä»¥ä¸Šæ¡ä»¶æ—¶æ˜¾ç¤º "ç©ºå¤´"</li>
                    </ul>

                    <h4>éœ‡è¡è¶‹åŠ¿ï¼š</h4>
                    <ul>
                        <li>ä¸æ»¡è¶³å¤šå¤´æˆ–ç©ºå¤´æ¡ä»¶æ—¶æ˜¾ç¤º "éœ‡è¡"</li>
                    </ul>
                </div>
            </div>

            <div class="rule-category">
                <h3>ğŸ“Š ä¿¡å·åˆ¤æ–­ (å°æ—¶çº§åˆ«ç¡®è®¤)</h3>
                <div class="rule-content">
                    <h4>å¤šå¤´ä¿¡å·æ¡ä»¶ï¼š</h4>
                    <ul>
                        <li>æ—¥çº¿è¶‹åŠ¿ä¸º "å¤šå¤´" æˆ– "éœ‡è¡"</li>
                        <li>æˆäº¤é‡å€æ•° > 1.5 (å½“å‰æˆäº¤é‡/å¹³å‡æˆäº¤é‡)</li>
                        <li>èµ„é‡‘è´¹ç‡ç»å¯¹å€¼ â‰¤ 0.001 (é¿å…é«˜è´¹ç‡)</li>
                        <li>VWAPç¡®è®¤ï¼šä»·æ ¼ > VWAP</li>
                        <li>20å‘¨æœŸé«˜ä½ç‚¹çªç ´ï¼šå½“å‰ä»·æ ¼ > è¿‡å»20å°æ—¶æœ€é«˜ä»·</li>
                        <li>æŒä»“é‡6å°æ—¶å˜åŒ– > 0 (èµ„é‡‘æµå…¥)</li>
                        <li>CVDæ•°æ®å¯ç”¨ä¸”æ–¹å‘ä¸ºå¤šå¤´</li>
                    </ul>

                    <h4>ç©ºå¤´ä¿¡å·æ¡ä»¶ï¼š</h4>
                    <ul>
                        <li>æ—¥çº¿è¶‹åŠ¿ä¸º "ç©ºå¤´" æˆ– "éœ‡è¡"</li>
                        <li>æˆäº¤é‡å€æ•° > 1.5</li>
                        <li>èµ„é‡‘è´¹ç‡ç»å¯¹å€¼ â‰¤ 0.001</li>
                        <li>VWAPç¡®è®¤ï¼šä»·æ ¼ < VWAP</li>
                        <li>20å‘¨æœŸé«˜ä½ç‚¹çªç ´ï¼šå½“å‰ä»·æ ¼ < è¿‡å»20å°æ—¶æœ€ä½ä»·</li>
                        <li>æŒä»“é‡6å°æ—¶å˜åŒ– < 0 (èµ„é‡‘æµå‡º)</li>
                        <li>CVDæ•°æ®å¯ç”¨ä¸”æ–¹å‘ä¸ºç©ºå¤´</li>
                    </ul>

                    <h4>æ— ä¿¡å·ï¼š</h4>
                    <ul>
                        <li>ä¸æ»¡è¶³å¤šå¤´æˆ–ç©ºå¤´ä¿¡å·æ¡ä»¶æ—¶æ˜¾ç¤º "æ— ä¿¡å·"</li>
                    </ul>
                </div>
            </div>

            <div class="rule-category">
                <h3>âš¡ å…¥åœºæ‰§è¡Œ (15åˆ†é’Ÿçº§åˆ«)</h3>
                <div class="rule-content">
                    <h4>å¤šå¤´å…¥åœºæ¡ä»¶ï¼š</h4>
                    <ul>
                        <li>å°æ—¶ä¿¡å·ä¸º "å¤šå¤´"</li>
                        <li>ä»·æ ¼å›è°ƒè‡³EMA20æˆ–EMA50é™„è¿‘</li>
                        <li>è¯†åˆ«setupHighï¼šå‰ä¸€æ ¹15åˆ†é’ŸKçº¿çš„æœ€é«˜ä»·</li>
                        <li>å½“å‰ä»·æ ¼çªç ´setupHigh</li>
                        <li>æ»¡è¶³ä»¥ä¸Šæ¡ä»¶æ—¶æ˜¾ç¤º "å¤šå¤´å…¥åœº"</li>
                    </ul>

                    <h4>ç©ºå¤´å…¥åœºæ¡ä»¶ï¼š</h4>
                    <ul>
                        <li>å°æ—¶ä¿¡å·ä¸º "ç©ºå¤´"</li>
                        <li>ä»·æ ¼å›è°ƒè‡³EMA20æˆ–EMA50é™„è¿‘</li>
                        <li>è¯†åˆ«setupLowï¼šå‰ä¸€æ ¹15åˆ†é’ŸKçº¿çš„æœ€ä½ä»·</li>
                        <li>å½“å‰ä»·æ ¼è·Œç ´setupLow</li>
                        <li>æ»¡è¶³ä»¥ä¸Šæ¡ä»¶æ—¶æ˜¾ç¤º "ç©ºå¤´å…¥åœº"</li>
                    </ul>

                    <h4>ç­‰å¾…å…¥åœºï¼š</h4>
                    <ul>
                        <li>ä¸æ»¡è¶³å…¥åœºæ¡ä»¶æ—¶æ˜¾ç¤º "ç­‰å¾…å…¥åœº"</li>
                    </ul>
                </div>
            </div>

            <div class="rule-category">
                <h3>ğŸ’° é£é™©æ§åˆ¶æŒ‡æ ‡</h3>
                <div class="rule-content">
                    <h4>ç°ä»·æ­¢æŸè·ç¦»ï¼š</h4>
                    <ul>
                        <li>è®¡ç®—å…¬å¼ï¼š(å½“å‰ä»·æ ¼ - æ­¢æŸä»·æ ¼) / å½“å‰ä»·æ ¼</li>
                        <li>ç”¨äºè¡¡é‡æ­¢æŸä½ç½®ä¸å½“å‰ä»·æ ¼çš„è·ç¦»</li>
                    </ul>

                    <h4>æœ€å¤§æ æ†å€æ•°ï¼š</h4>
                    <ul>
                        <li>è®¡ç®—å…¬å¼ï¼š1 / (ç°ä»·æ­¢æŸè·ç¦» + 0.5%) å‘ä¸‹å–æ•´</li>
                        <li>åŸºäºæ­¢æŸè·ç¦»è®¡ç®—çš„æœ€å¤§å®‰å…¨æ æ†</li>
                    </ul>

                    <h4>æœ€ä½ä¿è¯é‡‘ï¼š</h4>
                    <ul>
                        <li>è®¡ç®—å…¬å¼ï¼šå•æ¬¡äº¤æ˜“æœ€å¤§æŸå¤±é‡‘é¢ / (æœ€å¤§æ æ†å€æ•° Ã— æ­¢æŸè·ç¦») å‘ä¸Šå–æ•´</li>
                        <li>åŸºäºç”¨æˆ·è®¾å®šçš„æœ€å¤§æŸå¤±é‡‘é¢ã€æ æ†å’Œæ­¢æŸè·ç¦»è®¡ç®—</li>
                        <li>ç”¨æˆ·å¯åœ¨é¡¶éƒ¨é€‰æ‹©ï¼š10U/20U/50U/100U</li>
                    </ul>
                </div>
            </div>

            <div class="rule-category">
                <h3>ğŸ“Š æ¨¡æ‹Ÿäº¤æ˜“äº§ç”Ÿé€»è¾‘</h3>
                <div class="rule-content">
                    <h4>æ¨¡æ‹Ÿäº¤æ˜“è§¦å‘æ¡ä»¶ï¼š</h4>
                    <ul>
                        <li><strong>ä¿¡å·æ¨¡æ‹Ÿäº¤æ˜“</strong>ï¼šå½“äº¤æ˜“å¯¹æ»¡è¶³æ‰€æœ‰å°æ—¶çº§åˆ«ç¡®è®¤æ¡ä»¶å¹¶ç”Ÿæˆ"å¤šå¤´"æˆ–"ç©ºå¤´"ä¿¡å·æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºæ¨¡æ‹Ÿäº¤æ˜“</li>
                        <li><strong>æ‰§è¡Œæ¨¡æ‹Ÿäº¤æ˜“</strong>ï¼šå½“äº¤æ˜“å¯¹åœ¨15åˆ†é’Ÿçº§åˆ«æ»¡è¶³å›è¸©EMA20/50æ¡ä»¶å¹¶çªç ´setup candleæ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºæ¨¡æ‹Ÿäº¤æ˜“</li>
                    </ul>

                    <h4>æ¨¡æ‹Ÿäº¤æ˜“å‚æ•°è®¾ç½®ï¼š</h4>
                    <ul>
                        <li><strong>å…¥åœºä»·æ ¼</strong>ï¼šä¿¡å·ç”Ÿæˆæ—¶çš„å½“å‰ä»·æ ¼</li>
                        <li><strong>æ­¢æŸä»·æ ¼</strong>ï¼šsetup candleçš„å¦ä¸€ç«¯æˆ–1.2Ã—ATR(14)ï¼Œå–æ›´è¿œçš„ä½ç½®</li>
                        <li><strong>æ­¢ç›ˆä»·æ ¼</strong>ï¼šåŸºäº2:1ç›ˆäºæ¯”è®¡ç®—çš„ç›®æ ‡ä»·æ ¼</li>
                        <li><strong>æ æ†å€æ•°</strong>ï¼šæ ¹æ®æ­¢æŸè·ç¦»è®¡ç®—çš„æœ€å¤§å®‰å…¨æ æ†</li>
                        <li><strong>æœ€å°ä¿è¯é‡‘</strong>ï¼šåŸºäºç”¨æˆ·è®¾å®šçš„æœ€å¤§æŸå¤±é‡‘é¢è®¡ç®—</li>
                    </ul>

                    <h4>æ¨¡æ‹Ÿäº¤æ˜“ç»“æŸæ¡ä»¶ï¼š</h4>
                    <ul>
                        <li><strong>æ­¢æŸè§¦å‘</strong>ï¼šä»·æ ¼è§¦åŠæ­¢æŸä»·æ ¼ï¼Œè®°å½•ä¸ºäºæŸäº¤æ˜“</li>
                        <li><strong>æ­¢ç›ˆè§¦å‘</strong>ï¼šä»·æ ¼è§¦åŠæ­¢ç›ˆä»·æ ¼ï¼Œè®°å½•ä¸ºç›ˆåˆ©äº¤æ˜“</li>
                        <li><strong>æ—¶é—´é™åˆ¶</strong>ï¼šå…¥åœº8å°æ—¶åæœªè¾¾åˆ°+0.5Rï¼Œå¼ºåˆ¶å¹³ä»“</li>
                    </ul>

                    <h4>èƒœç‡ç»Ÿè®¡è®¡ç®—ï¼š</h4>
                    <ul>
                        <li><strong>æ€»äº¤æ˜“æ•°</strong>ï¼šæ‰€æœ‰å·²ç»“æŸçš„æ¨¡æ‹Ÿäº¤æ˜“æ•°é‡</li>
                        <li><strong>ç›ˆåˆ©äº¤æ˜“æ•°</strong>ï¼šæ­¢ç›ˆè§¦å‘çš„äº¤æ˜“æ•°é‡</li>
                        <li><strong>äºæŸäº¤æ˜“æ•°</strong>ï¼šæ­¢æŸè§¦å‘çš„äº¤æ˜“æ•°é‡</li>
                        <li><strong>èƒœç‡</strong>ï¼šç›ˆåˆ©äº¤æ˜“æ•° / æ€»äº¤æ˜“æ•° Ã— 100%</li>
                    </ul>

                    <h4>è§¦å‘åŸå› è¯´æ˜ï¼š</h4>
                    <ul>
                        <li><strong>ğŸ“Š ä¿¡å·</strong>ï¼šåŸºäºå°æ—¶çº§åˆ«ç¡®è®¤æ¡ä»¶ç”Ÿæˆçš„äº¤æ˜“ä¿¡å·</li>
                        <li><strong>âš¡ æ‰§è¡Œ</strong>ï¼šåŸºäº15åˆ†é’Ÿçº§åˆ«æ‰§è¡Œæ¡ä»¶è§¦å‘çš„å…¥åœºæ‰§è¡Œ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        let maxLossAmount = 20; // é»˜è®¤æœ€å¤§æŸå¤±é‡‘é¢
        let currentRefreshInterval = 300000; // é»˜è®¤5åˆ†é’Ÿ
        let countdownInterval = null;
        let timeUntilNextRefresh = 0;

        // å…¨å±€å˜é‡å­˜å‚¨æ‰€æœ‰äº¤æ˜“å¯¹
        let allSymbols = ['BTCUSDT', 'ETHUSDT', 'LINKUSDT', 'LDOUSDT', 'SOLUSDT'];
        let customSymbols = [];

        // åˆ†æå•ä¸ªäº¤æ˜“å¯¹
        async function analyzeSingleSymbol(symbol) {
            console.log(`ğŸ”„ å¼€å§‹åˆ†æå•ä¸ªäº¤æ˜“å¯¹: ${symbol}`);

            try {
                const response = await fetch(`/api/analyze/${symbol}`);

                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`${symbol} APIé”™è¯¯:`, response.status, errorText);

                    // ç‰¹æ®Šå¤„ç†é€Ÿç‡é™åˆ¶é”™è¯¯
                    if (response.status === 429) {
                        return {
                            symbol,
                            trend: 'RATE_LIMIT',
                            signal: 'RATE_LIMIT',
                            execution: 'RATE_LIMIT',
                            currentPrice: 0,
                            dataError: 'APIè¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•'
                        };
                    }

                    // å…¶ä»–é”™è¯¯
                    return {
                        symbol,
                        trend: 'ERROR',
                        signal: 'ERROR',
                        execution: 'ERROR',
                        currentPrice: 0,
                        dataError: `APIé”™è¯¯ ${response.status}: ${errorText}`
                    };
                }

                const result = await response.json();
                console.log(`âœ… ${symbol} åˆ†æå®Œæˆ:`, result);

                // å°†æ–°åˆ†æçš„ç»“æœæ·»åŠ åˆ°ç°æœ‰è¡¨æ ¼ä¸­
                addSignalToTable(result);

                return result;
            } catch (error) {
                console.error(`${symbol} åˆ†æå¤±è´¥:`, error);
                const errorResult = {
                    symbol,
                    trend: 'ERROR',
                    signal: 'ERROR',
                    execution: 'ERROR',
                    currentPrice: 0,
                    dataError: `åˆ†æå¤±è´¥: ${error.message}`
                };

                // å°†é”™è¯¯ç»“æœæ·»åŠ åˆ°è¡¨æ ¼ä¸­
                addSignalToTable(errorResult);

                return errorResult;
            }
        }

        // å°†ä¿¡å·æ·»åŠ åˆ°è¡¨æ ¼ä¸­
        function addSignalToTable(signal) {
            const tableBody = document.getElementById('signalsTable');

            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨è¯¥äº¤æ˜“å¯¹çš„è¡Œ
            const existingRow = tableBody.querySelector(`tr[data-symbol="${signal.symbol}"]`);

            if (existingRow) {
                // å¦‚æœå­˜åœ¨ï¼Œæ›´æ–°ç°æœ‰è¡Œ
                updateSignalRow(existingRow, signal);
            } else {
                // å¦‚æœä¸å­˜åœ¨ï¼Œæ·»åŠ æ–°è¡Œ
                const newRow = createSignalRow(signal);
                tableBody.appendChild(newRow);
            }
        }


        // æ›´æ–°ä¿¡å·è¡Œ
        function updateSignalRow(row, signal) {
            const trendClass = signal.trend === 'UPTREND' ? 'uptrend' :
                signal.trend === 'DOWNTREND' ? 'downtrend' : 'range';
            const signalClass = signal.signal === 'LONG' ? 'long' :
                signal.signal === 'SHORT' ? 'short' : 'no-signal';
            const executionClass = signal.execution === 'LONG_EXECUTE' ? 'long-execute' :
                signal.execution === 'SHORT_EXECUTE' ? 'short-execute' : 'no-execution';

            // åˆ¤æ–­æ˜¯å¦éœ€è¦é«˜äº®æ˜¾ç¤º
            const shouldHighlightTrend = signal.trend === 'UPTREND' || signal.trend === 'DOWNTREND';
            const shouldHighlightSignal = signal.signal === 'LONG' || signal.signal === 'SHORT';
            const shouldHighlightExecution = signal.execution === 'LONG_EXECUTE' || signal.execution === 'SHORT_EXECUTE';

            row.className = `${trendClass} ${signalClass} ${executionClass}`;
            row.innerHTML = `
                <td>
                    <button class="expand-btn" onclick="toggleHistory('${signal.symbol}')" title="æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯">+</button>
                </td>
                <td>${signal.symbol}</td>
                <td class="trend ${trendClass}${shouldHighlightTrend ? ' highlight' : ''}">${signal.trend || '--'}</td>
                <td class="signal ${signalClass}${shouldHighlightSignal ? ' highlight' : ''}">${signal.signal || '--'}</td>
                <td class="execution ${executionClass}${shouldHighlightExecution ? ' highlight' : ''}">${signal.execution || '--'}</td>
                <td>${signal.currentPrice ? signal.currentPrice.toFixed(4) : '--'}</td>
                <td>${signal.vwap ? signal.vwap.toFixed(4) : '--'}</td>
                <td>${signal.volumeRatio ? signal.volumeRatio.toFixed(2) : '--'}</td>
                <td>${signal.oiChange ? signal.oiChange.toFixed(2) + '%' : '--'}</td>
                <td>${signal.fundingRate ? (signal.fundingRate * 100).toFixed(4) + '%' : '--'}</td>
                <td>${signal.cvdDirection || '--'}</td>
                <td>
                    <button class="btn small" onclick="removeCustomSymbol('${signal.symbol}')" title="åˆ é™¤äº¤æ˜“å¯¹">ğŸ—‘ï¸</button>
                </td>
            `;
        }

        // ä»è¡¨æ ¼ä¸­ç§»é™¤ä¿¡å·è¡Œ
        function removeSignalFromTable(symbol) {
            const tableBody = document.getElementById('signalsTable');
            const row = tableBody.querySelector(`tr[data-symbol="${symbol}"]`);
            const historyRow = document.getElementById(`history-${symbol}`);

            if (row) {
                row.remove();
                console.log(`âœ… å·²ä»è¡¨æ ¼ä¸­ç§»é™¤ ${symbol}`);
            } else {
                console.log(`âš ï¸ æœªæ‰¾åˆ° ${symbol} å¯¹åº”çš„è¡¨æ ¼è¡Œ`);
            }

            if (historyRow) {
                historyRow.remove();
                console.log(`âœ… å·²ä»è¡¨æ ¼ä¸­ç§»é™¤ ${symbol} çš„å†å²è®°å½•è¡Œ`);
            }
        }

        // åˆ·æ–°æ‰€æœ‰ä¿¡å·
        async function refreshAllSignals() {
            const tableBody = document.getElementById('signalsTable');
            tableBody.innerHTML = '<tr><td colspan="12" class="loading">åˆ†æä¸­...</td></tr>';

            console.log('ğŸ”„ å¼€å§‹åˆ·æ–°æ‰€æœ‰ä¿¡å·ï¼Œå½“å‰äº¤æ˜“å¯¹åˆ—è¡¨:', allSymbols);
            console.log('ğŸ“Š äº¤æ˜“å¯¹æ•°é‡:', allSymbols.length);

            try {
                // ä½¿ç”¨åŠ¨æ€äº¤æ˜“å¯¹åˆ—è¡¨ï¼Œæ·»åŠ å»¶è¿Ÿé¿å…é€Ÿç‡é™åˆ¶
                const promises = allSymbols.map(async (symbol, index) => {
                    try {
                        // æ·»åŠ å»¶è¿Ÿé¿å…åŒæ—¶è¯·æ±‚è¿‡å¤š
                        if (index > 0) {
                            await new Promise(resolve => setTimeout(resolve, index * 200));
                        }

                        const response = await fetch(`/api/analyze/${symbol}`);

                        // æ£€æŸ¥å“åº”çŠ¶æ€
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`${symbol} APIé”™è¯¯:`, response.status, errorText);

                            // ç‰¹æ®Šå¤„ç†é€Ÿç‡é™åˆ¶é”™è¯¯
                            if (response.status === 429) {
                                return {
                                    symbol,
                                    trend: 'RATE_LIMIT',
                                    signal: 'RATE_LIMIT',
                                    execution: 'RATE_LIMIT',
                                    currentPrice: 0,
                                    dataError: `è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•`
                                };
                            }

                            return {
                                symbol,
                                trend: 'ERROR',
                                signal: 'ERROR',
                                execution: 'ERROR',
                                currentPrice: 0,
                                dataError: `APIé”™è¯¯ ${response.status}: ${errorText}`
                            };
                        }

                        // å°è¯•è§£æJSON
                        const data = await response.json();
                        return data;
                    } catch (error) {
                        console.error(`${symbol} è¯·æ±‚å¤±è´¥:`, error);

                        // ç‰¹æ®Šå¤„ç†JSONè§£æé”™è¯¯
                        if (error.message.includes('Unexpected token')) {
                            return {
                                symbol,
                                trend: 'PARSE_ERROR',
                                signal: 'PARSE_ERROR',
                                execution: 'PARSE_ERROR',
                                currentPrice: 0,
                                dataError: `æ•°æ®è§£æé”™è¯¯ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨å“åº”æ ¼å¼å¼‚å¸¸`
                            };
                        }

                        return {
                            symbol,
                            trend: 'ERROR',
                            signal: 'ERROR',
                            execution: 'ERROR',
                            currentPrice: 0,
                            dataError: `åˆ†æå¤±è´¥: ${error.message}`
                        };
                    }
                });

                const signals = await Promise.all(promises);
                displaySignals(signals);
                updateStats(signals);

                // æ›´æ–°èƒœç‡ç»Ÿè®¡
                await loadWinRateStats();

                showMessage('ä¿¡å·åˆ·æ–°æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('åˆ·æ–°ä¿¡å·å¤±è´¥:', error);
                tableBody.innerHTML = '<tr><td colspan="12" class="error">åˆ·æ–°å¤±è´¥: ' + error.message + '</td></tr>';
                showMessage('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°æœ€å¤§æŸå¤±é‡‘é¢
        function updateMaxLossAmount() {
            const select = document.getElementById('maxLossAmount');
            maxLossAmount = parseInt(select.value);
            console.log('æœ€å¤§æŸå¤±é‡‘é¢å·²æ›´æ–°ä¸º:', maxLossAmount, 'USDT');

            // å¦‚æœå½“å‰æœ‰æ•°æ®æ˜¾ç¤ºï¼Œé‡æ–°è®¡ç®—ä¿è¯é‡‘
            if (document.querySelector('.table tbody tr:not(.error)')) {
                refreshAllSignals();
            }
        }

        // è®¡ç®—æœ€ä½ä¿è¯é‡‘
        function calculateMinMargin(signal) {
            if (!signal.stopLoss || !signal.maxLeverage || !signal.stopDistance) {
                return '--';
            }

            // æ–°å…¬å¼ï¼šå•æ¬¡äº¤æ˜“æœ€å¤§æŸå¤±é‡‘é¢ / (æœ€å¤§æ æ†å€æ•° Ã— æ­¢æŸè·ç¦») å‘ä¸Šå–æ•´
            const minMargin = Math.ceil(maxLossAmount / (signal.maxLeverage * signal.stopDistance));
            return minMargin.toFixed(0);
        }

        // æ·»åŠ è‡ªå®šä¹‰äº¤æ˜“å¯¹
        async function addCustomSymbol() {
            const symbol = document.getElementById('customSymbol').value.trim().toUpperCase();

            if (!symbol) {
                showMessage('è¯·è¾“å…¥äº¤æ˜“å¯¹', 'error');
                return;
            }

            if (!symbol.endsWith('USDT')) {
                showMessage('äº¤æ˜“å¯¹å¿…é¡»ä»¥ USDT ç»“å°¾', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (allSymbols.includes(symbol)) {
                showMessage('äº¤æ˜“å¯¹å·²å­˜åœ¨', 'error');
                return;
            }

            try {
                showMessage(`æ­£åœ¨æ·»åŠ  ${symbol}...`, 'success');

                // è°ƒç”¨åç«¯APIä¿å­˜åˆ°æ•°æ®åº“
                const response = await fetch('/api/analyze-custom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol: symbol })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'æ·»åŠ äº¤æ˜“å¯¹å¤±è´¥');
                }

                // æ·»åŠ åˆ°äº¤æ˜“å¯¹åˆ—è¡¨
                customSymbols.push(symbol);
                allSymbols.push(symbol);

                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('customSymbol').value = '';

                // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                updateSymbolsListButton();

                // åªåˆ†ææ–°æ·»åŠ çš„äº¤æ˜“å¯¹ï¼Œä¸åˆ·æ–°æ‰€æœ‰äº¤æ˜“å¯¹
                await analyzeSingleSymbol(symbol);

                showMessage(`${symbol} æ·»åŠ æˆåŠŸï¼`, 'success');
            } catch (error) {
                console.error('æ·»åŠ äº¤æ˜“å¯¹å¤±è´¥:', error);
                // å¦‚æœå¤±è´¥ï¼Œä»åˆ—è¡¨ä¸­ç§»é™¤
                const index = customSymbols.indexOf(symbol);
                if (index > -1) {
                    customSymbols.splice(index, 1);
                    allSymbols.splice(allSymbols.indexOf(symbol), 1);
                }
                showMessage('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•APIè¿æ¥
        async function testAPI() {
            try {
                const response = await fetch('/api/test');
                const result = await response.json();

                if (result.summary.passed === result.summary.total) {
                    showMessage('APIè¿æ¥æ­£å¸¸ï¼æ‰€æœ‰æµ‹è¯•é€šè¿‡', 'success');
                } else {
                    showMessage('APIè¿æ¥å¼‚å¸¸ï¼éƒ¨åˆ†æµ‹è¯•å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('APIæµ‹è¯•å¤±è´¥:', error);
                showMessage('APIæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            if (isAutoRefresh) {
                clearInterval(autoRefreshInterval);
                clearInterval(countdownInterval);
                isAutoRefresh = false;
                document.getElementById('autoRefreshBtn').textContent = 'â° è‡ªåŠ¨åˆ·æ–°';
                document.getElementById('refreshStatus').textContent = '';
                showMessage('è‡ªåŠ¨åˆ·æ–°å·²å…³é—­', 'success');
            } else {
                startAutoRefresh();
            }
        }

        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            autoRefreshInterval = setInterval(refreshAllSignals, currentRefreshInterval);
            isAutoRefresh = true;
            timeUntilNextRefresh = currentRefreshInterval;

            // å¯åŠ¨å€’è®¡æ—¶
            startCountdown();

            const intervalText = getIntervalText(currentRefreshInterval);
            document.getElementById('autoRefreshBtn').textContent = 'â¹ï¸ åœæ­¢åˆ·æ–°';
            showMessage(`è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯ï¼ˆ${intervalText}é—´éš”ï¼‰`, 'success');
        }

        // å¼€å§‹å€’è®¡æ—¶
        function startCountdown() {
            countdownInterval = setInterval(() => {
                timeUntilNextRefresh -= 1000;
                updateCountdownDisplay();

                if (timeUntilNextRefresh <= 0) {
                    timeUntilNextRefresh = currentRefreshInterval;
                }
            }, 1000);
        }

        // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
        function updateCountdownDisplay() {
            const minutes = Math.floor(timeUntilNextRefresh / 60000);
            const seconds = Math.floor((timeUntilNextRefresh % 60000) / 1000);

            if (minutes > 0) {
                document.getElementById('refreshStatus').textContent = `ä¸‹æ¬¡åˆ·æ–°: ${minutes}åˆ†${seconds}ç§’`;
            } else {
                document.getElementById('refreshStatus').textContent = `ä¸‹æ¬¡åˆ·æ–°: ${seconds}ç§’`;
            }
        }

        // æ›´æ–°åˆ·æ–°é—´éš”
        function updateRefreshInterval() {
            const select = document.getElementById('refreshInterval');
            currentRefreshInterval = parseInt(select.value);

            if (isAutoRefresh) {
                startAutoRefresh();
            }

            const intervalText = getIntervalText(currentRefreshInterval);
            showMessage(`åˆ·æ–°é—´éš”å·²è®¾ç½®ä¸ºï¼š${intervalText}`, 'success');
        }

        // è·å–é—´éš”æ–‡æœ¬
        function getIntervalText(interval) {
            const intervals = {
                300000: '5åˆ†é’Ÿ',
                900000: '15åˆ†é’Ÿ',
                1800000: '30åˆ†é’Ÿ',
                3600000: '1å°æ—¶',
                14400000: '4å°æ—¶',
                86400000: '1å¤©'
            };
            return intervals[interval] || 'æœªçŸ¥';
        }

        // æ˜¾ç¤ºä¿¡å·
        function displaySignals(signals) {
            const tableBody = document.getElementById('signalsTable');

            if (signals.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="12" class="loading">æš‚æ— ä¿¡å·æ•°æ®</td></tr>';
                return;
            }

            // æ¸…ç©ºè¡¨æ ¼
            tableBody.innerHTML = '';

            // ä¸ºæ¯ä¸ªä¿¡å·åˆ›å»ºè¡Œ
            signals.forEach(signal => {
                createSignalRow(signal);
            });
        }

        // åˆ›å»ºä¿¡å·è¡Œï¼ˆå¤„ç†é”™è¯¯æƒ…å†µï¼‰
        function createSignalRow(signal) {
            // å¤„ç†æ•°æ®é”™è¯¯æƒ…å†µ
            if (signal.trend === 'DATA_ERROR' || signal.trend === 'ERROR' ||
                signal.trend === 'RATE_LIMIT' || signal.trend === 'PARSE_ERROR') {

                let errorClass = 'error';
                let errorIcon = 'âŒ';

                if (signal.trend === 'RATE_LIMIT') {
                    errorClass = 'warning';
                    errorIcon = 'â°';
                } else if (signal.trend === 'PARSE_ERROR') {
                    errorClass = 'error';
                    errorIcon = 'ğŸ”§';
                }

                const row = document.createElement('tr');
                row.setAttribute('data-symbol', signal.symbol);
                row.innerHTML = `
                    <td></td>
                    <td><strong>${signal.symbol}</strong></td>
                    <td colspan="9" class="${errorClass}">
                        ${errorIcon} ${signal.dataError || 'æœªçŸ¥é”™è¯¯'}
                    </td>
                `;
                return row;
            }

            // æ­£å¸¸ä¿¡å·å¤„ç†
            const row = document.createElement('tr');
            row.setAttribute('data-symbol', signal.symbol);

            const trendClass = signal.trend === 'UPTREND' ? 'uptrend' :
                signal.trend === 'DOWNTREND' ? 'downtrend' : 'range';
            const signalClass = signal.signal === 'LONG' ? 'long' :
                signal.signal === 'SHORT' ? 'short' : 'no-signal';
            const executionClass = signal.execution === 'LONG_EXECUTE' ? 'long-execute' :
                signal.execution === 'SHORT_EXECUTE' ? 'short-execute' : 'no-execution';

            // åˆ¤æ–­æ˜¯å¦éœ€è¦é«˜äº®æ˜¾ç¤º
            const shouldHighlightTrend = signal.trend === 'UPTREND' || signal.trend === 'DOWNTREND';
            const shouldHighlightSignal = signal.signal === 'LONG' || signal.signal === 'SHORT';
            const shouldHighlightExecution = signal.execution === 'LONG_EXECUTE' || signal.execution === 'SHORT_EXECUTE';

            row.innerHTML = `
                <td>
                    <button class="expand-btn" onclick="toggleHistory('${signal.symbol}')" title="æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯">+</button>
                </td>
                <td>${signal.symbol}</td>
                <td class="trend ${trendClass}${shouldHighlightTrend ? ' highlight' : ''}">${signal.trend || '--'}</td>
                <td class="signal ${signalClass}${shouldHighlightSignal ? ' highlight' : ''}">${signal.signal || '--'}</td>
                <td class="execution ${executionClass}${shouldHighlightExecution ? ' highlight' : ''}">${signal.execution || '--'}</td>
                <td>${signal.currentPrice ? signal.currentPrice.toFixed(4) : '--'}</td>
                <td>${signal.vwap ? signal.vwap.toFixed(4) : '--'}</td>
                <td>${signal.volumeRatio ? signal.volumeRatio.toFixed(2) : '--'}</td>
                <td>${signal.oiChange ? signal.oiChange.toFixed(2) + '%' : '--'}</td>
                <td>${signal.fundingRate ? (signal.fundingRate * 100).toFixed(4) + '%' : '--'}</td>
                <td>${signal.cvdDirection || '--'}</td>
                <td>
                    <button class="btn small" onclick="removeCustomSymbol('${signal.symbol}')" title="åˆ é™¤äº¤æ˜“å¯¹">ğŸ—‘ï¸</button>
                </td>
            `;

            // åˆ›å»ºæŠ˜å è¡Œ
            const historyRow = document.createElement('tr');
            historyRow.id = `history-${signal.symbol}`;
            historyRow.className = 'history-row';
            historyRow.style.display = 'none';
            historyRow.innerHTML = `
                <td colspan="12">
                    <div class="history-container">
                        <div class="history-header">
                            <h4>ğŸ“Š ${signal.symbol} è¯¦ç»†ä¿¡æ¯</h4>
                            <button class="load-history-btn" onclick="loadHistory('${signal.symbol}')">åŠ è½½å†å²è®°å½•</button>
                        </div>
                        <div id="history-content-${signal.symbol}">
                            <div class="loading">ç‚¹å‡»"åŠ è½½å†å²è®°å½•"æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</div>
                        </div>
                    </div>
                </td>
            `;

            // å°†æŠ˜å è¡Œæ·»åŠ åˆ°è¡¨æ ¼ä¸­
            const tableBody = document.getElementById('signalsTable');
            tableBody.appendChild(row);
            tableBody.appendChild(historyRow);

            return row;
        }


        // æ›´æ–°ç»Ÿè®¡
        function updateStats(signals) {
            const totalSignals = signals.length;
            const longSignals = signals.filter(s => s.signal === 'LONG').length;
            const shortSignals = signals.filter(s => s.signal === 'SHORT').length;

            document.getElementById('totalSignals').textContent = totalSignals;
            document.getElementById('longSignals').textContent = longSignals;
            document.getElementById('shortSignals').textContent = shortSignals;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;

            document.querySelector('.container').insertBefore(messageDiv, document.querySelector('.stats'));

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // æ•°æ®ç›‘æ§åŠŸèƒ½
        async function loadDataMonitor() {
            try {
                const response = await fetch('/api/data-monitor');
                const data = await response.json();

                if (data.error) {
                    showMessage(`æ•°æ®ç›‘æ§åŠ è½½å¤±è´¥: ${data.error}`, 'error');
                    return;
                }

                displayDataMonitor(data);
            } catch (error) {
                showMessage(`æ•°æ®ç›‘æ§åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function displayDataMonitor(data) {
            // åˆ›å»ºç›‘æ§é¢æ¿
            const monitorPanel = document.createElement('div');
            monitorPanel.className = 'monitor-panel';
            monitorPanel.innerHTML = `
                <div class="monitor-header">
                    <h3>ğŸ“Š æ•°æ®å‡†ç¡®æ€§ç›‘æ§</h3>
                    <button onclick="this.parentElement.parentElement.remove()" class="close-btn">Ã—</button>
                </div>
                <div class="monitor-content">
                    <div class="overall-stats">
                        <h4>æ€»ä½“çŠ¶æ€</h4>
                        <div class="stat-item ${data.overall.isHealthy ? 'healthy' : 'unhealthy'}">
                            <span>æˆåŠŸç‡: ${data.overall.successRate}%</span>
                            <span>åˆ†ææ¬¡æ•°: ${data.overall.totalAnalyses}</span>
                            <span>æˆåŠŸæ¬¡æ•°: ${data.overall.successfulAnalyses}</span>
                        </div>
                    </div>
                    <div class="raw-data-stats">
                        <h4>åŸå§‹æ•°æ®æˆåŠŸç‡</h4>
                        ${Object.entries(data.rawDataStats).map(([type, stats]) => `
                            <div class="data-type ${stats.successRate < 100 ? 'warning' : 'normal'}">
                                <span class="data-type-name">${type}</span>
                                <span class="success-rate">${stats.successRate}%</span>
                                <span class="data-count">(${stats.success}/${stats.total})</span>
                                ${stats.failures.length > 0 ? `
                                    <div class="failures">
                                        <strong>å¤±è´¥è®°å½•:</strong>
                                        ${stats.failures.map(f => `
                                            <div class="failure-item">
                                                ${f.symbol}: ${f.error} (${f.timestamp})
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div class="recent-logs">
                        <h4>æœ€è¿‘åˆ†æè®°å½•</h4>
                        ${data.recentLogs.map(log => `
                            <div class="log-item ${log.success ? 'success' : 'error'}">
                                <span class="symbol">${log.symbol}</span>
                                <span class="duration">${log.totalTime}ms</span>
                                <span class="status">${log.success ? 'æˆåŠŸ' : 'å¤±è´¥'}</span>
                                ${!log.success ? `<div class="errors">${log.errors.join(', ')}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // æ·»åŠ æ ·å¼
            if (!document.querySelector('#monitor-styles')) {
                const style = document.createElement('style');
                style.id = 'monitor-styles';
                style.textContent = `
                    .monitor-panel {
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 15px;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        z-index: 1000;
                        max-width: 800px;
                        max-height: 80vh;
                        overflow-y: auto;
                        border: 2px solid #667eea;
                    }
                    .monitor-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px;
                        border-bottom: 1px solid #eee;
                        background: #f8f9fa;
                        border-radius: 15px 15px 0 0;
                    }
                    .monitor-header h3 {
                        margin: 0;
                        color: #333;
                    }
                    .close-btn {
                        background: #ff4757;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 30px;
                        height: 30px;
                        cursor: pointer;
                        font-size: 18px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .monitor-content {
                        padding: 20px;
                    }
                    .overall-stats, .raw-data-stats, .recent-logs {
                        margin-bottom: 20px;
                    }
                    .overall-stats h4, .raw-data-stats h4, .recent-logs h4 {
                        margin-bottom: 10px;
                        color: #333;
                        border-bottom: 2px solid #667eea;
                        padding-bottom: 5px;
                    }
                    .stat-item {
                        display: flex;
                        gap: 15px;
                        padding: 10px;
                        border-radius: 8px;
                        margin-bottom: 10px;
                    }
                    .stat-item.healthy {
                        background: #d4edda;
                        color: #155724;
                    }
                    .stat-item.unhealthy {
                        background: #f8d7da;
                        color: #721c24;
                        border: 2px solid #f5c6cb;
                    }
                    .data-type {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 8px;
                        border-radius: 5px;
                        margin-bottom: 5px;
                    }
                    .data-type.normal {
                        background: #e8f5e8;
                    }
                    .data-type.warning {
                        background: #fff3cd;
                        border: 1px solid #ffeaa7;
                    }
                    .data-type-name {
                        font-weight: bold;
                        min-width: 120px;
                    }
                    .success-rate {
                        font-weight: bold;
                        min-width: 60px;
                    }
                    .data-count {
                        color: #666;
                        font-size: 0.9em;
                    }
                    .failures {
                        margin-top: 5px;
                        font-size: 0.9em;
                    }
                    .failure-item {
                        background: #f8d7da;
                        padding: 5px;
                        margin: 2px 0;
                        border-radius: 3px;
                        font-size: 0.8em;
                    }
                    .log-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 8px;
                        border-radius: 5px;
                        margin-bottom: 5px;
                        font-size: 0.9em;
                    }
                    .log-item.success {
                        background: #e8f5e8;
                    }
                    .log-item.error {
                        background: #f8d7da;
                    }
                    .symbol {
                        font-weight: bold;
                        min-width: 80px;
                    }
                    .duration {
                        min-width: 60px;
                        color: #666;
                    }
                    .status {
                        min-width: 40px;
                    }
                    .errors {
                        color: #721c24;
                        font-size: 0.8em;
                    }
                `;
                document.head.appendChild(style);
            }

            // ç§»é™¤ç°æœ‰çš„ç›‘æ§é¢æ¿
            const existingPanel = document.querySelector('.monitor-panel');
            if (existingPanel) {
                existingPanel.remove();
            }

            document.body.appendChild(monitorPanel);
        }

        // åˆ‡æ¢å†å²è®°å½•æ˜¾ç¤º
        function toggleHistory(symbol) {
            const historyRow = document.getElementById(`history-${symbol}`);
            if (historyRow.style.display === 'none') {
                historyRow.style.display = 'table-row';
                loadHistory(symbol);
            } else {
                historyRow.style.display = 'none';
            }
        }

        // åŠ è½½å†å²è®°å½•
        async function loadHistory(symbol) {
            const contentDiv = document.getElementById(`history-content-${symbol}`);
            contentDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`/api/history/${symbol}?limit=20`);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    displayHistoryRecords(data.data, contentDiv);
                } else {
                    contentDiv.innerHTML = '<div class="no-data">æš‚æ— å†å²è®°å½•</div>';
                }
            } catch (error) {
                contentDiv.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ˜¾ç¤ºå†å²è®°å½•
        function displayHistoryRecords(records, container) {
            const historyHtml = records.map(record => {
                const signalTime = record.signal_time ? new Date(record.signal_time).toLocaleString() : 'N/A';
                const executionTime = record.execution_time ? new Date(record.execution_time).toLocaleString() : 'N/A';
                const markerResult = record.marker_result || 'æœªæ ‡è®°';

                return `
                    <div class="history-record">
                        <div class="record-header">
                            <span class="record-time">${signalTime}</span>
                            <span class="record-status ${markerResult === 'æ­£ç¡®' ? 'correct' : markerResult === 'é”™è¯¯' ? 'incorrect' : 'unmarked'}">${markerResult}</span>
                        </div>
                        <div class="record-details">
                            <div class="detail-row">
                                <span class="label">è¶‹åŠ¿:</span> <span class="value">${record.trend}</span>
                                <span class="label">ä¿¡å·:</span> <span class="value">${record.signal}</span>
                                <span class="label">æ‰§è¡Œ:</span> <span class="value">${record.execution || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">ä»·æ ¼:</span> <span class="value">$${record.current_price}</span>
                                <span class="label">VWAP:</span> <span class="value">$${record.vwap || 'N/A'}</span>
                                <span class="label">æˆäº¤é‡å€æ•°:</span> <span class="value">${record.volume_ratio ? record.volume_ratio.toFixed(2) + 'x' : 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">OIå˜åŒ–:</span> <span class="value">${record.oi_change ? record.oi_change.toFixed(2) + '%' : 'N/A'}</span>
                                <span class="label">èµ„é‡‘è´¹ç‡:</span> <span class="value">${record.funding_rate ? (record.funding_rate * 100).toFixed(4) + '%' : 'N/A'}</span>
                                <span class="label">CVD:</span> <span class="value">${record.cvd_direction || 'N/A'}</span>
                            </div>
                            ${record.stop_price ? `
                            <div class="detail-row">
                                <span class="label">æ­¢æŸä»·:</span> <span class="value">$${record.stop_price}</span>
                                <span class="label">ç›®æ ‡ä»·:</span> <span class="value">$${record.target_price || 'N/A'}</span>
                                <span class="label">æœ€å¤§æ æ†:</span> <span class="value">${record.max_leverage || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">æœ€ä½ä¿è¯é‡‘:</span> <span class="value">$${calculateMinMargin(record)}</span>
                                <span class="label">ç›ˆäºæ¯”:</span> <span class="value">${record.risk_reward_ratio || 'N/A'}</span>
                                <span class="label">æ‰§è¡Œæ—¶é—´:</span> <span class="value">${executionTime}</span>
                            </div>
                            ` : ''}
                            ${record.marker_notes ? `<div class="record-notes">å¤‡æ³¨: ${record.marker_notes}</div>` : ''}
                            <div class="record-actions">
                                <button onclick="markResult(${record.id}, 'signal', '${record.symbol}', 'æ­£ç¡®')" class="mark-btn correct">âœ“ æ­£ç¡®</button>
                                <button onclick="markResult(${record.id}, 'signal', '${record.symbol}', 'é”™è¯¯')" class="mark-btn incorrect">âœ— é”™è¯¯</button>
                                <button onclick="markResult(${record.id}, 'signal', '${record.symbol}', 'æœªæ ‡è®°')" class="mark-btn unmarked">â—‹ æœªæ ‡è®°</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = historyHtml;
        }

        // æ ‡è®°ç»“æœ
        async function markResult(recordId, recordType, symbol, result) {
            try {
                const response = await fetch('/api/mark-result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recordId,
                        recordType,
                        symbol,
                        result
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('æ ‡è®°æˆåŠŸï¼', 'success');
                    // é‡æ–°åŠ è½½å†å²è®°å½•
                    loadHistory(symbol);
                } else {
                    showMessage('æ ‡è®°å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('æ ‡è®°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç§»åŠ¨ç«¯æ‰‹åŠ¿æ”¯æŒ
        // è§¦æ‘¸äº‹ä»¶å¤„ç† - é˜²æ­¢æ„å¤–åˆ·æ–°
        let touchStartX = 0;
        let touchStartY = 0;
        let touchStartTime = 0;
        let isScrolling = false;

        // é˜²æ­¢é¡µé¢ä¸‹æ‹‰åˆ·æ–°
        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
            isScrolling = false;
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (!touchStartX || !touchStartY) return;

            const touchCurrentX = e.touches[0].clientX;
            const touchCurrentY = e.touches[0].clientY;

            const diffX = Math.abs(touchStartX - touchCurrentX);
            const diffY = Math.abs(touchStartY - touchCurrentY);

            // å¦‚æœä¸»è¦æ˜¯å‚ç›´æ»šåŠ¨ï¼Œæ ‡è®°ä¸ºæ»šåŠ¨çŠ¶æ€
            if (diffY > diffX && diffY > 10) {
                isScrolling = true;
            }

            // å¦‚æœç”¨æˆ·åœ¨é¡µé¢é¡¶éƒ¨ä¸‹æ‹‰ï¼Œé˜»æ­¢é»˜è®¤çš„ä¸‹æ‹‰åˆ·æ–°è¡Œä¸º
            if (window.scrollY === 0 && touchCurrentY > touchStartY) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchend', (e) => {
            if (!touchStartX || !touchStartY) return;

            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const touchEndTime = Date.now();

            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;
            const touchDuration = touchEndTime - touchStartTime;

            // åªæœ‰åœ¨éæ»šåŠ¨çŠ¶æ€ä¸‹ï¼Œä¸”æ˜¯æ˜ç¡®çš„ä¸‹æ‹‰æ‰‹åŠ¿æ—¶æ‰è§¦å‘åˆ·æ–°
            if (!isScrolling &&
                Math.abs(diffY) > Math.abs(diffX) &&
                diffY < -80 &&
                touchDuration > 200 &&
                touchDuration < 1000) {
                refreshAllSignals();
            }

            touchStartX = 0;
            touchStartY = 0;
            touchStartTime = 0;
            isScrolling = false;
        }, { passive: false });

        // é˜²æ­¢åŒå‡»ç¼©æ”¾
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });

        // Telegramé…ç½®ç›¸å…³å‡½æ•°
        async function viewTelegramConfig() {
            try {
                const response = await fetch('/api/telegram-status');
                const status = await response.json();

                const configHtml = `
                    <div class="telegram-config">
                        <h3>ğŸ“± Telegram é€šçŸ¥é…ç½®</h3>
                        <div class="config-status">
                            <p><strong>é…ç½®çŠ¶æ€ï¼š</strong> 
                                <span class="${status.configured ? 'status-success' : 'status-error'}">
                                    ${status.configured ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}
                                </span>
                            </p>
                            <p><strong>Bot Tokenï¼š</strong> 
                                <span class="${status.hasToken ? 'status-success' : 'status-error'}">
                                    ${status.hasToken ? 'âœ… å·²è®¾ç½®' : 'âŒ æœªè®¾ç½®'}
                                </span>
                                ${status.debug ? ` (é•¿åº¦: ${status.debug.botTokenLength})` : ''}
                            </p>
                            <p><strong>Chat IDï¼š</strong> 
                                <span class="${status.hasChatId ? 'status-success' : 'status-error'}">
                                    ${status.hasChatId ? 'âœ… å·²è®¾ç½®' : 'âŒ æœªè®¾ç½®'}
                                </span>
                                ${status.debug ? ` (å€¼: ${status.debug.chatIdValue})` : ''}
                            </p>
                        </div>
                        ${status.debug ? `
                        <div class="debug-info">
                            <h4>ğŸ” è°ƒè¯•ä¿¡æ¯ï¼š</h4>
                            <p><strong>ç¯å¢ƒå˜é‡ Bot Tokenï¼š</strong> ${status.debug.envBotToken}</p>
                            <p><strong>ç¯å¢ƒå˜é‡ Chat IDï¼š</strong> ${status.debug.envChatId}</p>
                            <p><strong>Node ç¯å¢ƒï¼š</strong> ${status.debug.nodeEnv}</p>
                        </div>
                        ` : ''}
                        <div class="config-instructions">
                            <h4>ğŸ“‹ é…ç½®æ­¥éª¤ï¼š</h4>
                            <ol>
                                <li>åœ¨Telegramä¸­æœç´¢ <code>@BotFather</code> å¹¶åˆ›å»ºæ–°æœºå™¨äºº</li>
                                <li>è·å–Bot Tokenï¼ˆæ ¼å¼ï¼š123456789:ABCdefGHIjklMNOpqrsTUVwxyzï¼‰</li>
                                <li>å°†Bot Tokenè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ <code>TELEGRAM_BOT_TOKEN</code></li>
                                <li>è·å–æ‚¨çš„Chat IDï¼ˆå¯ä»¥ç»™æœºå™¨äººå‘é€æ¶ˆæ¯ï¼Œç„¶åè®¿é—® <code>https://api.telegram.org/bot&lt;YOUR_BOT_TOKEN&gt;/getUpdates</code>ï¼‰</li>
                                <li>å°†Chat IDè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ <code>TELEGRAM_CHAT_ID</code></li>
                                <li>é‡å¯æœåŠ¡å™¨ä½¿ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ</li>
                                <li>è®¿é—® <a href="https://smart.aimaventop.com" target="_blank">https://smart.aimaventop.com</a> æµ‹è¯•é…ç½®</li>
                            </ol>
                        </div>
                        <div class="config-actions">
                            <button class="btn primary" onclick="testTelegramNotification()" ${!status.configured ? 'disabled' : ''}>
                                ğŸ§ª æµ‹è¯•é€šçŸ¥
                            </button>
                            <button class="btn secondary" onclick="closeTelegramConfig()">
                                âŒ å…³é—­
                            </button>
                        </div>
                    </div>
                `;

                showModal('Telegramé…ç½®', configHtml);
            } catch (error) {
                showMessage('è·å–Telegramé…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function testTelegramNotification() {
            try {
                const response = await fetch('/api/test-telegram', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('æµ‹è¯•æ¶ˆæ¯å·²å‘é€ï¼Œè¯·æ£€æŸ¥Telegram', 'success');
                } else {
                    showMessage('æµ‹è¯•å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('æµ‹è¯•Telegramé€šçŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        function closeTelegramConfig() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }

        function showModal(title, content) {
            // ç§»é™¤ç°æœ‰æ¨¡æ€æ¡†
            const existingModal = document.querySelector('.modal');
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>${title}</h2>
                        <button class="modal-close" onclick="closeTelegramConfig()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // æ˜¾ç¤ºäº¤æ˜“å¯¹åˆ—è¡¨
        function showSymbolsList() {
            const defaultSymbols = ['BTCUSDT', 'ETHUSDT', 'LINKUSDT', 'LDOUSDT', 'SOLUSDT'];
            const customSymbolsList = customSymbols;

            const listHtml = `
                <div class="symbols-list">
                    <h3>ğŸ“‹ äº¤æ˜“å¯¹ç®¡ç†</h3>
                    <div class="symbols-content">
                        <div class="default-symbols">
                            <h4>é»˜è®¤äº¤æ˜“å¯¹ (${defaultSymbols.length})</h4>
                            <div class="symbols-grid">
                                ${defaultSymbols.map(symbol =>
                `<span class="symbol-tag default-tag">
                    ${symbol}
                    <span class="symbol-status">ğŸ”’ ç³»ç»Ÿé»˜è®¤</span>
                </span>`
            ).join('')}
                            </div>
                        </div>
                        <div class="custom-symbols">
                            <h4>è‡ªå®šä¹‰äº¤æ˜“å¯¹ (${customSymbolsList.length})</h4>
                            <div class="symbols-grid">
                                ${customSymbolsList.length > 0 ?
                    customSymbolsList.map(symbol =>
                        `<span class="symbol-tag custom-tag">
                            ${symbol}
                            <button class="remove-symbol" onclick="removeCustomSymbol('${symbol}')" title="åˆ é™¤äº¤æ˜“å¯¹">ğŸ—‘ï¸</button>
                        </span>`
                    ).join('') :
                    '<span class="no-symbols">æš‚æ— è‡ªå®šä¹‰äº¤æ˜“å¯¹</span>'
                }
                            </div>
                        </div>
                    </div>
                    <div class="symbols-actions">
                        <button class="btn secondary" onclick="closeSymbolsList()">å…³é—­</button>
                    </div>
                </div>
            `;

            showModal('äº¤æ˜“å¯¹ç®¡ç†', listHtml);
        }

        // ç§»é™¤è‡ªå®šä¹‰äº¤æ˜“å¯¹
        async function removeCustomSymbol(symbol) {
            if (confirm(`ç¡®å®šè¦ç§»é™¤äº¤æ˜“å¯¹ ${symbol} å—ï¼Ÿ`)) {
                try {
                    // è°ƒç”¨åç«¯APIåˆ é™¤äº¤æ˜“å¯¹
                    const response = await fetch(`/api/symbol/${symbol}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        // ä»å‰ç«¯åˆ—è¡¨ä¸­ç§»é™¤
                        const index = customSymbols.indexOf(symbol);
                        if (index > -1) {
                            customSymbols.splice(index, 1);
                            allSymbols.splice(allSymbols.indexOf(symbol), 1);
                        }

                        // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                        updateSymbolsListButton();

                        // ä»è¡¨æ ¼ä¸­ç§»é™¤å¯¹åº”çš„è¡Œ
                        removeSignalFromTable(symbol);

                        showMessage(`${symbol} å·²æˆåŠŸç§»é™¤`, 'success');

                        // å…³é—­æ¨¡æ€æ¡†
                        closeSymbolsList();
                    } else {
                        showMessage(`ç§»é™¤å¤±è´¥: ${result.message}`, 'error');
                    }
                } catch (error) {
                    console.error('åˆ é™¤äº¤æ˜“å¯¹å¤±è´¥:', error);
                    showMessage(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        // æ›´æ–°äº¤æ˜“å¯¹åˆ—è¡¨æŒ‰é’®
        function updateSymbolsListButton() {
            const button = document.querySelector('.symbols-list-btn');
            if (button) {
                button.textContent = `ğŸ“‹ äº¤æ˜“å¯¹ç®¡ç† (${allSymbols.length})`;
            }
        }

        // å…³é—­äº¤æ˜“å¯¹åˆ—è¡¨
        function closeSymbolsList() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }

        // æ‰“å¼€æ–æ³¢æ‹‰å¥‘æ»šä»“è®¡ç®—å™¨
        function openRollupCalculator() {
            // è·å–å½“å‰çš„æœ€å¤§æŸå¤±é‡‘é¢
            const currentMaxLoss = document.getElementById('maxLossAmount').value;

            // åˆ›å»ºæ–°çª—å£
            const calculatorWindow = window.open(
                'rollup-calculator.html',
                'rollupCalculator',
                'width=1200,height=800,scrollbars=yes,resizable=yes,status=yes,toolbar=no,menubar=no,location=no'
            );

            // ç­‰å¾…çª—å£åŠ è½½å®Œæˆåè®¾ç½®é»˜è®¤å€¼
            if (calculatorWindow) {
                calculatorWindow.addEventListener('load', function () {
                    try {
                        const maxLossInput = calculatorWindow.document.getElementById('maxLossAmount');
                        if (maxLossInput) {
                            maxLossInput.value = currentMaxLoss;
                        }
                    } catch (error) {
                        console.log('æ— æ³•è®¾ç½®é»˜è®¤å€¼:', error);
                    }
                });
            }
        }

        // åŠ è½½èƒœç‡ç»Ÿè®¡
        async function loadWinRateStats() {
            try {
                const response = await fetch('/api/win-rate-stats');
                const stats = await response.json();

                document.getElementById('winRate').textContent = stats.win_rate.toFixed(1) + '%';
                document.getElementById('winRateDetails').textContent = `${stats.total_wins}/${stats.total_trades}`;
            } catch (error) {
                console.error('åŠ è½½èƒœç‡ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢æ¨¡æ‹Ÿäº¤æ˜“å†å²æ˜¾ç¤º
        async function toggleSimulationHistory() {
            const container = document.getElementById('simulationHistoryContainer');
            const isVisible = container.style.display !== 'none';

            if (isVisible) {
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
                await loadSimulationHistory();
            }
        }

        // åŠ è½½æ¨¡æ‹Ÿäº¤æ˜“å†å²
        async function loadSimulationHistory() {
            const tableBody = document.getElementById('simulationHistoryTable');
            tableBody.innerHTML = '<tr><td colspan="13" class="loading">åŠ è½½ä¸­...</td></tr>';

            try {
                const response = await fetch('/api/simulation-history?limit=50');
                const history = await response.json();

                if (history.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="13" class="no-data">æš‚æ— æ¨¡æ‹Ÿäº¤æ˜“è®°å½•</td></tr>';
                    return;
                }

                tableBody.innerHTML = history.map(sim => `
                    <tr>
                        <td>${sim.symbol || '--'}</td>
                        <td>${sim.entry_price ? sim.entry_price.toFixed(4) : '--'}</td>
                        <td>${sim.stop_loss_price ? sim.stop_loss_price.toFixed(4) : '--'}</td>
                        <td>${sim.take_profit_price ? sim.take_profit_price.toFixed(4) : '--'}</td>
                        <td>${sim.max_leverage ? sim.max_leverage + 'x' : '--'}</td>
                        <td>${sim.min_margin ? sim.min_margin.toFixed(2) + ' USDT' : '--'}</td>
                        <td>${sim.entry_time ? new Date(sim.entry_time).toLocaleString() : '--'}</td>
                        <td>${sim.exit_time ? new Date(sim.exit_time).toLocaleString() : 'è¿›è¡Œä¸­'}</td>
                        <td>${sim.exit_price ? sim.exit_price.toFixed(4) : '--'}</td>
                        <td>${sim.exit_reason || '--'}</td>
                        <td>
                            <span class="trigger-reason ${sim.trigger_reason === 'SIGNAL' ? 'signal' : 'execution'}">
                                ${sim.trigger_reason === 'SIGNAL' ? 'ğŸ“Š ä¿¡å·' : 'âš¡ æ‰§è¡Œ'}
                            </span>
                        </td>
                        <td class="${sim.profit_loss !== null && sim.profit_loss >= 0 ? 'profit' : 'loss'}">
                            ${sim.profit_loss !== null ? sim.profit_loss.toFixed(2) + '%' : '--'}
                        </td>
                        <td>
                            ${sim.is_win === null ? 'è¿›è¡Œä¸­' : (sim.is_win ? 'âœ… èƒœ' : 'âŒ è´¥')}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½æ¨¡æ‹Ÿäº¤æ˜“å†å²å¤±è´¥:', error);
                tableBody.innerHTML = '<tr><td colspan="13" class="error">åŠ è½½å¤±è´¥: ' + error.message + '</td></tr>';
            }
        }

        // åŒæ­¥äº¤æ˜“å¯¹åˆ—è¡¨
        async function syncSymbolsList() {
            try {
                console.log('ğŸ”„ å¼€å§‹åŒæ­¥äº¤æ˜“å¯¹åˆ—è¡¨...');
                const response = await fetch('/api/symbols');
                console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', response.status);

                const result = await response.json();
                console.log('ğŸ“‹ APIå“åº”æ•°æ®:', result);

                if (result.success) {
                    // æ›´æ–°å…¨å±€å˜é‡
                    allSymbols = result.data.allSymbols;
                    customSymbols = result.data.customSymbols;

                    console.log('âœ… äº¤æ˜“å¯¹åˆ—è¡¨å·²åŒæ­¥:');
                    console.log('  - æ‰€æœ‰äº¤æ˜“å¯¹:', allSymbols);
                    console.log('  - è‡ªå®šä¹‰äº¤æ˜“å¯¹:', customSymbols);

                    // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                    updateSymbolsListButton();
                } else {
                    console.error('âŒ APIè¿”å›å¤±è´¥:', result);
                }
            } catch (error) {
                console.error('âŒ åŒæ­¥äº¤æ˜“å¯¹åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

            // å…ˆåŒæ­¥äº¤æ˜“å¯¹åˆ—è¡¨
            await syncSymbolsList();

            // ç¡®ä¿äº¤æ˜“å¯¹åˆ—è¡¨å·²æ›´æ–°
            console.log('ğŸ” å½“å‰allSymbols:', allSymbols);
            console.log('ğŸ” å½“å‰customSymbols:', customSymbols);

            // ç„¶ååˆ·æ–°ä¿¡å·
            await refreshAllSignals();

            // æœ€ååŠ è½½èƒœç‡ç»Ÿè®¡
            await loadWinRateStats();

            console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>

</html>