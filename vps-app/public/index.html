<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>SmartFlow 交易策略仪表板</title>
  <link rel="stylesheet" href="css/main.css?v=20250111-16">
  <style>
    .weight-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .weight-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
    }

    .weight-table td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid #e9ecef;
      font-size: 13px;
    }

    .weight-table tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .weight-table tbody tr:hover {
      background-color: #e3f2fd;
    }

    .weight-table td:first-child {
      font-weight: 600;
      text-align: left;
      padding-left: 15px;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- 头部 -->
    <header class="header">
      <h1>🚀 SmartFlow 交易策略仪表板</h1>
      <p>基于多周期共振的高胜率高盈亏比加密货币交易策略</p>
    </header>

    <!-- 控制面板 -->
    <div class="controls">
      <div class="control-group">
      </div>

      <div class="control-group">
        <div class="update-status">
          <span class="status-label">📈 趋势更新：</span>
          <span id="trendUpdateTime" class="status-time">--</span>
        </div>
        <div class="update-status">
          <span class="status-label">📊 信号更新：</span>
          <span id="signalUpdateTime" class="status-time">--</span>
        </div>
        <div class="update-status">
          <span class="status-label">⚡ 执行更新：</span>
          <span id="executionUpdateTime" class="status-time">--</span>
        </div>
      </div>

      <div class="control-group">
        <label for="maxLossAmount">💰 单次交易最大损失：</label>
        <select id="maxLossAmount">
          <option value="10">10 USDT</option>
          <option value="20">20 USDT</option>
          <option value="50">50 USDT</option>
          <option value="100" selected>100 USDT</option>
        </select>
      </div>
    </div>

    <!-- 统计概览 -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3 id="totalSignals">0</h3>
        <p>总信号数</p>
      </div>
      <div class="stat-card">
        <h3 id="longSignals">0</h3>
        <p>多头15min信号</p>
      </div>
      <div class="stat-card">
        <h3 id="shortSignals">0</h3>
        <p>空头15min信号</p>
      </div>
      <div class="stat-card">
        <h3 id="lastUpdate">--</h3>
        <p>最后更新</p>
      </div>
      <div class="stat-card">
        <h3 id="winRate">0%</h3>
        <p>策略胜率</p>
        <small id="winRateDetails">0/0</small>
      </div>
    </div>

    <!-- 功能按钮区域 -->
    <div class="function-buttons">
      <button class="btn secondary" onclick="runSystemTests()">🧪 系统测试</button>
      <a href="monitoring.html" class="btn secondary">📊 监控中心</a>
      <a href="simulation-data.html" class="btn secondary">📈 模拟交易</a>
      <a href="rollup-calculator.html" class="btn calculator-btn">📊 滚仓计算器</a>
      <a href="symbol-management.html" class="btn symbols-list-btn">📋 交易对管理</a>
      <div class="btn-group">
      <a href="data-refresh.html" class="btn info">📊 数据刷新状态</a>
        <button class="btn primary" onclick="refreshData()" title="立即刷新所有数据">🔄 刷新数据</button>
      </div>
    </div>

    <!-- 信号表格 -->
    <div class="table-container">
      <h3>📊 交易信号</h3>
      <div class="table-wrapper">
        <table id="signalsTable">
          <thead>
            <tr>
              <th>详情</th>
              <th>交易对</th>
              <th>分类</th>
              <th>趋势打分</th>
              <th>4H趋势</th>
              <th>多因子得分</th>
              <th>1H加强趋势</th>
              <th>15min信号</th>
              <th>当前价格</th>
              <th>数据采集率</th>
            </tr>
          </thead>
          <tbody id="signalsTableBody">
            <!-- 数据将通过JavaScript动态加载 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 策略规则说明 -->
    <div class="rules-section" id="rulesSection">
      <h2>📋 SmartFlow 交易策略规则说明</h2>

      <div class="strategy-overview">
        <h3>🎯 系统结构（3层共振）</h3>
        <p>4H级趋势判断（4H） → 1H级多因子打分（1H） → 15分钟级别入场判断（15m）</p>
        <p><strong>依赖关系：</strong> 1H打分依赖4H趋势结果，15m入场判断依赖4H趋势和1H打分结果</p>
        <p><strong>更新频率：</strong> 4H趋势每1小时更新，1H打分每5分钟更新，15m入场每2分钟更新</p>
      </div>

      <div class="strategy-overview">
        <h3>📊 多因子打分权重逻辑总结</h3>
        <div class="weight-summary">
          <h4>🎯 核心原则：</h4>
          <ul>
            <li><strong>趋势市1H多因子打分：</strong> VWAP方向一致是必须满足的条件，不计入权重但计入总分（满分6分）</li>
            <li><strong>震荡市1H边界确认：</strong> VWAP作为加分因子，根据交易对分类应用不同权重</li>
            <li><strong>震荡市15分钟入场：</strong> VWAP作为核心因子之一，权重随交易对分类调整</li>
            <li><strong>总分计算：</strong> 所有因子得分总和，不依赖权重，确保公平性</li>
          </ul>

          <h4>📈 交易对分类策略：</h4>
          <ul>
            <li><strong>主流币（BTC/ETH）：</strong> 重视突破确认和OI变化，适合稳定趋势</li>
            <li><strong>高市值趋势币（SOL/BNB）：</strong> 平衡各因子权重，适合中等波动</li>
            <li><strong>热点币（PEPE/WLD）：</strong> 重视成交量和Delta，适合高波动</li>
            <li><strong>小币（其他）：</strong> 重点关注成交量和Delta，适合短线操作</li>
          </ul>
        </div>
      </div>

      <div class="strategy-details">
        <div class="strategy-phase">
          <h3>📈 1. 4H级趋势判断（4H）</h3>
          <div class="phase-content">
            <h4>数据来源：</h4>
            <ul>
              <li><strong>K线数据：</strong> Binance Futures API `/fapi/v1/klines?symbol={symbol}&interval=4h&limit=250`
              </li>
            </ul>

            <h4>指标计算：</h4>
            <ul>
              <li><strong>MA20：</strong> SMA(收盘价, 20) = Σ(收盘价[i-19:i]) / 20</li>
              <li><strong>MA50：</strong> SMA(收盘价, 50) = Σ(收盘价[i-49:i]) / 50</li>
              <li><strong>MA200：</strong> SMA(收盘价, 200) = Σ(收盘价[i-199:i]) / 200</li>
              <li><strong>ADX：</strong> 平均方向指数，使用Wilder平滑法计算，周期14</li>
              <li><strong>BBW（布林带带宽）：</strong> (上轨 - 下轨) / 中轨，其中中轨 = MA20，上下轨 = 中轨 ± 2×标准差</li>
            </ul>

            <h4>判断逻辑（严格按照strategy-v3.md）：</h4>
            <ul>
              <li><strong>多头趋势基础条件：</strong> 收盘价 > MA20 且 MA20 > MA50 且 MA50 > MA200</li>
              <li><strong>空头趋势基础条件：</strong> 收盘价 < MA20 且 MA20 < MA50 且 MA50 < MA200</li>
              <li><strong>连续确认机制：</strong> 至少2根4H K线满足基础条件，确保趋势稳定性</li>
              <li><strong>趋势强度确认：</strong> ADX(14) > 20 且 DI方向正确 AND 布林带带宽扩张</li>
              <li><strong>布林带扩张判断：</strong> 最近10根K线中，后半段平均带宽比前半段大5%以上</li>
              <li><strong>最终判断：</strong> 基础条件 + 连续确认 + 趋势强度确认 = 趋势市，否则 = 震荡市</li>
            </ul>
          </div>
        </div>

        <div class="strategy-phase">
          <h3>⏰ 2. 1H级多因子打分（1H）- 趋势市专用</h3>
          <div class="phase-content">
            <h4>数据来源：</h4>
            <ul>
              <li><strong>K线数据：</strong> `/fapi/v1/klines?symbol={symbol}&interval=1h&limit=50`</li>
              <li><strong>15分钟K线：</strong> `/fapi/v1/klines?symbol={symbol}&interval=15m&limit=50`</li>
              <li><strong>4小时K线：</strong> `/fapi/v1/klines?symbol={symbol}&interval=4h&limit=20`</li>
              <li><strong>资金费率：</strong> `/fapi/v1/fundingRate?symbol={symbol}&limit=1`</li>
              <li><strong>持仓量历史：</strong> `/futures/data/openInterestHist?symbol={symbol}&period=1h&limit=6`</li>
              <li><strong>Delta数据：</strong> WebSocket实时数据，计算买卖盘不平衡</li>
            </ul>

            <h4>多因子打分系统（0-6分）- 分类权重优化版：</h4>
            <ul>
              <li><strong>VWAP方向（必须满足）：</strong> 收盘价 > VWAP（多头趋势）或 收盘价 < VWAP（空头趋势），必须满足否则直接返回0分</li>
              <li><strong>突破确认：</strong> 收盘价突破最近20根4H K线高点（多头）或低点（空头），根据交易对分类应用不同权重</li>
              <li><strong>成交量双确认：</strong> 15m成交量 ≥ 1.5×20期均量 且 1h成交量 ≥ 1.2×20期均量，根据交易对分类应用不同权重</li>
              <li><strong>OI变化：</strong> 多头：6h OI ≥ +2%，空头：6h OI ≤ -3%，根据交易对分类应用不同权重</li>
              <li><strong>资金费率：</strong> -0.05% ≤ 资金费率 ≤ +0.05%，所有交易对权重统一为10%</li>
              <li><strong>Delta不平衡：</strong> 多头：主动买盘 ≥ 卖盘×1.2，空头：主动卖盘 ≥ 买盘×1.2，根据交易对分类应用不同权重</li>
            </ul>

            <h4>权重计算逻辑：</h4>
            <ul>
              <li><strong>因子得分：</strong> 每个因子根据条件满足情况得0-1分</li>
              <li><strong>权重应用：</strong> 根据交易对分类（主流币/高市值强趋势币/热点币/小币）应用不同权重</li>
              <li><strong>总分计算：</strong> 所有因子得分总和，不依赖权重，确保公平性</li>
              <li><strong>VWAP特殊处理：</strong> 必须满足条件，权重为0但计入总分，确保方向一致性</li>
              <li><strong>入场条件：</strong> 总分 ≥ 3分且VWAP方向一致时允许入场</li>
            </ul>

            <h4>趋势市1H多因子打分权重分布：</h4>
            <table class="weight-table">
              <thead>
                <tr>
                  <th>因子</th>
                  <th>主流币</th>
                  <th>高市值强趋势币</th>
                  <th>热点币</th>
                  <th>小币</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>VWAP方向</strong></td>
                  <td>必须满足（不计分）</td>
                  <td>必须满足（不计分）</td>
                  <td>必须满足（不计分）</td>
                  <td>必须满足（不计分）</td>
                </tr>
                <tr>
                  <td><strong>突破确认</strong></td>
                  <td>30%</td>
                  <td>25%</td>
                  <td>15%</td>
                  <td>15%</td>
                </tr>
                <tr>
                  <td><strong>成交量确认</strong></td>
                  <td>20%</td>
                  <td>25%</td>
                  <td>30%</td>
                  <td>30%</td>
                </tr>
                <tr>
                  <td><strong>OI变化</strong></td>
                  <td>25%</td>
                  <td>20%</td>
                  <td>15%</td>
                  <td>15%</td>
                </tr>
                <tr>
                  <td><strong>Delta不平衡</strong></td>
                  <td>15%</td>
                  <td>20%</td>
                  <td>30%</td>
                  <td>30%</td>
                </tr>
                <tr>
                  <td><strong>资金费率</strong></td>
                  <td>10%</td>
                  <td>10%</td>
                  <td>10%</td>
                  <td>10%</td>
                </tr>
              </tbody>
            </table>

            <h4>判断逻辑：</h4>
            <ul>
              <li><strong>VWAP方向必须满足，否则得分=0</strong></li>
              <li><strong>权重计算：</strong> 根据交易对分类应用不同权重，优化打分准确性</li>
              <li><strong>得分 ≥ 3分：</strong> 允许入场（仅趋势市）</li>
              <li><strong>得分 < 3分：</strong> 无信号（NONE）</li>
              <li><strong>最终action：</strong> 得分 ≥ 3分时，多头趋势→做多，空头趋势→做空</li>
            </ul>

            <h4>VWAP时间级别使用说明：</h4>
            <ul>
              <li><strong>趋势市1H多因子打分：</strong> 使用1H VWAP，方向一致性必须满足，否则直接返回0分</li>
              <li><strong>震荡市1H边界判断：</strong> 使用1H VWAP，作为加分因子（价格接近VWAP时加分）</li>
              <li><strong>震荡市15分钟执行：</strong> 使用15m VWAP，作为多因子打分的一部分</li>
              <li><strong>VWAP计算：</strong> 基于典型价格（(H+L+C)/3）和成交量的加权平均，使用最近20根K线</li>
            </ul>
          </div>
        </div>

        <div class="strategy-phase">
          <h3>🔄 2.5. 震荡市1H边界判断</h3>
          <div class="phase-content">
            <h4>数据来源：</h4>
            <ul>
              <li><strong>K线数据：</strong> `/fapi/v1/klines?symbol={symbol}&interval=1h&limit=50`</li>
              <li><strong>Delta数据：</strong> WebSocket实时数据 (1h EMA6平滑)</li>
              <li><strong>持仓量历史：</strong> `/futures/data/openInterestHist?symbol={symbol}&period=1h&limit=6`</li>
            </ul>

            <h4>边界有效性判断（优化版 - 多因子打分系统）：</h4>
            <ul>
              <li><strong>布林带计算：</strong> 20期布林带，K=2，带宽 = (上轨-下轨)/中轨</li>
              <li><strong>多因子打分系统：</strong> 基于6个因子进行量化打分，总分0-6分，根据交易对分类应用不同权重</li>
              <li><strong>连续触碰因子：</strong> 最近6根1H K线触碰次数，最高2分，主流币和高市值趋势币权重30%</li>
              <li><strong>触碰判断：</strong> 下轨：close ≤ lower×(1+0.015)，上轨：close ≥ upper×(1-0.015)</li>
              <li><strong>成交量因子：</strong> 最新1H成交量 ≤ 1.7×20期均量，1分，热点币和小币权重30%</li>
              <li><strong>Delta因子：</strong> |Delta| ≤ 0.02（买卖盘平衡），1分，热点币和小币权重25%</li>
              <li><strong>OI因子：</strong> |6h OI变化| ≤ 2%，1分，所有交易对权重统一为10%</li>
              <li><strong>无突破因子：</strong> 最近20根K线内无新高/新低突破，1分，仅主流币权重5%</li>
              <li><strong>VWAP因子：</strong> 价格接近1H VWAP（1%以内），1分，主流币和高市值趋势币权重20%</li>
            </ul>

            <h4>震荡市1H边界权重计算逻辑：</h4>
            <ul>
              <li><strong>因子得分：</strong> 每个因子根据条件满足情况得0-1分（触碰因子最高2分）</li>
              <li><strong>权重应用：</strong> 根据交易对分类应用不同权重，优化边界判断准确性</li>
              <li><strong>总分计算：</strong> 所有因子得分总和，不依赖权重，确保公平性</li>
              <li><strong>边界有效：</strong> 总分 ≥ 3分时判断边界有效，允许15分钟假突破入场</li>
              <li><strong>灵活判断：</strong> 允许部分条件轻微不符合仍可判定有效</li>
            </ul>

            <h4>震荡市1H区间边界确认权重分布：</h4>
            <table class="weight-table">
              <thead>
                <tr>
                  <th>因子</th>
                  <th>主流币</th>
                  <th>高市值趋势币</th>
                  <th>热点币</th>
                  <th>小币</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>VWAP因子</strong></td>
                  <td>20%</td>
                  <td>20%</td>
                  <td>10%</td>
                  <td>10%</td>
                </tr>
                <tr>
                  <td><strong>触碰因子</strong></td>
                  <td>30%</td>
                  <td>30%</td>
                  <td>25%</td>
                  <td>25%</td>
                </tr>
                <tr>
                  <td><strong>成交量因子</strong></td>
                  <td>20%</td>
                  <td>25%</td>
                  <td>30%</td>
                  <td>30%</td>
                </tr>
                <tr>
                  <td><strong>Delta因子</strong></td>
                  <td>15%</td>
                  <td>15%</td>
                  <td>25%</td>
                  <td>25%</td>
                </tr>
                <tr>
                  <td><strong>OI因子</strong></td>
                  <td>10%</td>
                  <td>10%</td>
                  <td>10%</td>
                  <td>10%</td>
                </tr>
                <tr>
                  <td><strong>无突破因子</strong></td>
                  <td>5%</td>
                  <td>—</td>
                  <td>—</td>
                  <td>—</td>
                </tr>
              </tbody>
            </table>

            <h4>判断逻辑（V3优化版）：</h4>
            <ul>
              <li><strong>边界有效性：</strong> 多因子得分 ≥ 3分时判断边界有效</li>
              <li><strong>灵活判断：</strong> 允许部分条件轻微不符合仍可判定有效</li>
              <li><strong>最终action：</strong> 边界有效时允许15m假突破入场</li>
              <li><strong>数据刷新：</strong> 1H边界判断每5分钟更新一次，确保数据实时性</li>
            </ul>
          </div>
        </div>

        <div class="strategy-phase">
          <h3>⚡ 3. 15分钟级别入场判断（15m）</h3>
          <div class="phase-content">
            <h4>数据来源：</h4>
            <ul>
              <li><strong>K线数据：</strong> `/fapi/v1/klines?symbol={symbol}&interval=15m&limit=50`</li>
              <li><strong>1小时K线：</strong> `/fapi/v1/klines?symbol={symbol}&interval=1h&limit=50`</li>
              <li><strong>Delta数据：</strong> WebSocket实时数据 (15m EMA3平滑)</li>
            </ul>

            <h4>指标计算：</h4>
            <ul>
              <li><strong>EMA20：</strong> EMA(收盘价, 20) = 收盘价 × (2/21) + 前EMA × (19/21)</li>
              <li><strong>EMA50：</strong> EMA(收盘价, 50) = 收盘价 × (2/51) + 前EMA × (49/51)</li>
              <li><strong>ATR14：</strong> ATR(14) = EMA(真实波幅, 14)，真实波幅 = max(最高价-最低价, |最高价-前收盘价|, |最低价-前收盘价|)</li>
            </ul>

            <h4>趋势市入场模式：</h4>
            <ul>
              <li><strong>多头回踩突破：</strong> 价格回踩EMA20/50支撑 + 突破setup candle高点 + 成交量确认</li>
              <li><strong>空头反抽破位：</strong> 价格反抽EMA20/50阻力 + 跌破setup candle低点 + 成交量确认</li>
            </ul>

            <h4>震荡市入场模式（V3优化版 - 多因子确认）：</h4>
            <ul>
              <li><strong>假突破入场：</strong> 15分钟布林带宽收窄 + 假突破验证 + 15分钟多因子确认</li>
              <li><strong>多头假突破：</strong> 突破下沿后快速回撤 + 下轨边界有效 + 多因子得分≥2</li>
              <li><strong>空头假突破：</strong> 突破上沿后快速回撤 + 上轨边界有效 + 多因子得分≥2</li>
              <li><strong>Delta实时计算：</strong> WebSocket实时获取aggTrade数据，15分钟EMA(3)平滑处理</li>
              <li><strong>数据刷新：</strong> 15m入场判断每2分钟更新一次，确保信号及时性</li>
            </ul>

            <h4>震荡市15分钟入场执行权重分布：</h4>
            <table class="weight-table">
              <thead>
                <tr>
                  <th>因子</th>
                  <th>主流币</th>
                  <th>高市值趋势币</th>
                  <th>热点币</th>
                  <th>小币</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>VWAP因子</strong></td>
                  <td>30%</td>
                  <td>20%</td>
                  <td>20%</td>
                  <td>10%</td>
                </tr>
                <tr>
                  <td><strong>Delta因子</strong></td>
                  <td>30%</td>
                  <td>30%</td>
                  <td>20%</td>
                  <td>20%</td>
                </tr>
                <tr>
                  <td><strong>OI因子</strong></td>
                  <td>20%</td>
                  <td>30%</td>
                  <td>20%</td>
                  <td>20%</td>
                </tr>
                <tr>
                  <td><strong>Volume因子</strong></td>
                  <td>20%</td>
                  <td>20%</td>
                  <td>40%</td>
                  <td>50%</td>
                </tr>
              </tbody>
            </table>

            <h4>震荡市具体执行逻辑（V3优化版）：</h4>
            <ul>
              <li><strong>布林带宽收窄：</strong> 15分钟BB宽度 < 0.05（5%）</li>
              <li><strong>假突破验证：</strong> 前一根突破边界 + 当前收回区间内</li>
              <li><strong>多因子确认：</strong> 15m VWAP、Delta、OI、Volume四因子得分≥2分</li>
              <li><strong>实时监控：</strong> 每2分钟检查一次假突破机会，确保不错过信号</li>
              <li><strong>多头假突破：</strong> prevClose < rangeLow 且 lastClose> rangeLow 且 lowerBoundaryValid</li>
              <li><strong>空头假突破：</strong> prevClose > rangeHigh 且 lastClose < rangeHigh 且 upperBoundaryValid</li>
              <li><strong>15分钟多因子打分：</strong> 15m VWAP、Delta、OI、Volume四个因子量化打分，得分范围-4到+4，根据交易对分类应用不同权重</li>
              <li><strong>入场条件：</strong> 多因子得分 ≥ 2分才允许入场</li>
              <li><strong>入场价格：</strong> 假突破回撤后的收盘价</li>
              <li><strong>止损价格：</strong> 突破的边界价格（下轨/上轨）</li>
              <li><strong>止盈价格：</strong> 固定1:2风险回报比</li>
            </ul>

            <h4>震荡市15分钟入场权重计算逻辑：</h4>
            <ul>
              <li><strong>因子得分：</strong> 每个因子根据条件满足情况得-1到+1分</li>
              <li><strong>权重应用：</strong> 根据交易对分类应用不同权重，优化入场判断准确性</li>
              <li><strong>总分计算：</strong> 所有因子得分总和，不依赖权重，确保公平性</li>
              <li><strong>入场条件：</strong> 总分 ≥ 2分且假突破验证通过时允许入场</li>
              <li><strong>权重策略：</strong> 主流币重视VWAP+Delta，热点币重视Volume+Delta，小币重视Volume+OI</li>
            </ul>

            <h4>判断逻辑：</h4>
            <ul>
              <li><strong>趋势市前提：</strong> 4H趋势明确 + 1H VWAP方向一致（必须满足）且1H得分 ≥ 3分</li>
              <li><strong>震荡市前提：</strong> 4H震荡市 + 1H边界有效（下轨或上轨）+ 15分钟布林带宽收窄</li>
              <li><strong>VWAP方向一致性：</strong> 趋势市中价格与1H VWAP方向必须一致，震荡市中VWAP作为加分因子</li>
              <li><strong>趋势市止损：</strong> setup candle另一端 或 1.2×ATR(14)，取更远者</li>
              <li><strong>震荡市止损：</strong> 结构性止损（区间边界失效）+ 多因子止损（得分≤-2）+ 时间止损（3小时）</li>
              <li><strong>趋势市止盈：</strong> 多头2R，空头2R</li>
              <li><strong>震荡市止盈：</strong> 固定RR目标（1:2）+ 时间止盈（3小时）</li>
            </ul>

            <h4>震荡市止盈止损详细逻辑：</h4>
            <ul>
              <li><strong>结构性止损：</strong> 多头跌破下轨-ATR，空头突破上轨+ATR</li>
              <li><strong>多因子止损：</strong> VWAP、Delta、OI、Volume因子得分≤-2时触发</li>
              <li><strong>时间止盈：</strong> 持仓超过3小时自动止盈</li>
              <li><strong>固定RR目标：</strong> 风险回报比1:2，多头止盈=入场+2×(入场-止损)</li>
              <li><strong>空头止盈：</strong> 空头止盈=入场-2×(止损-入场)</li>
            </ul>
          </div>
        </div>

        <div class="strategy-phase">
          <h3>📊 4. 核心指标说明</h3>
          <div class="phase-content">
            <h4>BBW（布林带带宽）：</h4>
            <p>BBW = (上轨 - 下轨) / 中轨</p>
            <p>其中：中轨 = MA20，上轨 = 中轨 + 2×标准差，下轨 = 中轨 - 2×标准差</p>
            <p>BBW扩张：最新BBW > 前一个BBW，表示波动率增加，趋势可能加强</p>

            <h4>VWAP（成交量加权平均价格）：</h4>
            <p>VWAP = Σ(典型价 × 成交量) / Σ(成交量)</p>
            <p>其中：典型价 = (最高价 + 最低价 + 收盘价) / 3</p>
            <p>用于判断价格与成交量加权平均的关系</p>

            <h4>趋势市1H多因子打分系统：</h4>
            <p>基于6个因子进行打分，每个因子0-1分，总分0-6分，根据交易对分类应用不同权重：</p>
            <ul>
              <li><strong>VWAP方向：</strong> 收盘价与VWAP的关系，必须满足否则直接返回0分，权重为0但计入总分</li>
              <li><strong>突破确认：</strong> 是否突破最近20根4H K线的高低点，根据交易对分类应用不同权重</li>
              <li><strong>成交量确认：</strong> 15m成交量≥1.5×20期均量且1h成交量≥1.2×20期均量，根据交易对分类应用不同权重</li>
              <li><strong>OI变化：</strong> 多头6h OI≥+2%，空头6h OI≤-3%，根据交易对分类应用不同权重</li>
              <li><strong>资金费率：</strong> -0.05%≤资金费率≤+0.05%，所有交易对权重统一为10%</li>
              <li><strong>Delta不平衡：</strong> 多头主动买盘≥卖盘×1.2，空头主动卖盘≥买盘×1.2，根据交易对分类应用不同权重</li>
            </ul>

            <h4>震荡市1H边界多因子打分系统：</h4>
            <p>基于6个因子进行量化打分，用于1H边界有效性判断，根据交易对分类应用不同权重：</p>
            <ul>
              <li><strong>连续触碰因子：</strong> 最近6根1H K线触碰次数，最高2分，主流币和高市值趋势币权重30%</li>
              <li><strong>成交量因子：</strong> 最新1H成交量≤1.7×20期均量，1分，热点币和小币权重30%</li>
              <li><strong>Delta因子：</strong> |Delta|≤0.02（买卖盘平衡），1分，热点币和小币权重25%</li>
              <li><strong>OI因子：</strong> |6h OI变化|≤2%，1分，所有交易对权重统一为10%</li>
              <li><strong>无突破因子：</strong> 最近20根K线内无新高/新低突破，1分，仅主流币权重5%</li>
              <li><strong>VWAP因子：</strong> 价格接近1H VWAP（1%以内），1分，主流币和高市值趋势币权重20%</li>
              <li><strong>得分范围：</strong> 0到6分，边界有效：得分≥3时判断边界有效</li>
            </ul>

            <h4>震荡市15分钟入场多因子打分系统：</h4>
            <p>基于4个因子进行量化打分，用于震荡市入场确认和止损判断，根据交易对分类应用不同权重：</p>
            <ul>
              <li><strong>VWAP因子：</strong> 当前价>VWAP→+1，否则-1，主流币权重30%，小币权重10%</li>
              <li><strong>Delta因子：</strong> Delta正值→+1，负值→-1，主流币和高市值趋势币权重30%</li>
              <li><strong>OI因子：</strong> OI上涨→+1，下降→-1，高市值趋势币权重30%</li>
              <li><strong>Volume因子：</strong> 成交量增量→+1，减量→-1，热点币权重40%，小币权重50%</li>
              <li><strong>得分范围：</strong> -4到+4，入场条件：得分≥2时允许入场，止损条件：得分≤-2时触发多因子止损</li>
            </ul>

            <h4>入场模式：</h4>
            <p><strong>模式A（回踩确认）：</strong> 高胜率模式，价格回踩支撑位后突破</p>
            <p><strong>模式B（动能突破）：</strong> 高机会模式，放量突破setup candle</p>
          </div>
        </div>

        <div class="strategy-phase">
          <h3>⚠️ 5. 风险控制与执行规则</h3>
          <div class="phase-content">
            <h4>入场条件：</h4>
            <ul>
              <li><strong>趋势市：</strong> 4H趋势明确 + 1H VWAP方向一致 + 1H得分≥3分 + 15m入场模式</li>
              <li><strong>震荡市：</strong> 4H震荡市 + 1H边界有效 + 15m区间交易或假突破反手</li>
            </ul>

            <h4>出场条件（6种）：</h4>
            <ul>
              <li><strong>1. 止损触发：</strong> 价格触及止损位（趋势市：setup candle另一端或1.2×ATR14；震荡市：区间边界失效）</li>
              <li><strong>2. 止盈触发：</strong> 价格触及止盈位（趋势市2R，震荡市1:2 RR目标）</li>
              <li><strong>3. 趋势反转：</strong> 4H趋势改变或1H得分<3分（趋势市专用）< /li>
              <li><strong>4. 多因子止损：</strong> 多因子得分≤-2（震荡市专用）</li>
              <li><strong>5. 支撑阻力突破：</strong> 价格跌破EMA20/50或关键支撑/阻力位（趋势市专用）</li>
              <li><strong>6. 时间止损：</strong> 持仓时间超过3小时（震荡市）或12小时（趋势市）</li>
            </ul>

            <h4>风控规则：</h4>
            <ul>
              <li><strong>趋势市止损：</strong> setup candle另一端 或 1.2×ATR(14)，取更远者</li>
              <li><strong>震荡市止损：</strong> 结构性止损（区间边界失效）+ 多因子止损（得分≤-2）+ 时间止损（3小时）</li>
              <li><strong>趋势市止盈：</strong> 2R风险回报比</li>
              <li><strong>震荡市止盈：</strong> 固定RR目标（1:2）+ 时间止盈（3小时）</li>
              <li><strong>单笔风险：</strong> 根据全局最大损失设置</li>
              <li><strong>最大持仓：</strong> 同一交易对最多1笔活跃交易</li>
              <li><strong>时间限制：</strong> 趋势市最长12小时，震荡市最长3小时</li>
            </ul>

            <h4>表格列说明：</h4>
            <ul>
              <li><strong>趋势打分列：</strong> 4H趋势判断得分（0-5分），≥3分绿色，<3分灰色< /li>
              <li><strong>4H趋势列：</strong> 4H级别趋势判断结果（多头趋势/空头趋势/震荡市/无趋势）</li>
              <li><strong>多因子得分列：</strong> 根据市场类型显示不同得分
                <ul>
                  <li>趋势市：1H趋势加强多因子打分（0-6分），≥3分绿色</li>
                  <li>震荡市：1H边界有效性判断（0-2分），≥1分绿色</li>
                </ul>
              </li>
              <li><strong>1H加强趋势列：</strong> 1H级别多因子打分结果（0-6分）和信号强度（做多/做空/观望/不做）</li>
              <li><strong>15min信号列：</strong> 15分钟级别入场判断结果（趋势市：多头回踩突破/空头反抽破位；震荡市：区间多头/区间空头/假突破反手）</li>
              <li><strong>当前价格列：</strong> 当前价格和入场价格（如有）</li>
              <li><strong>数据采集率列：</strong> Binance API实时成功率（100%表示API调用正常）</li>
              <li><strong>实时监控：</strong> 每30秒更新一次，显示当前API调用状态</li>
              <li><strong>失败分析：</strong> 如有API调用失败，会记录具体失败原因</li>
            </ul>

            <h4>震荡市模式说明：</h4>
            <ul>
              <li><strong>假突破入场：</strong> 15分钟布林带宽收窄 + 假突破验证 + 多因子确认</li>
              <li><strong>多头假突破：</strong> 突破下沿后快速回撤 + 下轨边界有效</li>
              <li><strong>空头假突破：</strong> 突破上沿后快速回撤 + 上轨边界有效</li>
              <li><strong>止损设置：</strong> 结构性止损（区间边界失效）+ 多因子止损（得分≤-2）+ 时间止损（3小时）</li>
              <li><strong>止盈目标：</strong> 固定RR目标（1:2）+ 时间止盈（3小时）</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 加载JavaScript模块 -->
  <script src="js/api.js?v=20250111-16"></script>
  <script src="js/components/Modal.js?v=20250111-16"></script>
  <script src="js/data/DataManager.js?v=20250111-16"></script>
  <script src="js/main.js?v=20250111-16"></script>

  <!-- 优化表格样式 -->
  <style>
    /* 表格整体样式 */
    .table-responsive {
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .table {
      margin-bottom: 0;
      font-size: 14px;
      table-layout: fixed;
      width: 100%;
    }

    .table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      text-align: center;
      padding: 12px 8px;
      border: none;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .table td {
      padding: 10px 8px;
      text-align: center;
      vertical-align: middle;
      border: 1px solid #e9ecef;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .table tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .table tbody tr:hover {
      background-color: #e3f2fd;
      transform: scale(1.01);
      transition: all 0.2s ease;
    }

    /* 列宽度设置 */
    .table th:nth-child(1),
    .table td:nth-child(1) {
      width: 6%;
    }

    /* 详情 */
    .table th:nth-child(2),
    .table td:nth-child(2) {
      width: 10%;
    }

    /* 交易对 */
    .table th:nth-child(3),
    .table td:nth-child(3) {
      width: 8%;
    }

    /* 分类 */
    .table th:nth-child(4),
    .table td:nth-child(4) {
      width: 8%;
    }

    /* 趋势打分 */
    .table th:nth-child(5),
    .table td:nth-child(5) {
      width: 10%;
    }

    /* 4H趋势 */
    .table th:nth-child(6),
    .table td:nth-child(6) {
      width: 10%;
    }

    /* 多因子得分 */
    .table th:nth-child(7),
    .table td:nth-child(7) {
      width: 10%;
    }

    /* 1H加强趋势 */
    .table th:nth-child(8),
    .table td:nth-child(8) {
      width: 12%;
    }

    /* 15min信号 */
    .table th:nth-child(9),
    .table td:nth-child(9) {
      width: 12%;
    }

    /* 当前价格 */
    .table th:nth-child(10),
    .table td:nth-child(10) {
      width: 10%;
    }

    /* 数据采集率 */

    /* 颜色样式 */
    .score-strong {
      background: linear-gradient(135deg, #ffa500, #ff8c00) !important;
      color: #000 !important;
      font-weight: bold !important;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(255, 165, 0, 0.3);
    }

    .score-none {
      background: linear-gradient(135deg, #6c757d, #5a6268) !important;
      color: #fff !important;
      border-radius: 4px;
    }

    .trend-bull {
      background: linear-gradient(135deg, #28a745, #20c997) !important;
      color: #fff !important;
      font-weight: bold !important;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }

    .trend-bear {
      background: linear-gradient(135deg, #dc3545, #e74c3c) !important;
      color: #fff !important;
      font-weight: bold !important;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }

    .trend-none {
      background: linear-gradient(135deg, #6c757d, #5a6268) !important;
      color: #fff !important;
      border-radius: 4px;
    }

    /* 按钮样式 */
    .expand-btn {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }

    .expand-btn:hover {
      background: linear-gradient(135deg, #0056b3, #004085);
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.4);
    }

    /* 价格样式 */
    .price-cell {
      font-family: 'Courier New', monospace;
      font-weight: 600;
      color: #2c3e50;
    }

    /* 分类样式 */
    .category-mainstream {
      color: #007bff;
      font-weight: 600;
    }

    .category-highcap {
      color: #28a745;
      font-weight: 600;
    }

    .category-trending {
      color: #ffc107;
      font-weight: 600;
    }

    .category-smallcap {
      color: #6c757d;
      font-weight: 600;
    }

    .category-unknown {
      color: #dc3545;
      font-weight: 600;
    }

    /* Badge样式 */
    .badge {
      display: inline-block;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 600;
      line-height: 1;
      text-align: center;
      white-space: nowrap;
      vertical-align: baseline;
      border-radius: 4px;
    }

    .badge-success {
      background-color: #28a745;
      color: white;
    }

    .badge-warning {
      background-color: #ffc107;
      color: #212529;
    }

    .badge-danger {
      background-color: #dc3545;
      color: white;
    }

    /* 响应式设计 */
    @media (max-width: 1200px) {
      .table {
        font-size: 12px;
      }

      .table th,
      .table td {
        padding: 8px 4px;
      }
    }

    @media (max-width: 768px) {
      .table-responsive {
        overflow-x: auto;
      }

      .table {
        min-width: 800px;
      }
    }
  </style>

  <!-- 强制数据加载测试代码 -->
  <script>
    console.log('🚀 强制数据加载测试开始');

    // 强制加载数据并直接更新表格
    async function forceLoadData() {
      try {
        console.log('🔄 强制加载数据...');
        const response = await fetch('/api/signals');
        const data = await response.json();
        console.log('✅ API调用成功，数据长度:', data.length);
        console.log('📊 前3个交易对数据:', data.slice(0, 3));

        // 直接更新表格，不依赖app对象
        const tbody = document.getElementById('signalsTableBody');
        if (tbody && data.length > 0) {
          console.log('🔄 直接更新表格...');
          tbody.innerHTML = '';

          data.forEach(signal => {
            const row = document.createElement('tr');
            const trendScore = signal.score || 0;
            const trendDirection = signal.direction || null;
            const trend4h = signal.trend4h || signal.trend || '--';
            const marketType = signal.marketType || '--';
            const category = signal.category || 'mainstream';
            const currentPrice = signal.currentPrice || 0;

            // 简化的分类显示
            const categoryMap = {
              'mainstream': '主流币',
              'high-cap-trending': '高市值趋势币',
              'trending': '热点币',
              'smallcap': '小币'
            };
            const categoryDisplay = categoryMap[category] || '未知';

            // 构建多因子得分显示
            let multifactorDisplay = '--';
            let multifactorClass = 'score-none';
            if (trend4h === '多头趋势' || trend4h === '空头趋势') {
              // 趋势市：显示1H趋势加强多因子打分得分
              const trendScore1h = signal.score1h || 0;
              multifactorDisplay = trendScore1h.toString();
              multifactorClass = trendScore1h >= 3 ? 'score-strong' : 'score-none';
            } else if (trend4h === '震荡市') {
              // 震荡市：显示1H边界有效性判断多因子打分得分
              const lowerValid = signal.rangeLowerBoundaryValid === true ? 1 : 0;
              const upperValid = signal.rangeUpperBoundaryValid === true ? 1 : 0;
              const boundaryScore = lowerValid + upperValid;
              multifactorDisplay = boundaryScore.toString();
              multifactorClass = boundaryScore >= 1 ? 'score-strong' : 'score-none';
            }

            // 构建4H趋势显示（只显示趋势，不显示市场类型）
            let trendDisplay = trend4h;
            let trendClass = 'trend-none';
            if (trend4h === '震荡市') {
              trendDisplay = '震荡市';
              trendClass = 'trend-none';
            } else if (trend4h === '多头趋势') {
              trendDisplay = '多头趋势';
              trendClass = 'trend-bull';
            } else if (trend4h === '空头趋势') {
              trendDisplay = '空头趋势';
              trendClass = 'trend-bear';
            }

            // 构建趋势打分显示
            let trendScoreClass = 'score-none';
            if (trendScore >= 3) {
              trendScoreClass = 'score-strong';
            }

            row.innerHTML = `
              <td><button class="expand-btn" onclick="toggleHistory('${signal.symbol}')" title="查看详细信息">+</button></td>
              <td><strong>${signal.symbol}</strong></td>
              <td class="category-${category}">${categoryDisplay}</td>
              <td class="${trendScoreClass}">${trendScore}</td>
              <td class="${trendClass}">${trendDisplay}</td>
              <td class="${multifactorClass}">${multifactorDisplay}</td>
              <td>--</td>
              <td>--</td>
              <td class="price-cell">${currentPrice.toFixed(4)}</td>
              <td><span class="badge badge-success">100%</span></td>
            `;
            tbody.appendChild(row);
          });

          console.log('✅ 表格直接更新完成');
        } else {
          console.error('❌ 表格元素不存在或数据为空');
        }
      } catch (error) {
        console.error('❌ 强制加载数据失败:', error);
      }
    }

    // 页面加载完成后立即执行
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', forceLoadData);
    } else {
      forceLoadData();
    }
    
    // 页面完全加载后再次执行
    window.addEventListener('load', forceLoadData);
    
    // 每5秒强制刷新一次，确保数据始终显示
    setInterval(forceLoadData, 5000);
  </script>
</body>

</html>