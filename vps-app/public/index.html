<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartFlow 交易策略仪表板</title>
  <link rel="stylesheet" href="css/main.css">
</head>

<body>
  <div class="container">
    <!-- 头部 -->
    <header class="header">
      <h1>🚀 SmartFlow 交易策略仪表板</h1>
      <p>基于多周期共振的高胜率高盈亏比加密货币交易策略</p>
    </header>

    <!-- 控制面板 -->
    <div class="controls">
      <div class="control-group">
      </div>

      <div class="control-group">
        <div class="update-status">
          <span class="status-label">📈 趋势更新：</span>
          <span id="trendUpdateTime" class="status-time">--</span>
        </div>
        <div class="update-status">
          <span class="status-label">📊 信号更新：</span>
          <span id="signalUpdateTime" class="status-time">--</span>
        </div>
        <div class="update-status">
          <span class="status-label">⚡ 执行更新：</span>
          <span id="executionUpdateTime" class="status-time">--</span>
        </div>
      </div>

      <div class="control-group">
        <label for="maxLossAmount">💰 单次交易最大损失：</label>
        <select id="maxLossAmount">
          <option value="10">10 USDT</option>
          <option value="20">20 USDT</option>
          <option value="50">50 USDT</option>
          <option value="100" selected>100 USDT</option>
        </select>
      </div>
    </div>

    <!-- 统计概览 -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3 id="totalSignals">0</h3>
        <p>总信号数</p>
      </div>
      <div class="stat-card">
        <h3 id="longSignals">0</h3>
        <p>多头15min信号</p>
      </div>
      <div class="stat-card">
        <h3 id="shortSignals">0</h3>
        <p>空头15min信号</p>
      </div>
      <div class="stat-card">
        <h3 id="lastUpdate">--</h3>
        <p>最后更新</p>
      </div>
      <div class="stat-card">
        <h3 id="winRate">0%</h3>
        <p>策略胜率</p>
        <small id="winRateDetails">0/0</small>
      </div>
    </div>

    <!-- 功能按钮区域 -->
    <div class="function-buttons">
      <button class="btn secondary" onclick="runSystemTests()">🧪 系统测试</button>
      <a href="monitoring.html" class="btn secondary">📊 监控中心</a>
      <a href="simulation-data.html" class="btn secondary">📈 模拟交易</a>
      <a href="rollup-calculator.html" class="btn calculator-btn">📊 滚仓计算器</a>
      <a href="symbol-management.html" class="btn symbols-list-btn">📋 交易对管理</a>
      <button class="btn primary" onclick="refreshData()">🔄 刷新数据</button>
    </div>

    <!-- 信号表格 -->
    <div class="table-container">
      <h3>📊 交易信号</h3>
      <div class="table-wrapper">
        <table id="signalsTable">
          <thead>
            <tr>
              <th>详情</th>
              <th>交易对</th>
              <th>4H趋势</th>
              <th>多因子得分</th>
              <th>1H加强趋势</th>
              <th>15min信号</th>
              <th>当前价格</th>
              <th>数据采集率</th>
            </tr>
          </thead>
          <tbody id="signalsTableBody">
            <tr>
              <td colspan="8" style="text-align: center; color: #6c757d;">
                系统将自动刷新分析数据
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 策略规则说明 -->
    <div class="rules-section" id="rulesSection">
      <h2>📋 SmartFlow 交易策略规则说明</h2>

      <div class="strategy-overview">
        <h3>🎯 系统结构（3层共振）</h3>
        <p>4H级趋势判断（4H） → 1H级多因子打分（1H） → 15分钟级别入场判断（15m）</p>
        <p><strong>依赖关系：</strong> 1H打分依赖4H趋势结果，15m入场判断依赖4H趋势和1H打分结果</p>
        <p><strong>更新频率：</strong> 4H趋势每1小时更新，1H打分每5分钟更新，15m入场每2分钟更新</p>
      </div>

      <div class="strategy-details">
        <div class="strategy-phase">
          <h3>📈 1. 4H级趋势判断（4H）</h3>
          <div class="phase-content">
            <h4>数据来源：</h4>
            <ul>
              <li><strong>K线数据：</strong> Binance Futures API `/fapi/v1/klines?symbol={symbol}&interval=4h&limit=250`
              </li>
            </ul>

            <h4>指标计算：</h4>
            <ul>
              <li><strong>MA20：</strong> SMA(收盘价, 20) = Σ(收盘价[i-19:i]) / 20</li>
              <li><strong>MA50：</strong> SMA(收盘价, 50) = Σ(收盘价[i-49:i]) / 50</li>
              <li><strong>MA200：</strong> SMA(收盘价, 200) = Σ(收盘价[i-199:i]) / 200</li>
              <li><strong>ADX：</strong> 平均方向指数，使用Wilder平滑法计算，周期14</li>
              <li><strong>BBW（布林带带宽）：</strong> (上轨 - 下轨) / 中轨，其中中轨 = MA20，上下轨 = 中轨 ± 2×标准差</li>
            </ul>

            <h4>判断逻辑：</h4>
            <ul>
              <li><strong>多头趋势基础条件：</strong> 收盘价 > MA20 且 MA20 > MA50 且 MA50 > MA200</li>
              <li><strong>空头趋势基础条件：</strong> 收盘价 < MA20 且 MA20 < MA50 且 MA50 < MA200</li>
              <li><strong>趋势强度条件：</strong> ADX > 20 或 BBW扩张（最近20根K线后半段平均宽度 > 前半段平均宽度 × 1.15）</li>
              <li><strong>最终判断：</strong> 基础条件 + 强度条件 = 强趋势，仅基础条件 = 弱趋势</li>
            </ul>
          </div>
        </div>

        <div class="strategy-phase">
          <h3>⏰ 2. 1H级多因子打分（1H）- 趋势市专用</h3>
          <div class="phase-content">
            <h4>数据来源：</h4>
            <ul>
              <li><strong>K线数据：</strong> `/fapi/v1/klines?symbol={symbol}&interval=1h&limit=50`</li>
              <li><strong>15分钟K线：</strong> `/fapi/v1/klines?symbol={symbol}&interval=15m&limit=50`</li>
              <li><strong>4小时K线：</strong> `/fapi/v1/klines?symbol={symbol}&interval=4h&limit=20`</li>
              <li><strong>资金费率：</strong> `/fapi/v1/fundingRate?symbol={symbol}&limit=1`</li>
              <li><strong>持仓量历史：</strong> `/futures/data/openInterestHist?symbol={symbol}&period=1h&limit=6`</li>
              <li><strong>Delta数据：</strong> WebSocket实时数据，计算买卖盘不平衡</li>
            </ul>

            <h4>多因子打分系统（0-6分）：</h4>
            <ul>
              <li><strong>VWAP方向（必须满足）：</strong> 收盘价 > VWAP（多头趋势）或 收盘价 < VWAP（空头趋势）</li>
              <li><strong>突破确认（1分）：</strong> 收盘价突破最近20根4H K线高点（多头）或低点（空头）</li>
              <li><strong>成交量双确认（1分）：</strong> 15m成交量 ≥ 1.5×20期均量 且 1h成交量 ≥ 1.2×20期均量</li>
              <li><strong>OI变化（1分）：</strong> 多头：6h OI ≥ +2%，空头：6h OI ≤ -3%</li>
              <li><strong>资金费率（1分）：</strong> -0.05% ≤ 资金费率 ≤ +0.05%</li>
              <li><strong>Delta不平衡（1分）：</strong> 多头：主动买盘 ≥ 卖盘×1.2，空头：主动卖盘 ≥ 买盘×1.2</li>
            </ul>

            <h4>判断逻辑：</h4>
            <ul>
              <li><strong>VWAP方向必须满足，否则得分=0</strong></li>
              <li><strong>得分 ≥ 3分：</strong> 允许入场（仅趋势市）</li>
              <li><strong>得分 < 3分：</strong> 无信号（NONE）</li>
              <li><strong>最终action：</strong> 得分 ≥ 3分时，多头趋势→做多，空头趋势→做空</li>
            </ul>
          </div>
        </div>

        <div class="strategy-phase">
          <h3>🔄 2.5. 震荡市1H边界判断</h3>
          <div class="phase-content">
            <h4>数据来源：</h4>
            <ul>
              <li><strong>K线数据：</strong> `/fapi/v1/klines?symbol={symbol}&interval=1h&limit=50`</li>
              <li><strong>Delta数据：</strong> WebSocket实时数据</li>
              <li><strong>持仓量历史：</strong> `/futures/data/openInterestHist?symbol={symbol}&period=1h&limit=6`</li>
            </ul>

            <h4>边界有效性判断：</h4>
            <ul>
              <li><strong>布林带计算：</strong> 20期布林带，K=2</li>
              <li><strong>连续触碰：</strong> 最近6根1H K线中，下轨触碰≥2次，上轨触碰≥2次</li>
              <li><strong>成交量因子：</strong> 最新1H成交量 ≤ 1.2×20期均量</li>
              <li><strong>Delta因子：</strong> |Delta| ≤ 0.02（买卖盘平衡）</li>
              <li><strong>OI因子：</strong> |6h OI变化| ≤ 2%</li>
              <li><strong>无突破：</strong> 最近20根K线内无新高/新低突破</li>
            </ul>

            <h4>判断逻辑：</h4>
            <ul>
              <li><strong>下轨有效：</strong> 连续触碰 + 成交量 + Delta + OI + 无突破</li>
              <li><strong>上轨有效：</strong> 连续触碰 + 成交量 + Delta + OI + 无突破</li>
              <li><strong>最终action：</strong> 边界有效时允许15m区间交易</li>
            </ul>
          </div>
        </div>

        <div class="strategy-phase">
          <h3>⚡ 3. 15分钟级别入场判断（15m）</h3>
          <div class="phase-content">
            <h4>数据来源：</h4>
            <ul>
              <li><strong>K线数据：</strong> `/fapi/v1/klines?symbol={symbol}&interval=15m&limit=50`</li>
              <li><strong>1小时K线：</strong> `/fapi/v1/klines?symbol={symbol}&interval=1h&limit=50`</li>
            </ul>

            <h4>指标计算：</h4>
            <ul>
              <li><strong>EMA20：</strong> EMA(收盘价, 20) = 收盘价 × (2/21) + 前EMA × (19/21)</li>
              <li><strong>EMA50：</strong> EMA(收盘价, 50) = 收盘价 × (2/51) + 前EMA × (49/51)</li>
              <li><strong>ATR14：</strong> ATR(14) = EMA(真实波幅, 14)，真实波幅 = max(最高价-最低价, |最高价-前收盘价|, |最低价-前收盘价|)</li>
            </ul>

            <h4>趋势市入场模式：</h4>
            <ul>
              <li><strong>多头回踩突破：</strong> 价格回踩EMA20/50支撑 + 突破setup candle高点 + 成交量确认</li>
              <li><strong>空头反抽破位：</strong> 价格反抽EMA20/50阻力 + 跌破setup candle低点 + 成交量确认</li>
            </ul>

            <h4>震荡市入场模式：</h4>
            <ul>
              <li><strong>区间多头：</strong> 价格接近下轨 + 缩量不破或setup突破 + 下轨边界有效</li>
              <li><strong>区间空头：</strong> 价格接近上轨 + 缩量不破或setup突破 + 上轨边界有效</li>
              <li><strong>假突破反手：</strong> 突破后快速收回 + 量能不足 + 反手入场</li>
            </ul>

            <h4>判断逻辑：</h4>
            <ul>
              <li><strong>趋势市前提：</strong> 4H趋势明确 + 1H VWAP方向一致且1H得分 ≥ 3分</li>
              <li><strong>震荡市前提：</strong> 4H震荡市 + 1H边界有效（下轨或上轨）</li>
              <li><strong>止损设置：</strong> setup candle另一端 或 1.2×ATR(14)，取更远者</li>
              <li><strong>止盈目标：</strong> 趋势市：多头2R，空头2R；震荡市：到中轨或对侧轨</li>
            </ul>
          </div>
        </div>

        <div class="strategy-phase">
          <h3>📊 4. 核心指标说明</h3>
          <div class="phase-content">
            <h4>BBW（布林带带宽）：</h4>
            <p>BBW = (上轨 - 下轨) / 中轨</p>
            <p>其中：中轨 = MA20，上轨 = 中轨 + 2×标准差，下轨 = 中轨 - 2×标准差</p>
            <p>BBW扩张：最新BBW > 前一个BBW，表示波动率增加，趋势可能加强</p>

            <h4>VWAP（成交量加权平均价格）：</h4>
            <p>VWAP = Σ(典型价 × 成交量) / Σ(成交量)</p>
            <p>其中：典型价 = (最高价 + 最低价 + 收盘价) / 3</p>
            <p>用于判断价格与成交量加权平均的关系</p>

            <h4>多因子打分系统：</h4>
            <p>基于6个因子进行打分，每个因子1分，总分0-6分：</p>
            <ul>
              <li>VWAP方向：收盘价与VWAP的关系</li>
              <li>突破结构：是否突破最近20根K线的高低点</li>
              <li>成交量确认：当前成交量是否放大1.5倍以上</li>
              <li>OI确认：持仓量6小时变化是否达到±2%</li>
              <li>资金费率：是否在合理范围内（≤0.15%）</li>
              <li>Delta确认：收盘价与开盘价的关系</li>
            </ul>

            <h4>入场模式：</h4>
            <p><strong>模式A（回踩确认）：</strong> 高胜率模式，价格回踩支撑位后突破</p>
            <p><strong>模式B（动能突破）：</strong> 高机会模式，放量突破setup candle</p>
          </div>
        </div>

        <div class="strategy-phase">
          <h3>⚠️ 5. 风险控制与执行规则</h3>
          <div class="phase-content">
            <h4>入场条件：</h4>
            <ul>
              <li><strong>趋势市：</strong> 4H趋势明确 + 1H VWAP方向一致 + 1H得分≥3分 + 15m入场模式</li>
              <li><strong>震荡市：</strong> 4H震荡市 + 1H边界有效 + 15m区间交易或假突破反手</li>
            </ul>

            <h4>出场条件（6种）：</h4>
            <ul>
              <li><strong>1. 止损触发：</strong> 价格触及止损位（setup candle另一端或1.2×ATR14）</li>
              <li><strong>2. 止盈触发：</strong> 价格触及止盈位（趋势市2R，震荡市到中轨/对侧轨）</li>
              <li><strong>3. 趋势反转：</strong> 4H趋势改变或1H得分<3分</li>
              <li><strong>4. Delta减弱：</strong> 主动买卖盘不平衡度<1.1</li>
              <li><strong>5. 支撑阻力突破：</strong> 价格跌破EMA20/50或关键支撑/阻力位</li>
              <li><strong>6. 时间止损：</strong> 持仓时间超过12小时（48个15分钟）</li>
            </ul>

            <h4>风控规则：</h4>
            <ul>
              <li><strong>止损设置：</strong> setup candle另一端 或 1.2×ATR(14)，取更远者</li>
              <li><strong>止盈目标：</strong> 趋势市：2R；震荡市：到中轨或对侧轨</li>
              <li><strong>单笔风险：</strong> 根据全局最大损失设置</li>
              <li><strong>最大持仓：</strong> 同一交易对最多1笔活跃交易</li>
              <li><strong>时间限制：</strong> 单笔交易最长12小时</li>
            </ul>

            <h4>表格列说明：</h4>
            <ul>
              <li><strong>4H趋势列：</strong> 4H级别趋势判断结果（多头趋势/空头趋势/震荡/无趋势）</li>
              <li><strong>1H加强趋势列：</strong> 1H级别多因子打分结果（0-6分）和信号强度（做多/做空/观望/不做）</li>
              <li><strong>15min信号列：</strong> 15分钟级别入场判断结果（显示触发的多头回踩突破或空头反抽破位）</li>
              <li><strong>当前价格列：</strong> 当前价格和入场价格（如有）</li>
              <li><strong>数据采集率列：</strong> 数据收集成功率（100%表示正常）</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 加载JavaScript模块 -->
  <script src="js/api.js?v=20250108-17"></script>
  <script src="js/components/Modal.js?v=20250108-17"></script>
  <script src="js/data/DataManager.js?v=20250108-17"></script>
        <script src="js/main.js?v=20250109-8"></script>
</body>

</html>