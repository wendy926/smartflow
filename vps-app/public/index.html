<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartFlow 交易策略仪表板</title>
  <link rel="stylesheet" href="css/main.css">
</head>

<body>
  <div class="container">
    <!-- 头部 -->
    <header class="header">
      <h1>🚀 SmartFlow 交易策略仪表板</h1>
      <p>基于多周期共振的高胜率高盈亏比加密货币交易策略</p>
    </header>

    <!-- 控制面板 -->
    <div class="controls">
      <div class="control-group">
        <button class="btn primary" onclick="refreshAllSignals()">🔄 手动刷新</button>
      </div>

      <div class="control-group">
        <div class="update-status">
          <span class="status-label">📈 趋势更新：</span>
          <span id="trendUpdateTime" class="status-time">--</span>
        </div>
        <div class="update-status">
          <span class="status-label">📊 信号更新：</span>
          <span id="signalUpdateTime" class="status-time">--</span>
        </div>
        <div class="update-status">
          <span class="status-label">⚡ 执行更新：</span>
          <span id="executionUpdateTime" class="status-time">--</span>
        </div>
      </div>

      <div class="control-group">
        <label for="maxLossAmount">💰 单次交易最大损失：</label>
        <select id="maxLossAmount">
          <option value="10">10 USDT</option>
          <option value="20">20 USDT</option>
          <option value="50">50 USDT</option>
          <option value="100" selected>100 USDT</option>
        </select>
      </div>
    </div>

    <!-- 统计概览 -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3 id="totalSignals">0</h3>
        <p>总信号数</p>
      </div>
      <div class="stat-card">
        <h3 id="longSignals">0</h3>
        <p>多头信号</p>
      </div>
      <div class="stat-card">
        <h3 id="shortSignals">0</h3>
        <p>空头信号</p>
      </div>
      <div class="stat-card">
        <h3 id="lastUpdate">--</h3>
        <p>最后更新</p>
      </div>
      <div class="stat-card">
        <h3 id="winRate">0%</h3>
        <p>策略胜率</p>
        <small id="winRateDetails">0/0</small>
      </div>
    </div>

    <!-- 信号表格 -->
    <div class="table-container">
      <h3>📊 交易信号</h3>
      <div class="table-wrapper">
        <table id="signalsTable">
          <thead>
            <tr>
              <th>详情</th>
              <th>交易对</th>
              <th>趋势</th>
              <th>多因子得分</th>
              <th>信号</th>
              <th>入场执行</th>
              <th>当前价格</th>
              <th>数据采集率</th>
            </tr>
          </thead>
          <tbody id="signalsTableBody">
            <tr>
              <td colspan="8" style="text-align: center; color: #6c757d;">
                点击"刷新所有信号"开始分析
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 模拟交易历史 -->
    <div class="table-container">
      <h3>📊 模拟交易历史</h3>
      <div class="table-wrapper">
        <table id="simulationTable">
          <thead>
            <tr>
              <th>交易对</th>
              <th>入场价格</th>
              <th>止损价格</th>
              <th>止盈价格</th>
              <th>杠杆倍数</th>
              <th>最小保证金</th>
              <th>止损距离</th>
              <th>ATR值</th>
              <th>入场时间</th>
              <th>出场时间</th>
              <th>出场价格</th>
              <th>出场原因</th>
              <th>触发原因</th>
              <th>盈亏</th>
              <th>结果</th>
            </tr>
          </thead>
          <tbody id="simulationTableBody">
            <tr>
              <td colspan="12" style="text-align: center; color: #6c757d;">
                加载中...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 底部控制按钮 -->
    <div class="bottom-controls">
      <button class="btn secondary" onclick="testAPIConnection()">🧪 测试API连接</button>
      <button class="btn secondary" onclick="loadUnifiedMonitoring()">📊 统一监控中心</button>
      <button class="btn secondary" onclick="viewTelegramConfig()">📱 Telegram通知</button>
      <button class="btn secondary" onclick="testDataQualityAlert()">📤 测试Telegram机器人</button>
      <button class="btn calculator-btn" onclick="openRollupCalculator()">📊 斐波拉契滚仓计算器</button>
      <button class="btn symbols-list-btn" onclick="showSymbolsList()">📋 交易对管理</button>
      <button class="btn secondary" onclick="toggleSimulationHistory()">📈 模拟交易历史</button>
    </div>

    <!-- 策略规则说明 -->
    <div class="rules-section" id="rulesSection">
      <h2>📋 SmartFlow 交易策略规则说明</h2>

      <div class="strategy-overview">
        <h3>🎯 系统结构（3层共振）</h3>
        <p>天级趋势判断（日线） → 小时级趋势加强判断（1H） → 15分钟级别入场判断（15m）</p>
        <p><strong>依赖关系：</strong> 趋势加强判断依赖趋势列结果，入场执行判断依赖趋势列和信号列结果</p>
      </div>

      <div class="strategy-details">
        <div class="strategy-phase">
          <h3>📈 1. 天级趋势判断（日线）</h3>
          <div class="phase-content">
            <h4>数据来源：</h4>
            <ul>
              <li><strong>K线数据：</strong> Binance Futures API `/fapi/v1/klines?symbol={symbol}&interval=1d&limit=250`
              </li>
            </ul>

            <h4>指标计算：</h4>
            <ul>
              <li><strong>MA20：</strong> SMA(收盘价, 20) = Σ(收盘价[i-19:i]) / 20</li>
              <li><strong>MA50：</strong> SMA(收盘价, 50) = Σ(收盘价[i-49:i]) / 50</li>
              <li><strong>MA200：</strong> SMA(收盘价, 200) = Σ(收盘价[i-199:i]) / 200</li>
              <li><strong>BBW（布林带带宽）：</strong> (上轨 - 下轨) / 中轨，其中中轨 = MA20，上下轨 = 中轨 ± 2×标准差</li>
            </ul>

            <h4>判断逻辑：</h4>
            <ul>
              <li><strong>多头趋势基础条件：</strong> 收盘价 > MA200 且 MA20 > MA50</li>
              <li><strong>空头趋势基础条件：</strong> 收盘价 < MA200 且 MA20 < MA50</li>
              <li><strong>趋势强度条件：</strong> BBW扩张（最新BBW > 前一个BBW）</li>
              <li><strong>最终判断：</strong> 基础条件 + 强度条件 = 强趋势，仅基础条件 = 弱趋势</li>
            </ul>
          </div>
        </div>

        <div class="strategy-phase">
          <h3>⏰ 2. 小时级趋势加强判断（1H）</h3>
          <div class="phase-content">
            <h4>数据来源：</h4>
            <ul>
              <li><strong>K线数据：</strong> `/fapi/v1/klines?symbol={symbol}&interval=1h&limit=50`</li>
              <li><strong>24小时行情：</strong> `/fapi/v1/ticker/24hr?symbol={symbol}`</li>
              <li><strong>资金费率：</strong> `/fapi/v1/fundingRate?symbol={symbol}&limit=1`</li>
              <li><strong>持仓量历史：</strong> `/futures/data/openInterestHist?symbol={symbol}&period=1h&limit=6`</li>
            </ul>

            <h4>多因子打分系统（0-6分）：</h4>
            <ul>
              <li><strong>VWAP方向（1分）：</strong> 收盘价 > VWAP（多头趋势）或 收盘价 < VWAP（空头趋势）</li>
              <li><strong>突破结构（1分）：</strong> 收盘价突破最近20根K线高点（多头）或低点（空头）</li>
              <li><strong>成交量确认（1分）：</strong> 当前成交量 ≥ 1.5 × 20期平均成交量</li>
              <li><strong>OI确认（1分）：</strong> OI 6小时变动 ≥ +2%（多头）或 ≤ -2%（空头）</li>
              <li><strong>资金费率（1分）：</strong> |资金费率| ≤ 0.15%/8h</li>
              <li><strong>Delta确认（1分）：</strong> 收盘价 > 开盘价（多头）或 收盘价 < 开盘价（空头）</li>
            </ul>

            <h4>判断逻辑：</h4>
            <ul>
              <li><strong>得分 ≥ 4分：</strong> 强信号，可进入15分钟观察</li>
              <li><strong>得分 2-3分：</strong> 中等信号，谨慎观察</li>
              <li><strong>得分 < 2分：</strong> 弱信号，观望</li>
              <li><strong>最终action：</strong> 得分 ≥ 4分时，多头趋势→做多，空头趋势→做空</li>
            </ul>
          </div>
        </div>

        <div class="strategy-phase">
          <h3>⚡ 3. 15分钟级别入场判断（15m）</h3>
          <div class="phase-content">
            <h4>数据来源：</h4>
            <ul>
              <li><strong>K线数据：</strong> `/fapi/v1/klines?symbol={symbol}&interval=15m&limit=50`</li>
            </ul>

            <h4>指标计算：</h4>
            <ul>
              <li><strong>EMA20：</strong> EMA(收盘价, 20) = 收盘价 × (2/21) + 前EMA × (19/21)</li>
              <li><strong>EMA50：</strong> EMA(收盘价, 50) = 收盘价 × (2/51) + 前EMA × (49/51)</li>
              <li><strong>ATR14：</strong> ATR(14) = SMA(真实波幅, 14)，真实波幅 = max(最高价-最低价, |最高价-前收盘价|, |最低价-前收盘价|)</li>
            </ul>

            <h4>入场模式：</h4>
            <ul>
              <li><strong>模式A（回踩确认）：</strong> 价格回踩到EMA20/50支撑位，突破setup candle高点/低点</li>
              <li><strong>模式B（动能突破）：</strong> 成交量放大1.5倍以上，突破setup candle高点/低点</li>
            </ul>

            <h4>判断逻辑：</h4>
            <ul>
              <li><strong>前提条件：</strong> 天级趋势明确 + 小时级得分 ≥ 2分</li>
              <li><strong>模式A触发：</strong> 多头趋势 + 收盘价 ≤ EMA支撑 + 突破setup高点</li>
              <li><strong>模式B触发：</strong> 多头趋势 + 突破setup高点 + 成交量 ≥ 1.5×平均量</li>
              <li><strong>止损设置：</strong> setup candle另一端 或 1.2×ATR(14)，取更远者</li>
              <li><strong>止盈目标：</strong> 2R（风险回报比1:2）</li>
            </ul>
          </div>
        </div>

        <div class="strategy-phase">
          <h3>📊 4. 核心指标说明</h3>
          <div class="phase-content">
            <h4>BBW（布林带带宽）：</h4>
            <p>BBW = (上轨 - 下轨) / 中轨</p>
            <p>其中：中轨 = MA20，上轨 = 中轨 + 2×标准差，下轨 = 中轨 - 2×标准差</p>
            <p>BBW扩张：最新BBW > 前一个BBW，表示波动率增加，趋势可能加强</p>

            <h4>VWAP（成交量加权平均价格）：</h4>
            <p>VWAP = Σ(典型价 × 成交量) / Σ(成交量)</p>
            <p>其中：典型价 = (最高价 + 最低价 + 收盘价) / 3</p>
            <p>用于判断价格与成交量加权平均的关系</p>

            <h4>多因子打分系统：</h4>
            <p>基于6个因子进行打分，每个因子1分，总分0-6分：</p>
            <ul>
              <li>VWAP方向：收盘价与VWAP的关系</li>
              <li>突破结构：是否突破最近20根K线的高低点</li>
              <li>成交量确认：当前成交量是否放大1.5倍以上</li>
              <li>OI确认：持仓量6小时变化是否达到±2%</li>
              <li>资金费率：是否在合理范围内（≤0.15%）</li>
              <li>Delta确认：收盘价与开盘价的关系</li>
            </ul>

            <h4>入场模式：</h4>
            <p><strong>模式A（回踩确认）：</strong> 高胜率模式，价格回踩支撑位后突破</p>
            <p><strong>模式B（动能突破）：</strong> 高机会模式，放量突破setup candle</p>
          </div>
        </div>

        <div class="strategy-phase">
          <h3>⚠️ 5. 风险控制与执行规则</h3>
          <div class="phase-content">
            <h4>入场条件：</h4>
            <ul>
              <li><strong>天级趋势：</strong> 必须明确（多头趋势或空头趋势）</li>
              <li><strong>小时级得分：</strong> 必须 ≥ 2分才能考虑入场</li>
              <li><strong>15分钟模式：</strong> 必须触发模式A或模式B</li>
            </ul>

            <h4>风控规则：</h4>
            <ul>
              <li><strong>止损设置：</strong> setup candle另一端 或 1.2×ATR(14)，取更远者</li>
              <li><strong>止盈目标：</strong> 2R（风险回报比1:2）</li>
              <li><strong>单笔风险：</strong> 1% 账户权益</li>
              <li><strong>最大持仓：</strong> 最多3笔同时持仓</li>
              <li><strong>日损限制：</strong> 当日净亏损 ≤ -3R 时停止交易</li>
            </ul>

            <h4>表格列说明：</h4>
            <ul>
              <li><strong>趋势列：</strong> 天级趋势判断结果（多头趋势/空头趋势/震荡/无趋势）</li>
              <li><strong>多因子得分列：</strong> 小时级趋势加强判断得分（0-6分）</li>
              <li><strong>信号列：</strong> 小时级趋势加强判断action结果（做多/做空/观望/不做）</li>
              <li><strong>入场执行列：</strong> 15分钟级别入场判断结果（显示触发的模式A或模式B）</li>
              <li><strong>当前价格列：</strong> 当前价格和入场价格（如有）</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 加载JavaScript模块 -->
  <script src="js/api.js?v=20250108"></script>
  <script src="js/components/Modal.js?v=20250108"></script>
  <script src="js/data/DataManager.js?v=20250108"></script>
  <script src="js/main.js?v=20250108"></script>
</body>

</html>