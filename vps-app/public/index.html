<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartFlow 交易策略仪表板</title>

    <!-- PWA 支持 -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SmartFlow">

    <!-- 防止iOS Safari缩放 -->
    <meta name="format-detection" content="telephone=no">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* 顶部控制区域 */
        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* 底部控制区域 */
        .bottom-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
                /* iOS 推荐的最小触摸目标 */
                min-width: 44px;
            }

            .expand-btn {
                min-width: 44px;
                min-height: 44px;
            }

            .refresh-select,
            .symbol-input {
                min-height: 44px;
                font-size: 16px;
                /* 防止iOS缩放 */
            }

            .mark-btn {
                min-height: 36px;
                min-width: 60px;
            }
        }

        .btn.primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border-color: #ff6b6b;
        }

        .btn.secondary {
            background: linear-gradient(45deg, #4834d4, #686de0);
            border-color: #4834d4;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card p {
            color: #666;
            font-weight: 500;
        }

        .win-rate-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .win-rate-card h3 {
            color: white;
            -webkit-text-fill-color: white;
        }

        .win-rate-card p {
            color: rgba(255, 255, 255, 0.9);
        }

        .win-rate-card small {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
            display: block;
            margin-top: 2px;
        }

        .table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            /* iOS 平滑滚动 */
        }

        .table {
            width: 100%;
            min-width: 800px;
            /* 确保表格在小屏幕上可滚动 */
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .signal {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
        }

        .signal.long {
            background: linear-gradient(45deg, #00b894, #00cec9);
            color: white;
        }

        .signal.short {
            background: linear-gradient(45deg, #e17055, #d63031);
            color: white;
        }

        .signal.no-signal {
            background: #ddd;
            color: #666;
        }

        .trend {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .trend.uptrend {
            background: #d4edda;
            color: #155724;
        }

        .trend.downtrend {
            background: #f8d7da;
            color: #721c24;
        }

        .trend.range {
            background: #fff3cd;
            color: #856404;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        /* 规则说明样式 */
        .rules-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .rules-section h2 {
            color: #333;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.8rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .rule-category {
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .rule-category h3 {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin: 0;
            padding: 15px 20px;
            font-size: 1.2rem;
        }

        .rule-content {
            padding: 20px;
            background: #f8f9fa;
        }

        .rule-content h4 {
            color: #495057;
            margin: 15px 0 10px 0;
            font-size: 1.1rem;
            border-left: 4px solid #667eea;
            padding-left: 10px;
        }

        .rule-content ul {
            margin: 0 0 15px 20px;
            padding: 0;
        }

        .rule-content li {
            margin-bottom: 8px;
            line-height: 1.6;
            color: #6c757d;
        }

        .rule-content li strong {
            color: #495057;
        }

        /* 历史记录样式 */
        .expand-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .expand-btn:hover {
            background: #5a6fd8;
            transform: scale(1.1);
        }

        .history-row {
            background: #f8f9fa;
        }

        .history-container {
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 10px 0;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .history-header h4 {
            margin: 0;
            color: #333;
        }

        .load-history-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .load-history-btn:hover {
            background: #218838;
        }

        .history-record {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 10px;
            padding: 15px;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .record-time {
            font-weight: bold;
            color: #495057;
        }

        .record-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .record-status.correct {
            background: #d4edda;
            color: #155724;
        }

        .record-status.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .record-status.unmarked {
            background: #fff3cd;
            color: #856404;
        }

        .record-details {
            font-size: 14px;
        }

        .detail-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 8px;
        }

        .label {
            font-weight: bold;
            color: #6c757d;
            min-width: 80px;
        }

        .value {
            color: #495057;
        }

        .record-notes {
            background: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            margin: 10px 0;
            font-style: italic;
            color: #6c757d;
        }

        .record-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .mark-btn {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .mark-btn.correct {
            background: #d4edda;
            color: #155724;
        }

        .mark-btn.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .mark-btn.unmarked {
            background: #fff3cd;
            color: #856404;
        }

        .mark-btn:hover {
            opacity: 0.8;
        }

        .no-data {
            text-align: center;
            color: #6c757d;
            padding: 20px;
        }

        /* 消息提示样式 */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
        }

        .message.success {
            background: #28a745;
        }

        .message.error {
            background: #dc3545;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* 移动端消息提示优化 */
        @media screen and (max-width: 430px) {
            .message {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                text-align: center;
                font-size: 14px;
            }
        }

        /* 模态框样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 25px;
        }

        /* Telegram配置样式 */
        .telegram-config h3 {
            color: #0088cc;
            margin-bottom: 20px;
            text-align: center;
        }

        .config-status {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .config-status p {
            margin: 10px 0;
            font-size: 16px;
        }

        .status-success {
            color: #28a745;
            font-weight: bold;
        }

        .status-error {
            color: #dc3545;
            font-weight: bold;
        }

        .config-instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .config-instructions h4 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .config-instructions ol {
            margin-left: 20px;
        }

        .config-instructions li {
            margin: 10px 0;
            line-height: 1.6;
        }

        .config-instructions code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d63384;
        }

        .config-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .config-actions .btn {
            min-width: 120px;
        }

        .config-actions .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 交易对列表样式 */
        .symbols-list h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .symbols-content {
            margin-bottom: 20px;
        }

        .default-symbols,
        .custom-symbols {
            margin-bottom: 20px;
        }

        .default-symbols h4,
        .custom-symbols h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .symbols-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .symbol-tag {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            position: relative;
        }

        .default-tag {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .custom-tag {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .remove-symbol {
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .remove-symbol:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        .symbol-status {
            font-size: 10px;
            color: #666;
            margin-left: 5px;
            font-weight: normal;
        }

        .no-symbols {
            color: #6c757d;
            font-style: italic;
            padding: 10px;
        }

        .symbols-actions {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        /* 模拟交易历史样式 */
        .simulation-history {
            margin-top: 20px;
        }

        .simulation-history h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .profit {
            color: #27ae60;
            font-weight: bold;
        }

        .loss {
            color: #e74c3c;
            font-weight: bold;
        }

        .no-data {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }

        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .debug-info h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .debug-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #856404;
        }

        /* 刷新控制样式 */
        .refresh-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            min-width: 100px;
        }

        .refresh-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .refresh-status {
            font-size: 12px;
            color: #6c757d;
            margin-left: 10px;
        }

        /* 交易对输入组样式 */
        .symbol-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loss-amount-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 20px;
        }

        .loss-amount-group label {
            font-weight: 600;
            color: #333;
            white-space: nowrap;
        }

        .loss-select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .loss-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .loss-select:hover {
            border-color: #667eea;
        }

        .calculator-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 20px;
        }

        .calculator-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .calculator-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .symbols-list-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 20px;
        }

        .symbols-list-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .symbols-list-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .symbol-input {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: white;
            font-size: 14px;
            min-width: 200px;
        }

        .symbol-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        /* iPhone 16 Pro Max 和其他大屏手机 */
        @media screen and (max-width: 430px) and (max-height: 932px) {
            .container {
                padding: 8px;
            }

            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 0.9rem;
            }

            .top-controls {
                flex-direction: column;
                gap: 12px;
                padding: 15px;
                margin-bottom: 20px;
            }

            .refresh-controls {
                flex-direction: column;
                gap: 8px;
                align-items: center;
            }

            .symbol-input-group {
                flex-direction: column;
                gap: 8px;
                align-items: center;
            }

            .loss-amount-group {
                flex-direction: column;
                gap: 8px;
                align-items: center;
                margin-left: 0;
                margin-top: 10px;
            }

            .calculator-group {
                flex-direction: column;
                gap: 8px;
                align-items: center;
                margin-left: 0;
                margin-top: 10px;
            }

            .calculator-btn {
                width: 100%;
                max-width: 280px;
            }

            .symbols-list-group {
                flex-direction: column;
                gap: 8px;
                align-items: center;
                margin-left: 0;
                margin-top: 10px;
            }

            .symbols-list-btn {
                width: 100%;
                max-width: 280px;
            }

            .symbol-input {
                min-width: 100%;
                max-width: 280px;
            }

            .bottom-controls {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
                margin: 20px 0;
            }

            .btn {
                width: 100%;
                max-width: 280px;
                padding: 12px 20px;
                font-size: 14px;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-card h3 {
                font-size: 1.5rem;
            }

            .table-container {
                padding: 10px;
                margin-bottom: 15px;
            }

            .table {
                font-size: 0.8rem;
            }

            .table th,
            .table td {
                padding: 8px 4px;
                white-space: nowrap;
            }

            /* 移动端隐藏次要列 */
            .table th:nth-child(7),
            .table th:nth-child(8),
            .table th:nth-child(9),
            .table th:nth-child(10),
            .table th:nth-child(11),
            .table td:nth-child(7),
            .table td:nth-child(8),
            .table td:nth-child(9),
            .table td:nth-child(10),
            .table td:nth-child(11) {
                display: none;
            }

            .expand-btn {
                width: 25px;
                height: 25px;
                font-size: 12px;
            }

            .history-container {
                padding: 15px;
            }

            .history-record {
                padding: 12px;
            }

            .detail-row {
                flex-direction: column;
                gap: 5px;
                margin-bottom: 10px;
            }

            .label {
                min-width: auto;
                font-size: 12px;
            }

            .rules-section {
                padding: 20px;
                margin-top: 20px;
            }

            .rules-section h2 {
                font-size: 1.5rem;
                margin-bottom: 20px;
            }

            .rule-category h3 {
                font-size: 1rem;
                padding: 12px 15px;
            }

            .rule-content {
                padding: 15px;
            }

            .rule-content h4 {
                font-size: 1rem;
                margin: 12px 0 8px 0;
            }

            .rule-content li {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }
        }

        /* iPhone 横屏模式 */
        @media screen and (max-height: 430px) and (orientation: landscape) {
            .container {
                padding: 5px;
            }

            .header {
                margin-bottom: 15px;
            }

            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 5px;
            }

            .header p {
                font-size: 0.8rem;
            }

            .top-controls {
                flex-direction: row;
                gap: 10px;
                padding: 10px;
                margin-bottom: 15px;
            }

            .refresh-controls {
                flex-direction: row;
                gap: 5px;
            }

            .symbol-input-group {
                flex-direction: row;
                gap: 5px;
            }

            .symbol-input {
                min-width: 120px;
                max-width: 150px;
            }

            .bottom-controls {
                flex-direction: row;
                gap: 10px;
                padding: 10px;
                margin: 15px 0;
            }

            .stats {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                margin-bottom: 15px;
            }

            .stat-card {
                padding: 10px;
            }

            .stat-card h3 {
                font-size: 1.2rem;
            }

            .table-container {
                padding: 8px;
            }

            .table {
                font-size: 0.75rem;
            }

            .table th,
            .table td {
                padding: 6px 3px;
            }

            .rules-section {
                display: none;
                /* 横屏时隐藏规则说明以节省空间 */
            }
        }

        /* 平板设备 */
        @media screen and (min-width: 768px) and (max-width: 1024px) {
            .container {
                padding: 15px;
            }

            .top-controls {
                gap: 20px;
            }

            .symbol-input {
                min-width: 250px;
            }

            .table th,
            .table td {
                padding: 12px 8px;
                font-size: 0.9rem;
            }
        }

        /* 桌面端优化 */
        @media screen and (min-width: 1025px) {
            .container {
                max-width: 1600px;
            }

            .top-controls {
                gap: 30px;
            }

            .symbol-input {
                min-width: 300px;
            }

            .table th,
            .table td {
                padding: 15px 10px;
                font-size: 1rem;
            }

            .btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .top-controls {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .refresh-controls {
                justify-content: center;
            }

            .symbol-input-group {
                justify-content: center;
            }

            .symbol-input {
                min-width: 150px;
            }

            .bottom-controls {
                flex-direction: column;
                align-items: center;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 300px;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .table-container {
                padding: 15px;
            }

            .table th,
            .table td {
                padding: 10px 8px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🚀 SmartFlow 交易策略仪表板</h1>
            <p>基于多周期共振的高胜率高盈亏比加密货币交易策略</p>
        </div>

        <!-- 顶部按钮区域 -->
        <div class="top-controls">
            <div class="refresh-controls">
                <button class="btn" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                    ⏰ 自动刷新
                </button>
                <select id="refreshInterval" onchange="updateRefreshInterval()" class="refresh-select">
                    <option value="300000">5分钟</option>
                    <option value="900000">15分钟</option>
                    <option value="1800000">30分钟</option>
                    <option value="3600000">1小时</option>
                    <option value="14400000">4小时</option>
                    <option value="86400000">1天</option>
                </select>
                <span id="refreshStatus" class="refresh-status"></span>
            </div>
            <button class="btn primary" onclick="refreshAllSignals()">
                🔄 手动刷新
            </button>
            <div class="symbol-input-group">
                <input type="text" id="customSymbol" placeholder="输入交易对 (如: ADAUSDT)" class="symbol-input">
                <button class="btn secondary" onclick="addCustomSymbol()">
                    ➕ 添加交易对
                </button>
            </div>
            <div class="loss-amount-group">
                <label for="maxLossAmount">💰 单次交易最大损失：</label>
                <select id="maxLossAmount" class="loss-select" onchange="updateMaxLossAmount()">
                    <option value="10">10 USDT</option>
                    <option value="20" selected>20 USDT</option>
                    <option value="50">50 USDT</option>
                    <option value="100">100 USDT</option>
                </select>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3 id="totalSignals">0</h3>
                <p>总信号数</p>
            </div>
            <div class="stat-card">
                <h3 id="longSignals">0</h3>
                <p>多头信号</p>
            </div>
            <div class="stat-card">
                <h3 id="shortSignals">0</h3>
                <p>空头信号</p>
            </div>
            <div class="stat-card">
                <h3 id="lastUpdate">--</h3>
                <p>最后更新</p>
            </div>
            <div class="stat-card win-rate-card">
                <h3 id="winRate">0%</h3>
                <p>策略胜率</p>
                <small id="winRateDetails">0/0</small>
            </div>
        </div>

        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>操作</th>
                        <th>交易对</th>
                        <th>趋势</th>
                        <th>信号</th>
                        <th>入场执行</th>
                        <th>当前价格</th>
                        <th>VWAP</th>
                        <th>成交量倍数</th>
                        <th>OI变化%</th>
                        <th>资金费率</th>
                        <th>CVD</th>
                    </tr>
                </thead>
                <tbody id="signalsTable">
                    <tr>
                        <td colspan="11" class="loading">点击"刷新所有信号"开始分析</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 模拟交易历史表格 -->
        <div class="table-container simulation-history" id="simulationHistoryContainer" style="display: none;">
            <h3>📊 模拟交易历史</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>交易对</th>
                        <th>入场价格</th>
                        <th>止损价格</th>
                        <th>止盈价格</th>
                        <th>杠杆倍数</th>
                        <th>最小保证金</th>
                        <th>入场时间</th>
                        <th>出场时间</th>
                        <th>出场价格</th>
                        <th>出场原因</th>
                        <th>盈亏</th>
                        <th>结果</th>
                    </tr>
                </thead>
                <tbody id="simulationHistoryTable">
                    <tr>
                        <td colspan="12" class="loading">加载中...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 底部按钮区域 -->
        <div class="bottom-controls">
            <button class="btn secondary" onclick="testAPI()">
                🧪 测试API连接
            </button>
            <button class="btn secondary" onclick="loadDataMonitor()">
                📊 查看数据监控
            </button>
            <button class="btn secondary" onclick="viewTelegramConfig()">
                📱 Telegram通知
            </button>
            <button class="btn calculator-btn" onclick="openRollupCalculator()">
                📊 斐波拉契滚仓计算器
            </button>
            <button class="btn symbols-list-btn" onclick="showSymbolsList()">
                📋 交易对管理 (${allSymbols.length})
            </button>
            <button class="btn secondary" onclick="toggleSimulationHistory()">
                📈 模拟交易历史
            </button>
        </div>

        <!-- 策略规则说明 -->
        <div class="rules-section">
            <h2>📋 交易策略规则说明</h2>

            <div class="rule-category">
                <h3>🎯 趋势判断 (日线级别)</h3>
                <div class="rule-content">
                    <h4>多头趋势条件：</h4>
                    <ul>
                        <li>MA20 > MA50 > MA200 (移动平均线多头排列)</li>
                        <li>当前价格 > MA20 (价格在短期均线之上)</li>
                        <li>满足以上条件时显示 "多头"</li>
                    </ul>

                    <h4>空头趋势条件：</h4>
                    <ul>
                        <li>MA20 < MA50 < MA200 (移动平均线空头排列)</li>
                        <li>当前价格 < MA20 (价格在短期均线之下)</li>
                        <li>满足以上条件时显示 "空头"</li>
                    </ul>

                    <h4>震荡趋势：</h4>
                    <ul>
                        <li>不满足多头或空头条件时显示 "震荡"</li>
                    </ul>
                </div>
            </div>

            <div class="rule-category">
                <h3>📊 信号判断 (小时级别确认)</h3>
                <div class="rule-content">
                    <h4>多头信号条件：</h4>
                    <ul>
                        <li>日线趋势为 "多头" 或 "震荡"</li>
                        <li>成交量倍数 > 1.5 (当前成交量/平均成交量)</li>
                        <li>资金费率绝对值 ≤ 0.001 (避免高费率)</li>
                        <li>VWAP确认：价格 > VWAP</li>
                        <li>20周期高低点突破：当前价格 > 过去20小时最高价</li>
                        <li>持仓量6小时变化 > 0 (资金流入)</li>
                        <li>CVD数据可用且方向为多头</li>
                    </ul>

                    <h4>空头信号条件：</h4>
                    <ul>
                        <li>日线趋势为 "空头" 或 "震荡"</li>
                        <li>成交量倍数 > 1.5</li>
                        <li>资金费率绝对值 ≤ 0.001</li>
                        <li>VWAP确认：价格 < VWAP</li>
                        <li>20周期高低点突破：当前价格 < 过去20小时最低价</li>
                        <li>持仓量6小时变化 < 0 (资金流出)</li>
                        <li>CVD数据可用且方向为空头</li>
                    </ul>

                    <h4>无信号：</h4>
                    <ul>
                        <li>不满足多头或空头信号条件时显示 "无信号"</li>
                    </ul>
                </div>
            </div>

            <div class="rule-category">
                <h3>⚡ 入场执行 (15分钟级别)</h3>
                <div class="rule-content">
                    <h4>多头入场条件：</h4>
                    <ul>
                        <li>小时信号为 "多头"</li>
                        <li>价格回调至EMA20或EMA50附近</li>
                        <li>识别setupHigh：前一根15分钟K线的最高价</li>
                        <li>当前价格突破setupHigh</li>
                        <li>满足以上条件时显示 "多头入场"</li>
                    </ul>

                    <h4>空头入场条件：</h4>
                    <ul>
                        <li>小时信号为 "空头"</li>
                        <li>价格回调至EMA20或EMA50附近</li>
                        <li>识别setupLow：前一根15分钟K线的最低价</li>
                        <li>当前价格跌破setupLow</li>
                        <li>满足以上条件时显示 "空头入场"</li>
                    </ul>

                    <h4>等待入场：</h4>
                    <ul>
                        <li>不满足入场条件时显示 "等待入场"</li>
                    </ul>
                </div>
            </div>

            <div class="rule-category">
                <h3>💰 风险控制指标</h3>
                <div class="rule-content">
                    <h4>现价止损距离：</h4>
                    <ul>
                        <li>计算公式：(当前价格 - 止损价格) / 当前价格</li>
                        <li>用于衡量止损位置与当前价格的距离</li>
                    </ul>

                    <h4>最大杠杆倍数：</h4>
                    <ul>
                        <li>计算公式：1 / (现价止损距离 + 0.5%) 向下取整</li>
                        <li>基于止损距离计算的最大安全杠杆</li>
                    </ul>

                    <h4>最低保证金：</h4>
                    <ul>
                        <li>计算公式：单次交易最大损失金额 / (最大杠杆倍数 × 止损距离) 向上取整</li>
                        <li>基于用户设定的最大损失金额、杠杆和止损距离计算</li>
                        <li>用户可在顶部选择：10U/20U/50U/100U</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        let maxLossAmount = 20; // 默认最大损失金额
        let currentRefreshInterval = 300000; // 默认5分钟
        let countdownInterval = null;
        let timeUntilNextRefresh = 0;

        // 全局变量存储所有交易对
        let allSymbols = ['BTCUSDT', 'ETHUSDT', 'LINKUSDT', 'LDOUSDT', 'SOLUSDT'];
        let customSymbols = [];

        // 刷新所有信号
        async function refreshAllSignals() {
            const tableBody = document.getElementById('signalsTable');
            tableBody.innerHTML = '<tr><td colspan="11" class="loading">分析中...</td></tr>';

            try {
                // 使用动态交易对列表，添加延迟避免速率限制
                const promises = allSymbols.map(async (symbol, index) => {
                    try {
                        // 添加延迟避免同时请求过多
                        if (index > 0) {
                            await new Promise(resolve => setTimeout(resolve, index * 200));
                        }

                        const response = await fetch(`/api/analyze/${symbol}`);

                        // 检查响应状态
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`${symbol} API错误:`, response.status, errorText);

                            // 特殊处理速率限制错误
                            if (response.status === 429) {
                                return {
                                    symbol,
                                    trend: 'RATE_LIMIT',
                                    signal: 'RATE_LIMIT',
                                    execution: 'RATE_LIMIT',
                                    currentPrice: 0,
                                    dataError: `请求过于频繁，请稍后重试`
                                };
                            }

                            return {
                                symbol,
                                trend: 'ERROR',
                                signal: 'ERROR',
                                execution: 'ERROR',
                                currentPrice: 0,
                                dataError: `API错误 ${response.status}: ${errorText}`
                            };
                        }

                        // 尝试解析JSON
                        const data = await response.json();
                        return data;
                    } catch (error) {
                        console.error(`${symbol} 请求失败:`, error);

                        // 特殊处理JSON解析错误
                        if (error.message.includes('Unexpected token')) {
                            return {
                                symbol,
                                trend: 'PARSE_ERROR',
                                signal: 'PARSE_ERROR',
                                execution: 'PARSE_ERROR',
                                currentPrice: 0,
                                dataError: `数据解析错误，可能是服务器响应格式异常`
                            };
                        }

                        return {
                            symbol,
                            trend: 'ERROR',
                            signal: 'ERROR',
                            execution: 'ERROR',
                            currentPrice: 0,
                            dataError: `分析失败: ${error.message}`
                        };
                    }
                });

                const signals = await Promise.all(promises);
                displaySignals(signals);
                updateStats(signals);

                // 更新胜率统计
                await loadWinRateStats();

                showMessage('信号刷新成功！', 'success');
            } catch (error) {
                console.error('刷新信号失败:', error);
                tableBody.innerHTML = '<tr><td colspan="11" class="error">刷新失败: ' + error.message + '</td></tr>';
                showMessage('刷新失败: ' + error.message, 'error');
            }
        }

        // 更新最大损失金额
        function updateMaxLossAmount() {
            const select = document.getElementById('maxLossAmount');
            maxLossAmount = parseInt(select.value);
            console.log('最大损失金额已更新为:', maxLossAmount, 'USDT');

            // 如果当前有数据显示，重新计算保证金
            if (document.querySelector('.table tbody tr:not(.error)')) {
                refreshAllSignals();
            }
        }

        // 计算最低保证金
        function calculateMinMargin(signal) {
            if (!signal.stopLoss || !signal.maxLeverage || !signal.stopDistance) {
                return '--';
            }

            // 新公式：单次交易最大损失金额 / (最大杠杆倍数 × 止损距离) 向上取整
            const minMargin = Math.ceil(maxLossAmount / (signal.maxLeverage * signal.stopDistance));
            return minMargin.toFixed(0);
        }

        // 添加自定义交易对
        async function addCustomSymbol() {
            const symbol = document.getElementById('customSymbol').value.trim().toUpperCase();

            if (!symbol) {
                showMessage('请输入交易对', 'error');
                return;
            }

            if (!symbol.endsWith('USDT')) {
                showMessage('交易对必须以 USDT 结尾', 'error');
                return;
            }

            // 检查是否已存在
            if (allSymbols.includes(symbol)) {
                showMessage('交易对已存在', 'error');
                return;
            }

            try {
                // 添加到交易对列表
                customSymbols.push(symbol);
                allSymbols.push(symbol);

                // 清空输入框
                document.getElementById('customSymbol').value = '';

                // 更新按钮显示
                updateSymbolsListButton();

                showMessage(`正在添加 ${symbol}...`, 'success');

                // 刷新所有交易对数据（包括新添加的）
                await refreshAllSignals();

                showMessage(`${symbol} 添加成功！`, 'success');
            } catch (error) {
                console.error('添加交易对失败:', error);
                // 如果失败，从列表中移除
                const index = customSymbols.indexOf(symbol);
                if (index > -1) {
                    customSymbols.splice(index, 1);
                    allSymbols.splice(allSymbols.indexOf(symbol), 1);
                }
                showMessage('添加失败: ' + error.message, 'error');
            }
        }

        // 测试API连接
        async function testAPI() {
            try {
                const response = await fetch('/api/test');
                const result = await response.json();

                if (result.summary.passed === result.summary.total) {
                    showMessage('API连接正常！所有测试通过', 'success');
                } else {
                    showMessage('API连接异常！部分测试失败', 'error');
                }
            } catch (error) {
                console.error('API测试失败:', error);
                showMessage('API测试失败: ' + error.message, 'error');
            }
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            if (isAutoRefresh) {
                clearInterval(autoRefreshInterval);
                clearInterval(countdownInterval);
                isAutoRefresh = false;
                document.getElementById('autoRefreshBtn').textContent = '⏰ 自动刷新';
                document.getElementById('refreshStatus').textContent = '';
                showMessage('自动刷新已关闭', 'success');
            } else {
                startAutoRefresh();
            }
        }

        // 开始自动刷新
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            autoRefreshInterval = setInterval(refreshAllSignals, currentRefreshInterval);
            isAutoRefresh = true;
            timeUntilNextRefresh = currentRefreshInterval;

            // 启动倒计时
            startCountdown();

            const intervalText = getIntervalText(currentRefreshInterval);
            document.getElementById('autoRefreshBtn').textContent = '⏹️ 停止刷新';
            showMessage(`自动刷新已开启（${intervalText}间隔）`, 'success');
        }

        // 开始倒计时
        function startCountdown() {
            countdownInterval = setInterval(() => {
                timeUntilNextRefresh -= 1000;
                updateCountdownDisplay();

                if (timeUntilNextRefresh <= 0) {
                    timeUntilNextRefresh = currentRefreshInterval;
                }
            }, 1000);
        }

        // 更新倒计时显示
        function updateCountdownDisplay() {
            const minutes = Math.floor(timeUntilNextRefresh / 60000);
            const seconds = Math.floor((timeUntilNextRefresh % 60000) / 1000);

            if (minutes > 0) {
                document.getElementById('refreshStatus').textContent = `下次刷新: ${minutes}分${seconds}秒`;
            } else {
                document.getElementById('refreshStatus').textContent = `下次刷新: ${seconds}秒`;
            }
        }

        // 更新刷新间隔
        function updateRefreshInterval() {
            const select = document.getElementById('refreshInterval');
            currentRefreshInterval = parseInt(select.value);

            if (isAutoRefresh) {
                startAutoRefresh();
            }

            const intervalText = getIntervalText(currentRefreshInterval);
            showMessage(`刷新间隔已设置为：${intervalText}`, 'success');
        }

        // 获取间隔文本
        function getIntervalText(interval) {
            const intervals = {
                300000: '5分钟',
                900000: '15分钟',
                1800000: '30分钟',
                3600000: '1小时',
                14400000: '4小时',
                86400000: '1天'
            };
            return intervals[interval] || '未知';
        }

        // 显示信号
        function displaySignals(signals) {
            const tableBody = document.getElementById('signalsTable');

            if (signals.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="11" class="loading">暂无信号数据</td></tr>';
                return;
            }

            tableBody.innerHTML = signals.map(signal => {
                // 处理数据错误情况
                if (signal.trend === 'DATA_ERROR' || signal.trend === 'ERROR' ||
                    signal.trend === 'RATE_LIMIT' || signal.trend === 'PARSE_ERROR') {

                    let errorClass = 'error';
                    let errorIcon = '❌';

                    if (signal.trend === 'RATE_LIMIT') {
                        errorClass = 'warning';
                        errorIcon = '⏰';
                    } else if (signal.trend === 'PARSE_ERROR') {
                        errorClass = 'error';
                        errorIcon = '🔧';
                    }

                    return `
                        <tr>
                            <td></td>
                            <td><strong>${signal.symbol}</strong></td>
                            <td colspan="9" class="${errorClass}">
                                ${errorIcon} ${signal.dataError || '未知错误'}
                            </td>
                        </tr>
                    `;
                }

                // 格式化执行状态
                const getExecutionDisplay = (execution) => {
                    const executionMap = {
                        'LONG_EXECUTE': '<span class="signal long">执行做多</span>',
                        'LONG_WAIT_PULLBACK': '<span class="signal no-signal">等待回踩</span>',
                        'SHORT_EXECUTE': '<span class="signal short">执行做空</span>',
                        'SHORT_WAIT_PULLBACK': '<span class="signal no-signal">等待回踩</span>',
                        'NO_EXECUTION': '<span class="signal no-signal">无执行</span>'
                    };
                    return executionMap[execution] || execution;
                };

                return `
                    <tr>
                        <td>
                            <button class="expand-btn" onclick="toggleHistory('${signal.symbol}')" title="查看历史记录">
                                📊
                            </button>
                        </td>
                        <td><strong>${signal.symbol}</strong></td>
                        <td><span class="trend ${signal.trend.toLowerCase()}">${signal.trend}</span></td>
                        <td><span class="signal ${signal.signal.toLowerCase().replace('_', '-')}">${signal.signal}</span></td>
                        <td>${getExecutionDisplay(signal.execution)}</td>
                        <td>$${signal.currentPrice ? signal.currentPrice.toFixed(2) : '--'}</td>
                        <td>$${signal.vwap ? signal.vwap.toFixed(2) : '--'}</td>
                        <td>${signal.volumeRatio ? signal.volumeRatio.toFixed(2) + 'x' : '--'}</td>
                        <td>${signal.oiChange ? signal.oiChange.toFixed(2) + '%' : '--'}</td>
                        <td>${signal.fundingRate ? (signal.fundingRate * 100).toFixed(4) + '%' : '--'}</td>
                        <td>${signal.cvd || '--'}</td>
                    </tr>
                    <tr id="history-${signal.symbol}" class="history-row" style="display: none;">
                        <td colspan="11">
                            <div class="history-container">
                                <div class="history-header">
                                    <h4>📈 ${signal.symbol} 历史记录</h4>
                                    <button onclick="loadHistory('${signal.symbol}')" class="load-history-btn">加载历史</button>
                                </div>
                                <div class="history-content" id="history-content-${signal.symbol}">
                                    <div class="loading">点击"加载历史"查看详细记录</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 更新统计
        function updateStats(signals) {
            const totalSignals = signals.length;
            const longSignals = signals.filter(s => s.signal === 'LONG').length;
            const shortSignals = signals.filter(s => s.signal === 'SHORT').length;

            document.getElementById('totalSignals').textContent = totalSignals;
            document.getElementById('longSignals').textContent = longSignals;
            document.getElementById('shortSignals').textContent = shortSignals;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // 显示消息
        function showMessage(message, type) {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;

            document.querySelector('.container').insertBefore(messageDiv, document.querySelector('.stats'));

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // 数据监控功能
        async function loadDataMonitor() {
            try {
                const response = await fetch('/api/data-monitor');
                const data = await response.json();

                if (data.error) {
                    showMessage(`数据监控加载失败: ${data.error}`, 'error');
                    return;
                }

                displayDataMonitor(data);
            } catch (error) {
                showMessage(`数据监控加载失败: ${error.message}`, 'error');
            }
        }

        function displayDataMonitor(data) {
            // 创建监控面板
            const monitorPanel = document.createElement('div');
            monitorPanel.className = 'monitor-panel';
            monitorPanel.innerHTML = `
                <div class="monitor-header">
                    <h3>📊 数据准确性监控</h3>
                    <button onclick="this.parentElement.parentElement.remove()" class="close-btn">×</button>
                </div>
                <div class="monitor-content">
                    <div class="overall-stats">
                        <h4>总体状态</h4>
                        <div class="stat-item ${data.overall.isHealthy ? 'healthy' : 'unhealthy'}">
                            <span>成功率: ${data.overall.successRate}%</span>
                            <span>分析次数: ${data.overall.totalAnalyses}</span>
                            <span>成功次数: ${data.overall.successfulAnalyses}</span>
                        </div>
                    </div>
                    <div class="raw-data-stats">
                        <h4>原始数据成功率</h4>
                        ${Object.entries(data.rawDataStats).map(([type, stats]) => `
                            <div class="data-type ${stats.successRate < 100 ? 'warning' : 'normal'}">
                                <span class="data-type-name">${type}</span>
                                <span class="success-rate">${stats.successRate}%</span>
                                <span class="data-count">(${stats.success}/${stats.total})</span>
                                ${stats.failures.length > 0 ? `
                                    <div class="failures">
                                        <strong>失败记录:</strong>
                                        ${stats.failures.map(f => `
                                            <div class="failure-item">
                                                ${f.symbol}: ${f.error} (${f.timestamp})
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div class="recent-logs">
                        <h4>最近分析记录</h4>
                        ${data.recentLogs.map(log => `
                            <div class="log-item ${log.success ? 'success' : 'error'}">
                                <span class="symbol">${log.symbol}</span>
                                <span class="duration">${log.totalTime}ms</span>
                                <span class="status">${log.success ? '成功' : '失败'}</span>
                                ${!log.success ? `<div class="errors">${log.errors.join(', ')}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // 添加样式
            if (!document.querySelector('#monitor-styles')) {
                const style = document.createElement('style');
                style.id = 'monitor-styles';
                style.textContent = `
                    .monitor-panel {
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 15px;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        z-index: 1000;
                        max-width: 800px;
                        max-height: 80vh;
                        overflow-y: auto;
                        border: 2px solid #667eea;
                    }
                    .monitor-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px;
                        border-bottom: 1px solid #eee;
                        background: #f8f9fa;
                        border-radius: 15px 15px 0 0;
                    }
                    .monitor-header h3 {
                        margin: 0;
                        color: #333;
                    }
                    .close-btn {
                        background: #ff4757;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 30px;
                        height: 30px;
                        cursor: pointer;
                        font-size: 18px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .monitor-content {
                        padding: 20px;
                    }
                    .overall-stats, .raw-data-stats, .recent-logs {
                        margin-bottom: 20px;
                    }
                    .overall-stats h4, .raw-data-stats h4, .recent-logs h4 {
                        margin-bottom: 10px;
                        color: #333;
                        border-bottom: 2px solid #667eea;
                        padding-bottom: 5px;
                    }
                    .stat-item {
                        display: flex;
                        gap: 15px;
                        padding: 10px;
                        border-radius: 8px;
                        margin-bottom: 10px;
                    }
                    .stat-item.healthy {
                        background: #d4edda;
                        color: #155724;
                    }
                    .stat-item.unhealthy {
                        background: #f8d7da;
                        color: #721c24;
                        border: 2px solid #f5c6cb;
                    }
                    .data-type {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 8px;
                        border-radius: 5px;
                        margin-bottom: 5px;
                    }
                    .data-type.normal {
                        background: #e8f5e8;
                    }
                    .data-type.warning {
                        background: #fff3cd;
                        border: 1px solid #ffeaa7;
                    }
                    .data-type-name {
                        font-weight: bold;
                        min-width: 120px;
                    }
                    .success-rate {
                        font-weight: bold;
                        min-width: 60px;
                    }
                    .data-count {
                        color: #666;
                        font-size: 0.9em;
                    }
                    .failures {
                        margin-top: 5px;
                        font-size: 0.9em;
                    }
                    .failure-item {
                        background: #f8d7da;
                        padding: 5px;
                        margin: 2px 0;
                        border-radius: 3px;
                        font-size: 0.8em;
                    }
                    .log-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 8px;
                        border-radius: 5px;
                        margin-bottom: 5px;
                        font-size: 0.9em;
                    }
                    .log-item.success {
                        background: #e8f5e8;
                    }
                    .log-item.error {
                        background: #f8d7da;
                    }
                    .symbol {
                        font-weight: bold;
                        min-width: 80px;
                    }
                    .duration {
                        min-width: 60px;
                        color: #666;
                    }
                    .status {
                        min-width: 40px;
                    }
                    .errors {
                        color: #721c24;
                        font-size: 0.8em;
                    }
                `;
                document.head.appendChild(style);
            }

            // 移除现有的监控面板
            const existingPanel = document.querySelector('.monitor-panel');
            if (existingPanel) {
                existingPanel.remove();
            }

            document.body.appendChild(monitorPanel);
        }

        // 切换历史记录显示
        function toggleHistory(symbol) {
            const historyRow = document.getElementById(`history-${symbol}`);
            if (historyRow.style.display === 'none') {
                historyRow.style.display = 'table-row';
                loadHistory(symbol);
            } else {
                historyRow.style.display = 'none';
            }
        }

        // 加载历史记录
        async function loadHistory(symbol) {
            const contentDiv = document.getElementById(`history-content-${symbol}`);
            contentDiv.innerHTML = '<div class="loading">加载中...</div>';

            try {
                const response = await fetch(`/api/history/${symbol}?limit=20`);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    displayHistoryRecords(data.data, contentDiv);
                } else {
                    contentDiv.innerHTML = '<div class="no-data">暂无历史记录</div>';
                }
            } catch (error) {
                contentDiv.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        // 显示历史记录
        function displayHistoryRecords(records, container) {
            const historyHtml = records.map(record => {
                const signalTime = record.signal_time ? new Date(record.signal_time).toLocaleString() : 'N/A';
                const executionTime = record.execution_time ? new Date(record.execution_time).toLocaleString() : 'N/A';
                const markerResult = record.marker_result || '未标记';

                return `
                    <div class="history-record">
                        <div class="record-header">
                            <span class="record-time">${signalTime}</span>
                            <span class="record-status ${markerResult === '正确' ? 'correct' : markerResult === '错误' ? 'incorrect' : 'unmarked'}">${markerResult}</span>
                        </div>
                        <div class="record-details">
                            <div class="detail-row">
                                <span class="label">趋势:</span> <span class="value">${record.trend}</span>
                                <span class="label">信号:</span> <span class="value">${record.signal}</span>
                                <span class="label">执行:</span> <span class="value">${record.execution || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">价格:</span> <span class="value">$${record.current_price}</span>
                                <span class="label">VWAP:</span> <span class="value">$${record.vwap || 'N/A'}</span>
                                <span class="label">成交量倍数:</span> <span class="value">${record.volume_ratio ? record.volume_ratio.toFixed(2) + 'x' : 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">OI变化:</span> <span class="value">${record.oi_change ? record.oi_change.toFixed(2) + '%' : 'N/A'}</span>
                                <span class="label">资金费率:</span> <span class="value">${record.funding_rate ? (record.funding_rate * 100).toFixed(4) + '%' : 'N/A'}</span>
                                <span class="label">CVD:</span> <span class="value">${record.cvd_direction || 'N/A'}</span>
                            </div>
                            ${record.stop_price ? `
                            <div class="detail-row">
                                <span class="label">止损价:</span> <span class="value">$${record.stop_price}</span>
                                <span class="label">目标价:</span> <span class="value">$${record.target_price || 'N/A'}</span>
                                <span class="label">最大杠杆:</span> <span class="value">${record.max_leverage || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">最低保证金:</span> <span class="value">$${calculateMinMargin(record)}</span>
                                <span class="label">盈亏比:</span> <span class="value">${record.risk_reward_ratio || 'N/A'}</span>
                                <span class="label">执行时间:</span> <span class="value">${executionTime}</span>
                            </div>
                            ` : ''}
                            ${record.marker_notes ? `<div class="record-notes">备注: ${record.marker_notes}</div>` : ''}
                            <div class="record-actions">
                                <button onclick="markResult(${record.id}, 'signal', '${record.symbol}', '正确')" class="mark-btn correct">✓ 正确</button>
                                <button onclick="markResult(${record.id}, 'signal', '${record.symbol}', '错误')" class="mark-btn incorrect">✗ 错误</button>
                                <button onclick="markResult(${record.id}, 'signal', '${record.symbol}', '未标记')" class="mark-btn unmarked">○ 未标记</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = historyHtml;
        }

        // 标记结果
        async function markResult(recordId, recordType, symbol, result) {
            try {
                const response = await fetch('/api/mark-result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recordId,
                        recordType,
                        symbol,
                        result
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('标记成功！', 'success');
                    // 重新加载历史记录
                    loadHistory(symbol);
                } else {
                    showMessage('标记失败: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('标记失败: ' + error.message, 'error');
            }
        }

        // 移动端手势支持
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', (e) => {
            if (!touchStartX || !touchStartY) return;

            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;

            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;

            // 检测下拉刷新手势
            if (Math.abs(diffY) > Math.abs(diffX) && diffY < -50) {
                refreshAllSignals();
            }

            touchStartX = 0;
            touchStartY = 0;
        });

        // 防止双击缩放
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Telegram配置相关函数
        async function viewTelegramConfig() {
            try {
                const response = await fetch('/api/telegram-status');
                const status = await response.json();

                const configHtml = `
                    <div class="telegram-config">
                        <h3>📱 Telegram 通知配置</h3>
                        <div class="config-status">
                            <p><strong>配置状态：</strong> 
                                <span class="${status.configured ? 'status-success' : 'status-error'}">
                                    ${status.configured ? '✅ 已配置' : '❌ 未配置'}
                                </span>
                            </p>
                            <p><strong>Bot Token：</strong> 
                                <span class="${status.hasToken ? 'status-success' : 'status-error'}">
                                    ${status.hasToken ? '✅ 已设置' : '❌ 未设置'}
                                </span>
                                ${status.debug ? ` (长度: ${status.debug.botTokenLength})` : ''}
                            </p>
                            <p><strong>Chat ID：</strong> 
                                <span class="${status.hasChatId ? 'status-success' : 'status-error'}">
                                    ${status.hasChatId ? '✅ 已设置' : '❌ 未设置'}
                                </span>
                                ${status.debug ? ` (值: ${status.debug.chatIdValue})` : ''}
                            </p>
                        </div>
                        ${status.debug ? `
                        <div class="debug-info">
                            <h4>🔍 调试信息：</h4>
                            <p><strong>环境变量 Bot Token：</strong> ${status.debug.envBotToken}</p>
                            <p><strong>环境变量 Chat ID：</strong> ${status.debug.envChatId}</p>
                            <p><strong>Node 环境：</strong> ${status.debug.nodeEnv}</p>
                        </div>
                        ` : ''}
                        <div class="config-instructions">
                            <h4>📋 配置步骤：</h4>
                            <ol>
                                <li>在Telegram中搜索 <code>@BotFather</code> 并创建新机器人</li>
                                <li>获取Bot Token（格式：123456789:ABCdefGHIjklMNOpqrsTUVwxyz）</li>
                                <li>将Bot Token设置为环境变量 <code>TELEGRAM_BOT_TOKEN</code></li>
                                <li>获取您的Chat ID（可以给机器人发送消息，然后访问 <code>https://api.telegram.org/bot&lt;YOUR_BOT_TOKEN&gt;/getUpdates</code>）</li>
                                <li>将Chat ID设置为环境变量 <code>TELEGRAM_CHAT_ID</code></li>
                                <li>重启服务器使环境变量生效</li>
                                <li>访问 <a href="https://smart.aimaventop.com" target="_blank">https://smart.aimaventop.com</a> 测试配置</li>
                            </ol>
                        </div>
                        <div class="config-actions">
                            <button class="btn primary" onclick="testTelegramNotification()" ${!status.configured ? 'disabled' : ''}>
                                🧪 测试通知
                            </button>
                            <button class="btn secondary" onclick="closeTelegramConfig()">
                                ❌ 关闭
                            </button>
                        </div>
                    </div>
                `;

                showModal('Telegram配置', configHtml);
            } catch (error) {
                showMessage('获取Telegram配置失败: ' + error.message, 'error');
            }
        }

        async function testTelegramNotification() {
            try {
                const response = await fetch('/api/test-telegram', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('测试消息已发送，请检查Telegram', 'success');
                } else {
                    showMessage('测试失败: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('测试Telegram通知失败: ' + error.message, 'error');
            }
        }

        function closeTelegramConfig() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }

        function showModal(title, content) {
            // 移除现有模态框
            const existingModal = document.querySelector('.modal');
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>${title}</h2>
                        <button class="modal-close" onclick="closeTelegramConfig()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // 显示交易对列表
        function showSymbolsList() {
            const defaultSymbols = ['BTCUSDT', 'ETHUSDT', 'LINKUSDT', 'LDOUSDT', 'SOLUSDT'];
            const customSymbolsList = customSymbols;

            const listHtml = `
                <div class="symbols-list">
                    <h3>📋 交易对管理</h3>
                    <div class="symbols-content">
                        <div class="default-symbols">
                            <h4>默认交易对 (${defaultSymbols.length})</h4>
                            <div class="symbols-grid">
                                ${defaultSymbols.map(symbol =>
                `<span class="symbol-tag default-tag">
                    ${symbol}
                    <span class="symbol-status">🔒 系统默认</span>
                </span>`
            ).join('')}
                            </div>
                        </div>
                        <div class="custom-symbols">
                            <h4>自定义交易对 (${customSymbolsList.length})</h4>
                            <div class="symbols-grid">
                                ${customSymbolsList.length > 0 ?
                    customSymbolsList.map(symbol =>
                        `<span class="symbol-tag custom-tag">
                            ${symbol}
                            <button class="remove-symbol" onclick="removeCustomSymbol('${symbol}')" title="删除交易对">🗑️</button>
                        </span>`
                    ).join('') :
                    '<span class="no-symbols">暂无自定义交易对</span>'
                }
                            </div>
                        </div>
                    </div>
                    <div class="symbols-actions">
                        <button class="btn secondary" onclick="closeSymbolsList()">关闭</button>
                    </div>
                </div>
            `;

            showModal('交易对管理', listHtml);
        }

        // 移除自定义交易对
        async function removeCustomSymbol(symbol) {
            if (confirm(`确定要移除交易对 ${symbol} 吗？`)) {
                try {
                    // 调用后端API删除交易对
                    const response = await fetch(`/api/symbol/${symbol}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        // 从前端列表中移除
                        const index = customSymbols.indexOf(symbol);
                        if (index > -1) {
                            customSymbols.splice(index, 1);
                            allSymbols.splice(allSymbols.indexOf(symbol), 1);
                        }

                        // 更新按钮显示
                        updateSymbolsListButton();

                        // 刷新数据
                        refreshAllSignals();

                        showMessage(`${symbol} 已成功移除`, 'success');

                        // 关闭模态框
                        closeSymbolsList();
                    } else {
                        showMessage(`移除失败: ${result.message}`, 'error');
                    }
                } catch (error) {
                    console.error('删除交易对失败:', error);
                    showMessage(`删除失败: ${error.message}`, 'error');
                }
            }
        }

        // 更新交易对列表按钮
        function updateSymbolsListButton() {
            const button = document.querySelector('.symbols-list-btn');
            if (button) {
                button.textContent = `📋 交易对管理 (${allSymbols.length})`;
            }
        }

        // 关闭交易对列表
        function closeSymbolsList() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }

        // 打开斐波拉契滚仓计算器
        function openRollupCalculator() {
            // 获取当前的最大损失金额
            const currentMaxLoss = document.getElementById('maxLossAmount').value;

            // 创建新窗口
            const calculatorWindow = window.open(
                'rollup-calculator.html',
                'rollupCalculator',
                'width=1200,height=800,scrollbars=yes,resizable=yes,status=yes,toolbar=no,menubar=no,location=no'
            );

            // 等待窗口加载完成后设置默认值
            if (calculatorWindow) {
                calculatorWindow.addEventListener('load', function () {
                    try {
                        const maxLossInput = calculatorWindow.document.getElementById('maxLossAmount');
                        if (maxLossInput) {
                            maxLossInput.value = currentMaxLoss;
                        }
                    } catch (error) {
                        console.log('无法设置默认值:', error);
                    }
                });
            }
        }

        // 加载胜率统计
        async function loadWinRateStats() {
            try {
                const response = await fetch('/api/win-rate-stats');
                const stats = await response.json();

                document.getElementById('winRate').textContent = stats.win_rate.toFixed(1) + '%';
                document.getElementById('winRateDetails').textContent = `${stats.total_wins}/${stats.total_trades}`;
            } catch (error) {
                console.error('加载胜率统计失败:', error);
            }
        }

        // 切换模拟交易历史显示
        async function toggleSimulationHistory() {
            const container = document.getElementById('simulationHistoryContainer');
            const isVisible = container.style.display !== 'none';

            if (isVisible) {
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
                await loadSimulationHistory();
            }
        }

        // 加载模拟交易历史
        async function loadSimulationHistory() {
            const tableBody = document.getElementById('simulationHistoryTable');
            tableBody.innerHTML = '<tr><td colspan="12" class="loading">加载中...</td></tr>';

            try {
                const response = await fetch('/api/simulation-history?limit=50');
                const history = await response.json();

                if (history.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="12" class="no-data">暂无模拟交易记录</td></tr>';
                    return;
                }

                tableBody.innerHTML = history.map(sim => `
                    <tr>
                        <td>${sim.symbol || '--'}</td>
                        <td>${sim.entry_price ? sim.entry_price.toFixed(4) : '--'}</td>
                        <td>${sim.stop_loss_price ? sim.stop_loss_price.toFixed(4) : '--'}</td>
                        <td>${sim.take_profit_price ? sim.take_profit_price.toFixed(4) : '--'}</td>
                        <td>${sim.max_leverage ? sim.max_leverage + 'x' : '--'}</td>
                        <td>${sim.min_margin ? sim.min_margin.toFixed(2) + ' USDT' : '--'}</td>
                        <td>${sim.entry_time ? new Date(sim.entry_time).toLocaleString() : '--'}</td>
                        <td>${sim.exit_time ? new Date(sim.exit_time).toLocaleString() : '进行中'}</td>
                        <td>${sim.exit_price ? sim.exit_price.toFixed(4) : '--'}</td>
                        <td>${sim.exit_reason || '--'}</td>
                        <td class="${sim.profit_loss !== null && sim.profit_loss >= 0 ? 'profit' : 'loss'}">
                            ${sim.profit_loss !== null ? sim.profit_loss.toFixed(2) + '%' : '--'}
                        </td>
                        <td>
                            ${sim.is_win === null ? '进行中' : (sim.is_win ? '✅ 胜' : '❌ 败')}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('加载模拟交易历史失败:', error);
                tableBody.innerHTML = '<tr><td colspan="12" class="error">加载失败: ' + error.message + '</td></tr>';
            }
        }

        // 同步交易对列表
        async function syncSymbolsList() {
            try {
                const response = await fetch('/api/symbols');
                const result = await response.json();

                if (result.success) {
                    // 更新全局变量
                    allSymbols = result.data.allSymbols;
                    customSymbols = result.data.customSymbols;

                    // 更新按钮显示
                    updateSymbolsListButton();

                    console.log('交易对列表已同步:', allSymbols);
                }
            } catch (error) {
                console.error('同步交易对列表失败:', error);
            }
        }

        // 页面加载时自动刷新一次
        document.addEventListener('DOMContentLoaded', () => {
            syncSymbolsList();
            refreshAllSignals();
            loadWinRateStats();
        });
    </script>
</body>

</html>