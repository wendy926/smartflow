<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•æ¨¡æ‹Ÿäº¤æ˜“æ•°æ®</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .error { color: red; }
        .success { color: green; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>è°ƒè¯•æ¨¡æ‹Ÿäº¤æ˜“æ•°æ®</h1>
    
    <div class="debug-section">
        <h2>1. APIè°ƒç”¨æµ‹è¯•</h2>
        <div id="apiTest">æµ‹è¯•ä¸­...</div>
    </div>
    
    <div class="debug-section">
        <h2>2. æ•°æ®ç­›é€‰æµ‹è¯•</h2>
        <div id="filterTest">æµ‹è¯•ä¸­...</div>
    </div>
    
    <div class="debug-section">
        <h2>3. è¡¨æ ¼æ¸²æŸ“æµ‹è¯•</h2>
        <div id="tableTest">æµ‹è¯•ä¸­...</div>
    </div>

    <script src="js/api.js"></script>
    <script>
        class DebugSimulationData {
            constructor() {
                this.apiClient = new APIClient();
                this.allSimulations = [];
                this.filteredSimulations = [];
                this.init();
            }

            async init() {
                await this.testAPI();
                await this.testFiltering();
                await this.testTableRendering();
            }

            async testAPI() {
                const apiTestDiv = document.getElementById('apiTest');
                try {
                    console.log('ğŸ” å¼€å§‹APIæµ‹è¯•...');
                    
                    // æµ‹è¯•æ¨¡æ‹Ÿäº¤æ˜“å†å²API
                    const result = await this.apiClient.getSimulationHistory();
                    console.log('APIè¿”å›ç»“æœ:', result);
                    
                    this.allSimulations = Array.isArray(result) ? result : (result.simulations || []);
                    
                    apiTestDiv.innerHTML = `
                        <div class="success">âœ… APIè°ƒç”¨æˆåŠŸ</div>
                        <div>è¿”å›è®°å½•æ•°: ${this.allSimulations.length}</div>
                        <div>æ•°æ®ç±»å‹: ${Array.isArray(result) ? 'Array' : typeof result}</div>
                        <pre>${JSON.stringify(result.slice(0, 2), null, 2)}</pre>
                    `;
                } catch (error) {
                    console.error('APIæµ‹è¯•å¤±è´¥:', error);
                    apiTestDiv.innerHTML = `<div class="error">âŒ APIè°ƒç”¨å¤±è´¥: ${error.message}</div>`;
                }
            }

            async testFiltering() {
                const filterTestDiv = document.getElementById('filterTest');
                try {
                    console.log('ğŸ” å¼€å§‹ç­›é€‰æµ‹è¯•...');
                    
                    // æ¨¡æ‹Ÿç­›é€‰é€»è¾‘
                    this.filteredSimulations = [...this.allSimulations];
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰éšè—çš„è¿‡æ»¤æ¡ä»¶
                    const activeTrades = this.allSimulations.filter(sim => sim.status === 'ACTIVE');
                    const closedTrades = this.allSimulations.filter(sim => sim.status === 'CLOSED');
                    const signalNoneTrades = this.allSimulations.filter(sim => sim.trigger_reason === 'SIGNAL_NONE');
                    
                    filterTestDiv.innerHTML = `
                        <div class="success">âœ… ç­›é€‰æµ‹è¯•å®Œæˆ</div>
                        <div>æ€»è®°å½•æ•°: ${this.allSimulations.length}</div>
                        <div>ç­›é€‰åè®°å½•æ•°: ${this.filteredSimulations.length}</div>
                        <div>æ´»è·ƒäº¤æ˜“: ${activeTrades.length}</div>
                        <div>å·²å®Œæˆäº¤æ˜“: ${closedTrades.length}</div>
                        <div>SIGNAL_NONEäº¤æ˜“: ${signalNoneTrades.length}</div>
                        <div>ç­›é€‰å‰åè®°å½•æ•°æ˜¯å¦ä¸€è‡´: ${this.allSimulations.length === this.filteredSimulations.length ? 'æ˜¯' : 'å¦'}</div>
                    `;
                } catch (error) {
                    console.error('ç­›é€‰æµ‹è¯•å¤±è´¥:', error);
                    filterTestDiv.innerHTML = `<div class="error">âŒ ç­›é€‰æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                }
            }

            async testTableRendering() {
                const tableTestDiv = document.getElementById('tableTest');
                try {
                    console.log('ğŸ” å¼€å§‹è¡¨æ ¼æ¸²æŸ“æµ‹è¯•...');
                    
                    // æ¨¡æ‹Ÿè¡¨æ ¼æ¸²æŸ“é€»è¾‘
                    const simulations = this.filteredSimulations.slice(0, 5); // åªæ˜¾ç¤ºå‰5æ¡
                    
                    if (!simulations || simulations.length === 0) {
                        tableTestDiv.innerHTML = `
                            <div class="error">âŒ æ²¡æœ‰æ•°æ®å¯æ˜¾ç¤º</div>
                            <div>allSimulations.length: ${this.allSimulations.length}</div>
                            <div>filteredSimulations.length: ${this.filteredSimulations.length}</div>
                        `;
                        return;
                    }

                    const tableHTML = simulations.map(sim => `
                        <tr>
                            <td>${sim.symbol}</td>
                            <td>${sim.direction}</td>
                            <td>${sim.trigger_reason}</td>
                            <td>${sim.exit_reason || 'N/A'}</td>
                            <td>${sim.status}</td>
                        </tr>
                    `).join('');

                    tableTestDiv.innerHTML = `
                        <div class="success">âœ… è¡¨æ ¼æ¸²æŸ“æµ‹è¯•å®Œæˆ</div>
                        <div>æ¸²æŸ“è®°å½•æ•°: ${simulations.length}</div>
                        <table border="1" style="width: 100%; margin-top: 10px;">
                            <thead>
                                <tr>
                                    <th>äº¤æ˜“å¯¹</th>
                                    <th>æ–¹å‘</th>
                                    <th>è§¦å‘åŸå› </th>
                                    <th>å‡ºåœºåŸå› </th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableHTML}
                            </tbody>
                        </table>
                    `;
                } catch (error) {
                    console.error('è¡¨æ ¼æ¸²æŸ“æµ‹è¯•å¤±è´¥:', error);
                    tableTestDiv.innerHTML = `<div class="error">âŒ è¡¨æ ¼æ¸²æŸ“æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new DebugSimulationData();
        });
    </script>
</body>
</html>
