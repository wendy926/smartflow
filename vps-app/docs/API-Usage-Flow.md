# SmartFlow API 使用流程图

## 数据获取流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    SmartFlow 交易策略系统                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据获取层                                │
├─────────────────────────────────────────────────────────────────┤
│  REST API                    │  WebSocket API                  │
│  ┌─────────────────────┐     │  ┌─────────────────────────┐    │
│  │ BinanceAPI.js      │     │  │ DeltaManager.js        │    │
│  │ - getKlines()      │     │  │ - aggTrade WebSocket   │    │
│  │ - get24hrTicker()  │     │  │ - 实时Delta计算        │    │
│  │ - getFundingRate() │     │  │ - 买卖盘不平衡         │    │
│  │ - getOpenInterest()│     │  │                        │    │
│  └─────────────────────┘     │  └─────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        技术指标计算层                            │
├─────────────────────────────────────────────────────────────────┤
│  TechnicalIndicators.js                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 基于REST API数据计算:                                   │   │
│  │ • MA20/MA50/MA200 (4H K线)                            │   │
│  │ • EMA20/EMA50 (15m K线)                               │   │
│  │ • VWAP (1H/15m K线)                                   │   │
│  │ • ATR14 (15m K线)                                     │   │
│  │ • 布林带 (1H K线)                                     │   │
│  │ • 布林带宽度 (15m K线)                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 基于WebSocket数据计算:                                  │   │
│  │ • Delta不平衡 (实时)                                   │   │
│  │ • 买卖盘比例 (实时)                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        策略分析层                                │
├─────────────────────────────────────────────────────────────────┤
│  StrategyV3Core.js                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 4H趋势判断:                                            │   │
│  │ • 使用4H K线数据                                       │   │
│  │ • 计算MA20/MA50/MA200                                  │   │
│  │ • 更新频率: 1小时                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 1H多因子打分:                                          │   │
│  │ • 使用1H K线数据                                       │   │
│  │ • 使用资金费率数据                                     │   │
│  │ • 使用持仓量历史数据                                   │   │
│  │ • 使用Delta数据                                        │   │
│  │ • 更新频率: 5分钟                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 震荡市1H边界判断:                                      │   │
│  │ • 使用1H K线数据                                       │   │
│  │ • 使用Delta数据                                        │   │
│  │ • 使用持仓量历史数据                                   │   │
│  │ • 更新频率: 5分钟                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        执行分析层                                │
├─────────────────────────────────────────────────────────────────┤
│  StrategyV3Execution.js                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 15分钟入场判断:                                        │   │
│  │ • 使用15m K线数据                                      │   │
│  │ • 使用Delta数据                                        │   │
│  │ • 使用持仓量数据                                       │   │
│  │ • 更新频率: 2分钟                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 数据刷新频率

```
时间轴: 0 ──────────────── 1小时 ──────────────── 2小时
        │
        ├─ 4H趋势判断 (每1小时)
        │  └─ 获取4H K线数据
        │
        ├─ 1H多因子打分 (每5分钟)
        │  ├─ 获取1H K线数据
        │  ├─ 获取资金费率数据
        │  ├─ 获取持仓量历史数据
        │  └─ 使用Delta数据 (实时)
        │
        ├─ 震荡市1H边界判断 (每5分钟)
        │  ├─ 获取1H K线数据
        │  ├─ 使用Delta数据 (实时)
        │  └─ 获取持仓量历史数据
        │
        ├─ 15分钟入场判断 (每2分钟)
        │  ├─ 获取15m K线数据
        │  ├─ 使用Delta数据 (实时)
        │  └─ 获取持仓量数据
        │
        └─ Delta数据 (实时，约6秒)
           └─ WebSocket aggTrade数据流
```

## API调用统计

### REST API调用
- **K线数据**: 4H(1次/小时) + 1H(12次/小时) + 15m(30次/小时) = 43次/小时
- **价格数据**: 12次/小时
- **资金费率**: 12次/小时  
- **持仓量数据**: 12次/小时
- **总计**: 约79次/小时

### WebSocket连接
- **Delta数据**: 持续连接，实时更新
- **连接数**: 每个交易对1个连接
- **数据更新**: 约600次/小时/交易对

## 缓存策略

```
┌─────────────────────────────────────────────────────────────────┐
│                        缓存层                                   │
├─────────────────────────────────────────────────────────────────┤
│  CacheManager.js                                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 内存缓存:                                              │   │
│  │ • K线数据: 5分钟TTL                                    │   │
│  │ • 价格数据: 30秒TTL                                    │   │
│  │ • 资金费率: 1小时TTL                                   │   │
│  │ • 持仓量数据: 5分钟TTL                                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Redis缓存:                                             │   │
│  │ • 监控数据: 10秒TTL                                    │   │
│  │ • 分析结果: 1分钟TTL                                   │   │
│  │ • 系统指标: 30秒TTL                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 错误处理和降级

```
┌─────────────────────────────────────────────────────────────────┐
│                        错误处理层                                │
├─────────────────────────────────────────────────────────────────┤
│  RateLimiter.js                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • API限流管理                                          │   │
│  │ • 自动重试机制                                         │   │
│  │ • 优先级队列                                           │   │
│  │ • 降级策略                                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│  RealTimeDataMonitor.js                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • 成功率监控                                           │   │
│  │ • 错误分类统计                                         │   │
│  │ • 性能指标收集                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

这个架构确保了SmartFlow交易策略系统能够高效、稳定地获取和处理市场数据，为交易决策提供可靠的数据基础。
